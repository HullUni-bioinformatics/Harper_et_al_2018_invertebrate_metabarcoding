#' ---
#' Title: "Invertebrate metabarcoding analysis"
#' Author: "Lynsey Rebecca Harper"
#' Date: "17th August 2018"
#' ---
#' 
#' 
#' Samples from 20 ponds in North Norfolk, East of England, and 3 ponds in
#' Selby, East Riding of Yorkshire, were screened for freshwater invertebrates.
#' 
#' Pond-netting and eDNA metabarcoding were performed in 14 ponds with 
#' crucian carp (*Carassius carassius*) and 10 ponds without crucian carp. DNA 
#' metabarcoding was performed on netted samples from 18 of 24 ponds. 
#' Concordance between methods and effect of crucian carp on alpha and beta 
#' diversity will be examined.
#' 
#' 
#' ## Prepare working environment
#' 
#' Clear R memory, set working directory and load required packages. Then,
#' load functions for calculating kappa coefficient, plotting model 
#' residuals and testing model fit.
#' 

## Clear memory
rm(list=ls())

## Direct R to folder containing packages on University workstation
.libPaths(c("C:\\R\\rlib", .libPaths("rlib")))

## set working directory to the location of the script
# install.packages("rstudioapi") # first time for each computer
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))

## Check working directory
getwd()

## Load required packages
p <- c("ggplot2","ggpubr","munsell","lazyeval","grid","gridExtra","lme4",
       "glmmADMB","coda","MASS","car","scales","AICcmodavg","xtable","gtools",
       "xlsx","reshape2","dplyr","plyr","arm","RVAideMemoire","permute",
       "ResourceSelection","bbmle","RColorBrewer", "MuMIn","ape","faraway",
       "ggmap","mapproj","geosphere","jpeg","proto","rjson","RgoogleMaps",
       "maps","labeling","ggsn","png","coin","modeltools","mvtnorm","pROC",
       "vegan","multcomp","betapart","adespatial","adegraphics","ade4")
new.packages <- p[!(p %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages, repos = "https://cran.ma.imperial.ac.uk/",
                                          dependencies=TRUE)
lapply(p, require, character.only = TRUE)

## Load custom functions
f <- c("CheckResidsFunction.R", "OverdispersalFunction.R", 
       "CheckConvergenceFunction.R")

lapply(f, source)

#'
#' To ensure reproducibility, print details about the version of R being
#' used for analysis.
#' 

sessionInfo()



#' ---
#' 
#' ## 1) Pond-netting 
#' 
#' Examine the communities generated by pond-netting and see if they give
#' the same result for impact of crucian carp on macroinvertebrate diversity.
#' 

## Import species matrix
net.df <- read.csv("../Data/Netting_site_by_species.csv", 
                   row.names=1, header=TRUE)
summary(net.df)
head(net.df)
names(net.df)
str(net.df)

## Remove '_' from species names
colnames(net.df) <- gsub("_", " ", colnames(net.df))

## Import environmental data
metadata <- read.csv("../Data/Site_metadata.csv", header=TRUE)
summary(metadata)
head(metadata)
names(metadata)
str(metadata)

## Check environmental data for collinearity
pairs(metadata[,4:10],
      lower.panel = panel.cor, 
      upper.panel = panel.smooth2)

## Before progressing with further analysis, we now have to alter the dataframe 
## to contain only species level assignments
net.df <- net.df[,which(grepl(" ", colnames(net.df)))]


#'
#' ### Species level analysis
#'
#' Basic summaries
#' 

## Total number of individuals per pond
sum.of.rows <- apply(net.df, 1, sum)
sort(sum.of.rows, decreasing = TRUE) 
sum(sum.of.rows)


## Total number of individuals per species across all sites
sum.of.columns <- apply(net.df, 2, sum)

## Actual number of individuals:
sort(sum.of.columns, decreasing = TRUE)
sum(sum.of.columns)

## Proportional number of individuals:
sort(round(sum.of.columns/sum(sum.of.columns)*100, 2), decreasing = TRUE)


## Number of ponds where each species occurs
net.spec.pres <- apply(net.df > 0, 2, sum) 
sort(net.spec.pres, decreasing = TRUE)


#'
#' ## Data transformation
#' 
#' From now on, all data exploration and analyses will take place in the 
#' vegan package.
#' 

## Tranform data
net.spec.pa <- decostand(net.df, method = "pa", MARGIN = 1) # by rows (ponds)
head(net.spec.pa[,1:3], n = 3)


#'
#' ## Alpha diversity
#' 

## Basic richness - two ways to calculate:
net.sample.richness <- specnumber(net.spec.pa)
net.sample.richness

## Or:
#net.sample.richness <- apply(net.spec.pa > 0, 1, sum)
#net.sample.richness

## Plot alpha diversity
## Create data frame
net.alpha <- data.frame(net.sample.richness)

## add metadata from external file
net.alpha <- cbind(metadata[,1:2], net.alpha)

## Reset row names of data frame for further indexing
rownames(net.alpha) <- NULL

## Plot species richness
p1a <- ggplot(net.alpha, aes(x=Crucian, y=net.sample.richness))
p1a <- p1a + geom_jitter(aes(colour=Crucian), width=0.2, cex=2, show.legend=FALSE)
p1a <- p1a + geom_boxplot(alpha=0.7, outlier.shape = NA)
p1a <- p1a + scale_y_continuous(limits=c(0,100))
p1a <- p1a + labs(title="(a) Species-level", 
                  subtitle="(i) Netting and microscopy",
                  x="", y=expression(alpha~diversity))
p1a <- p1a + scale_colour_manual(values=c("grey40","deepskyblue2"))
p1a <- p1a + scale_x_discrete(breaks=c("N","Y"),
                              labels=c("Absent","Present"))
p1a <- p1a + theme(panel.background = element_rect(fill = 'white'),
                   axis.line.x = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.line.y = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.title.x = element_text(margin = unit(c(8, 0, 0, 0), "mm")),
                   axis.title.y = element_text(margin = unit(c(0, 5, 0, 0), "mm")),
                   axis.text.x = element_text(colour="black"),
                   axis.text.y = element_text(colour="black"),
                   plot.title = element_text(face="bold", hjust=0, colour="black"),
                   plot.subtitle = element_text(face="bold", hjust=0, colour="black", margin = unit(c(2, 0, 0, 0), "mm")),
                   legend.position = "none",
                   text = element_text(size=20))
p1a

## Plot ordered richness
make.sorted.plot <- function(x){
  ordered <- sort(x, T)
  plot(
    ordered,
    col = terrain.colors(10),
    xaxt = "n", pch = 16, cex = 2,
    ylim = c(min(ordered)*0.5, max(ordered)),
    xlim = c(0, length(x)+1),
    ylab = "Diversity measure", xlab = "Sites",
    main = substitute(x))
  text(ordered,
       names(ordered),
       srt = -75,
       pos = 4)
}
make.sorted.plot(net.sample.richness)

## Species richness does not appear higher in ponds without crucian
## carp, indicating this species may have a negligible impact on the 
## macroinvertebrate community.
## Statistical comparison:
net.alpha.regression <- glm.nb(net.sample.richness ~ Crucian, 
                               data=net.alpha)

summary(net.alpha.regression)
anova(net.alpha.regression, test = "Chi")
drop1(net.alpha.regression, test = "Chi")
summary(glht(glm.nb(net.sample.richness ~ Crucian, data=net.alpha), 
             linfct=mcp(Crucian="Tukey")))

## Check model meets GLM assumptions
## Test for overdispersion
18.253/16
1-pchisq(18.253, df=16)  # not overdispersed

## Plot the fitted data against the observed data
plot(net.alpha$net.sample.richness ~ fitted(net.alpha.regression))

## Hosmer and Lemeshow Goodness of Fit Test
hoslem.test(net.alpha$net.sample.richness, fitted(net.alpha.regression))

## Model supposedly fits well as p-value is not significant 
## i.e. no significant difference between the model and the observed data

## Perform model validation checks to ensure model is good fit to data and 
## making reliable predictions
## Assumption 1: residuals are normally distributed
sresid <- resid(net.alpha.regression, type = "pearson")
hist(sresid)
lines(density(sresid,adjust=1))
qqnorm(sresid, cex=1.8, pch=20)
qqline(sresid, lty=2, lwd=2)
chkres(net.alpha.regression)
shapiro.test(sresid) # P = 0.5825

## No deviation from normality as residuals are normally distributed
## therefore model is reliable.

## Assumption 2: no heteroscedascity
## Plot standardised residuals against each independent variable to 
## identify any source of heterogeneity i.e. independent variable that is 
## non-linearly associated with y
plot(sresid ~ net.alpha.regression$fitted.values, pch=20, cex=2, cex.lab=1.5)
plot(sresid ~ net.alpha$Crucian, pch=20, cex=2, cex.lab=1.5) # No heteroscedascity

## Assumption 3: no collinearity
## Only one variable being modelled so no collinearity present.

## Assumption 4: no serial auto-correlation
## can arise if there are unaccounted for relationships in data set or
## if there is confounding effect of time or space
durbinWatsonTest(net.alpha.regression)

## No significant serial auto-correlation as p-value not significant
## Use graphical approach with Auto-Correlation Function (ACF)
acf(sresid, main = "Auto-correlation plot")
## Some autocorrelation at first time lag

## Assumption 5: model not biased by unduly influential observations
influence <- influence.measures(net.alpha.regression)
summary(influence)
CD <- cooks.distance(net.alpha.regression)
plot(CD ~ sresid)

## Cook's distance < 1 so observations not exerting strong influence on model
## parameters

## Based on model, no significant effect of crucian carp on alpha diversity
## NB: other indices of alpha diversity, such as Fishers Alpha and Shannon
## diversity, could not be used as they take abundance into account.
## We do not know whether sequencing data accurately reflects specimen
## abundance, thus we treat all data as presence-absence.

## Was sample size enough to accurately represent macroinvertebrate
## diversity?
## Plot species accumulation curve across ponds
plot(specaccum(net.spec.pa), 
     xlab = "Number of ponds", 
     ylab = "Number of species",
     ci.type="polygon", ci.col="grey")

## More ponds would have been required to fully represent macroinvertebrate
## diversity.


#'
#' ## Beta diversity
#' 

## Now look at beta diversity in crucian and non-crucian ponds.
## The beta.pair() function computes three dissimilarity metrics and uses 
## the argument index.family to calculate beta diversity according to 
## Sorensen or Jaccard index of total dissimilarity. The function returns 
## three matrices containing the pairwise between-site values of each 
## component of beta diversity (turnover, nestedness, total beta). The 
## dissimilarity matrices yielded by beta.pair are objects of class dist 
## and can be used for further analyses, e.g. NMDS, cluster analysis.
## (NB: Jaccard index is used to calculate beta diversity from 
## presence-absence data. Abundance data would use Bray-curtis 
## dissimilarity)

## Beta diversity across all ponds
net.multi <- beta.multi(net.spec.pa, index.family="jaccard")
print(net.multi)

## The majority of total beta diversity arises from species turnover
## rather than nestedness.

## Sampling across equal sites
net.samp <- beta.sample(net.spec.pa, 
                        index.family="jaccard",
                        sites=8,                # minimum no. of sites in a group
                        samples=100)

## Plotting the distributions of components
dist.net.samp <- net.samp$sampled.values
plot(density(dist.net.samp$beta.JAC),xlim=c(0,1), ylim=c(0,100), 
xlab='Beta diversity', main='', lwd=3)
lines(density(dist.net.samp$beta.JAC), lty=1, lwd=2)
lines(density(dist.net.samp$beta.JNE), lty=1, lwd=2)
lines(density(dist.net.samp$beta.JTU), lty=2, lwd=2)

## Pairwise between-site values of each component of beta diversity
net.dist <- beta.pair(net.spec.pa, index.family="jaccard")

## 1. TURNOVER PARTITION (COMPLETE CHANGE IN COMMUNITIES)
net.bd.turn <- betadisper(net.dist$beta.jtu, metadata$Crucian)

## Check homogeneity of multivariate dispersions. Groups being tested should 
## have the sample multivariate spread to conform to assumptions of PERMANOVA
mod.turn <- with(metadata, net.bd.turn)
mod.turn

## Compute mean distance to centroid per group
tapply(net.bd.turn$distances, metadata$Crucian, mean)

## Compute variance per group
tapply(net.bd.turn$distances, metadata$Crucian, var)

## Ordination plot of turnover partition
plot(net.bd.turn)

## Boxplot of turnover partition
boxplot(net.bd.turn, xlab="Crucian carp", xaxt="n", bty="n")
axis(side=1, at=c(1,2), labels=c("Absent","Present"))

## Plots indicates that there is some difference in turnover partition
## of beta diversity between crucian and non-crucian ponds. 
## Statistically check whether turnover is different in crucian and
## non-crucian ponds using standard parametric anova or permutation
## tests.
anova(net.bd.turn)     # No significant difference between ponds
permutest(net.bd.turn) # No significant difference between ponds

## Analyse pairwise differences between groups (crucian/non-crucian) using 
## parametric Tukey's HSD test.
TukeyHSD(net.bd.turn)  # No significant difference between groups

## Ordination of beta diversity partitioned by turnover:
## The metaMDS function automatically transforms data and checks solution
## robustness
net.comm.turn <- metaMDS(net.dist$beta.jtu, dist = "jaccard")

## Assess goodness of ordination fit (stress plot)
stressplot(net.comm.turn)

## plot site scores as text
ordiplot(net.comm.turn, display = "sites", type = "text")

## Build data frame with NMDS coordinates and metadata
net.NMDS1 <- net.comm.turn$points[,1]
net.NMDS2 <- net.comm.turn$points[,2]
net.turn.NMDS <- data.frame(NMDS1=net.NMDS1, 
                            NMDS2=net.NMDS2,
                            Crucian = metadata$Crucian)

## Check data
head(net.turn.NMDS)

## Plot data frame
p2a <- ggplot(net.turn.NMDS, aes(x=NMDS1, y=NMDS2, colour=Crucian))
p2a <- p2a + geom_point() + stat_ellipse()
p2a <- p2a + labs(x="", y="NMDS2",
                  title="(a) Turnover",
                  subtitle=" (i) Netting and microscopy")
p2a <- p2a + coord_cartesian(xlim=c(-1,1), ylim=c(-1,1))
p2a <- p2a + scale_colour_manual(name="Crucian carp",
                                 breaks=c("N","Y"),
                                 labels=c("Absent","Present"),
                                 values=c("grey40","deepskyblue2"))
p2a <- p2a + theme(panel.background = element_rect(fill = 'white'),
                   axis.line.x = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.line.y = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.title.x = element_text(margin = unit(c(8, 0, 0, 0), "mm")),
                   axis.title.y = element_text(margin = unit(c(0, 5, 0, 0), "mm")),
                   axis.text.x = element_text(colour="black"),
                   axis.text.y = element_text(colour="black"),
                   plot.title = element_text(face="bold", hjust=0, colour="black"),
                   plot.subtitle = element_text(face="bold", hjust=0, color="black", margin = unit(c(2, 0, 0, 0), "mm")),
                   text = element_text(size=20),
                   legend.position = "bottom",
                   legend.key=element_blank(),
                   legend.key.size = unit(2, 'lines'))
p2a

## Statistically check difference in spatial turnover of communities
net.turn.anosim <- anosim(net.dist$beta.jtu, metadata$Crucian)

## Inspect results
net.turn.anosim
summary(net.turn.anosim)
plot(net.turn.anosim)

## There appears to be a borderline significant difference in spatial turnover
## Look at PermANOVA using adonis(), considered more robust than anosim()
net.turn.adonis <- adonis(net.dist$beta.jtu ~ Crucian, metadata)

## Inspect results
## no summary() or plot() methods included
net.turn.adonis

## Now, result is significant. Netting indicates there is substantial 
## difference in species replacement (i.e. turnover) between
## ponds with crucian carp and ponds without crucian carp. Therefore,
## species in ponds with no fish are substituted by species in ponds
## with crucian carp.


## 2. NESTEDNESS PARTITION (SUBSET OF CHANGE IN WIDER COMMUNITY)
net.bd.nest <- betadisper(net.dist$beta.jne, metadata$Crucian)

## Check homogeneity of multivariate dispersions. Groups being tested should 
## have the sample multivariate spread to conform to assumptions of PERMANOVA
mod.nest <- with(metadata, net.bd.nest)
mod.nest

## Compute mean distance to centroid per group
tapply(net.bd.nest$distances, metadata$Crucian, mean)

## Compute variance per group
tapply(net.bd.nest$distances, metadata$Crucian, var)

## Ordination plot of nestedness partition
plot(net.bd.nest)

## Boxplot of nestedness partition
boxplot(net.bd.nest, xlab="Crucian carp", xaxt="n", bty="n")
axis(side=1, at=c(1,2), labels=c("Absent","Present"))

## Plots indicate that there is slight difference in nestedness partition
## of beta diversity between crucian and non-crucian ponds. 
## Statistically check whether nestedness is different in crucian and
## non-crucian ponds using standard parametric anova or permutation
## tests.
anova(net.bd.nest)     # Significant difference between ponds
permutest(net.bd.nest) # Significant difference between ponds

## Analyse pairwise differences between groups using parametric Tukey's HSD 
## test.
TukeyHSD(net.bd.nest)  # Significant difference between ponds

## Ordination of beta diversity partitioned by nestedness:
net.comm.nest <- metaMDS(net.dist$beta.jne, dist = "jaccard")

## Assess goodness of ordination fit (stress plot)
stressplot(net.comm.nest)

## plot site scores as text
ordiplot(net.comm.nest, display = "sites", type = "text")

## Build data frame with NMDS coordinates and metadata
net.NMDS1 <- net.comm.nest$points[,1]
net.NMDS2 <- net.comm.nest$points[,2]
net.nest.NMDS <- data.frame(NMDS1=net.NMDS1, 
                            NMDS2=net.NMDS2,
                            Crucian = metadata$Crucian)

## Check data
head(net.nest.NMDS)

## Plot data frame
p2b <- ggplot(net.nest.NMDS, aes(x=NMDS1, y=NMDS2, colour=Crucian))
p2b <- p2b + geom_point() + stat_ellipse()
p2b <- p2b + labs(title="(b) Nestedness", subtitle="", x="", y="")
p2b <- p2b + coord_cartesian(xlim=c(-1,1), ylim=c(-1,1))
p2b <- p2b + scale_colour_manual(name="Crucian carp",
                                 breaks=c("N","Y"),
                                 labels=c("Absent","Present"),
                                 values=c("grey40","deepskyblue2"))
p2b <- p2b + theme(panel.background = element_rect(fill = 'white'),
                   axis.line.x = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.line.y = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.title.x = element_text(margin = unit(c(8, 0, 0, 0), "mm")),
                   axis.title.y = element_text(margin = unit(c(0, 5, 0, 0), "mm")),
                   axis.text.x = element_text(colour="black"),
                   axis.text.y = element_text(colour="black"),
                   plot.title = element_text(face="bold", hjust=0, colour="black"),
                   plot.subtitle = element_text(face="bold", hjust=0, colour="black", margin = unit(c(2, 0, 0, 0), "mm")),
                   text = element_text(size=20),
                   legend.position="none")
p2b

## Statistically check difference in nestedness of communities
net.nest.anosim <- anosim(net.dist$beta.jne, metadata$Crucian)

## Inspect results
net.nest.anosim
summary(net.nest.anosim)
plot(net.nest.anosim)

## There appears to be no significant difference in nestedness
## Look at PermANOVA using adonis(), considered more robust than anosim()
net.nest.adonis <- adonis(net.dist$beta.jne ~ Crucian, metadata)

## Inspect results
## no summary() or plot() methods included
net.nest.adonis

## Again result is not significant. Netting indicates there is no 
## substantial difference in species loss or gain (i.e. nestedness) 
## between ponds with crucian carp and ponds without crucian carp.


## 3. TOTAL BETA DIVERSITY
net.bd.total <- betadisper(net.dist$beta.jac, metadata$Crucian)

## Check homogeneity of multivariate dispersions. Groups being tested should 
## have the sample multivariate spread to conform to assumptions of PERMANOVA
mod.total <- with(metadata, net.bd.total)
mod.total

## Compute mean distance to centroid per group
tapply(net.bd.total$distances, metadata$Crucian, mean)

## Compute variance per group
tapply(net.bd.total$distances, metadata$Crucian, var)

## Ordination plot of total beta diversity
plot(net.bd.total)

## Boxplot of total beta diversity
boxplot(net.bd.total, xlab="Crucian carp", xaxt="n", bty="n")
axis(side=1, at=c(1,2), labels=c("Absent","Present"))

## Plots indicates that there is little difference in total beta diversity 
## between crucian and non-crucian ponds. 
## Statistically check whether total beta is different in crucian and
## non-crucian ponds using standard parametric anova or permutation
## tests.
anova(net.bd.total)     # No significant difference between ponds
permutest(net.bd.total) # No significant difference between ponds

## Analyse pairwise differences between groups using parametric Tukey's HSD 
## test.
TukeyHSD(net.bd.total)  # No significant difference between ponds

## Ordination of total beta diversity:
## The metaMDS function automatically transforms data and checks solution
## robustness
net.comm.total <- metaMDS(net.dist$beta.jac, dist = "jaccard")

## Assess goodness of ordination fit (stress plot)
stressplot(net.comm.total)

## plot site scores as text
ordiplot(net.comm.total, display = "sites", type = "text")

## Build data frame with NMDS coordinates and metadata
net.NMDS1 <- net.comm.total$points[,1]
net.NMDS2 <- net.comm.total$points[,2]
net.total.NMDS <- data.frame(NMDS1=net.NMDS1,
                             NMDS2=net.NMDS2,
                             Crucian = metadata$Crucian)

## Check data
head(net.total.NMDS)

## Plot data frame
p2c <- ggplot(net.total.NMDS, aes(x=NMDS1, y=NMDS2, colour=Crucian)) 
p2c <- p2c + geom_point() + stat_ellipse()
p2c <- p2c + labs(title=expression(bold("(c) Total"~beta~"Diversity")), subtitle="", x="", y="")
p2c <- p2c + coord_cartesian(xlim=c(-1,1), ylim=c(-1,1))
p2c <- p2c + scale_colour_manual(name="Crucian carp",
                                 breaks=c("N","Y"),
                                 labels=c("Absent","Present"),
                                 values=c("grey40","deepskyblue2"))
p2c <- p2c + theme(panel.background = element_rect(fill = 'white'),
                   axis.line.x = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.line.y = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.title.x = element_text(margin = unit(c(8, 0, 0, 0), "mm")),
                   axis.title.y = element_text(margin = unit(c(0, 5, 0, 0), "mm")),
                   axis.text.x = element_text(colour="black"),
                   axis.text.y = element_text(colour="black"),
                   plot.title = element_text(face="bold", hjust=0, colour="black"),
                   plot.subtitle = element_text(face="bold", hjust=0, colour="black", margin = unit(c(2, 0, 0, 0), "mm")),
                   text = element_text(size=20),
                   legend.position="none")
p2c

## Statistically check difference in total beta diversity of ponds
net.total.anosim <- anosim(net.dist$beta.jac, metadata$Crucian)

## Inspect results
net.total.anosim
summary(net.total.anosim)
plot(net.total.anosim)

## There appears to be borderline significant difference in total beta diversity
## Look at PermANOVA using adonis(), considered more robust than anosim()
net.total.adonis <- adonis(net.dist$beta.jac ~ Crucian, metadata)

## Inspect results
## no summary() or plot() methods included
net.total.adonis

## Result is significant. Netting indicates there is substantial variation in 
## overall species composition of ponds with crucian carp and ponds without 
## crucian carp

## Further exploration of total beta diversity
## Create matrix from total beta diversity dist object
net.beta.temp <- as.matrix(net.dist$beta.jac)
net.beta.temp
net.beta.temp2 <- t(combn(colnames(net.beta.temp),2))
net.beta <- data.frame(net.beta.temp2, dist=net.beta.temp[net.beta.temp2])
colnames(net.beta) <- c("Pond1","Pond2","Jaccard")

## Subset data for crucian and non-crucian ponds
crucian <- subset(metadata, Crucian=="Y")
crucian$Site <- factor(crucian$Site)
non_crucian <- subset(metadata, Crucian=="N")
non_crucian$Site <- factor(non_crucian$Site)

## Make vectors of crucian and non-crucian ponds
crucian <- c(levels(crucian$Site))
non_crucian <- c(levels(non_crucian$Site))

## Loop over jaccard data frame and create new column saying what type of 
## combination we have
net.beta$Combo <- factor(ifelse(net.beta$Pond1%in%crucian&net.beta$Pond2%in%crucian,"crucian-crucian",
                                ifelse(net.beta$Pond1%in%crucian&net.beta$Pond2%in%non_crucian,"crucian-no crucian",
                                       ifelse(net.beta$Pond1%in%non_crucian&net.beta$Pond2%in%crucian,"crucian-no crucian",
                                              ifelse(net.beta$Pond2%in%non_crucian&net.beta$Pond2%in%non_crucian,"no crucian-no crucian",
                                                     "Fail")))))

## Regression examining whether Jaccard distance is influenced by site 
## combinations
net.beta.regression <- aov(Jaccard ~ Combo, data=net.beta)
summary(net.beta.regression)
anova(net.beta.regression)

## Tukey post-hoc test examining difference between groups
TukeyHSD(net.beta.regression, ordered = TRUE)

## Plot of jaccard distance across groups
p3a <- ggplot(net.beta, aes(x=Combo, y=Jaccard))
p3a <- p3a + ggtitle("(a) Netting")
p3a <- p3a + geom_jitter(aes(colour=Combo), width=0.2)
p3a <- p3a + geom_boxplot(alpha=0.7, outlier.colour="red") 
p3a <- p3a + scale_y_continuous(limits=c(0,1))
p3a <- p3a + scale_colour_manual(values=c("deepskyblue2","limegreen","goldenrod1"))
p3a <- p3a + annotate("text", 
                      x = c("crucian-crucian",
                            "crucian-no crucian",
                            "no crucian-no crucian"), 
                      y = 0.5, 
                      label = c("a","a","b"), cex=10)
p3a <- p3a + labs(x="Combination", y="Jaccard dissimilarity")
p3a <- p3a + theme(panel.background = element_rect(fill = "white"), 
                   axis.line.x = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.line.y = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.title.x = element_text(margin = unit(c(8, 0, 0, 0), "mm")),
                   axis.title.y = element_text(margin = unit(c(0, 5, 0, 0), "mm")),
                   axis.text.x = element_text(colour="black"),
                   axis.text.y = element_text(colour="black"),
                   plot.title = element_text(face="bold"),
                   text = element_text(size=20),
                   legend.position = "none")
p3a

## A useful way to examine this result is to build a "tree" from it. 
## Here, a tree (actually a dendrogram) is a way to cluster the sites 
## together based on how "far apart" they are in species composition; 
## sites which have very similar species compositions will group together 
## on the tree.
## Three methods of clustering but 'average' linkage method (based on the 
## average dissimilarity between groups of sites) usually most robust:
jacc.cla <- hclust(net.dist$beta.jac, method="average")
jacc.cls <- hclust(net.dist$beta.jac, method="single")
jacc.clc <- hclust(net.dist$beta.jac, method="complete")

## Display the classification trees for these methods and notice how the 
## shape of the trees changes.
plot(jacc.cla)
plot(jacc.cls)
plot(jacc.clc)

## Measure the correlation between your original dissimilarity matrix and 
## the inter-group dissimilarity at each step up the classification tree 
## via the cophenetic function:
cor(net.dist$beta.jac, cophenetic(jacc.cla))
cor(net.dist$beta.jac, cophenetic(jacc.cls))
cor(net.dist$beta.jac, cophenetic(jacc.clc))

## Average linkage method appears to have strongest correlation
## Plot dendrogram of site Jaccard dissimilarity
plot(jacc.cla, hang = -1,
     main = "Sites clustered by Jaccard similarity",
     axes = FALSE, ylab = "")


#' 
#' Netting indicates that there is no difference in alpha diversity of ponds,
#' but beta diversity, partitioned by species turnover, is significantly different
#' in ponds with or without crucian carp.
#' 
#' Is this pattern observed at family level?
#' 


#'
#' ### Family level analyses
#' 
#' Import data containing family level assignments for specimens identified by
#' microscopy.
#' 

## Import data
net.fam <- read.csv("../Data/Netting_site_by_family.csv", header=TRUE, row.names=1)
summary(net.fam)
head(net.fam)
names(net.fam)
str(net.fam)


#'
#' Basic summaries
#' 

## Total number of individuals per pond
sum.of.rows <- apply(net.fam, 1, sum)
sort(sum.of.rows, decreasing = TRUE) 
sum(sum.of.rows)


## Total number of individuals per family across all sites
sum.of.columns <- apply(net.fam, 2, sum)

## Actual number of individuals:
sort(sum.of.columns, decreasing = TRUE)
sum(sum.of.columns)

## Proportional number of individuals:
sort(round(sum.of.columns/sum(sum.of.columns)*100, 2), decreasing = TRUE)


## Number of ponds where each species occurs
net.fam.pres <- apply(net.fam > 0, 2, sum) 
sort(net.fam.pres, decreasing = TRUE)



#'
#' ## Data transformation
#' 
#' From now on, all data exploration and analyses will take place in the 
#' vegan package.
#' 

## Tranform data
net.fam.pa <- decostand(net.fam, method = "pa", MARGIN = 1) # by rows (ponds)
head(net.fam.pa[,1:3], n = 3)


#'
#' ## Alpha diversity
#' 

## Basic richness - two ways to calculate:
net.fam.richness <- specnumber(net.fam.pa)
net.fam.richness

## Plot alpha diversity
## Create data frame
net.fam.alpha <- data.frame(net.fam.richness)

## add metadata from external file
net.fam.alpha <- cbind(metadata[,1:2], net.fam.alpha)

## Reset row names of data frame for further indexing
rownames(net.fam.alpha) <- NULL

## Plot species richness
p1d <- ggplot(net.fam.alpha, aes(x=Crucian, y=net.fam.richness))
p1d <- p1d + geom_jitter(aes(colour=Crucian), width=0.2, cex=2, show.legend=FALSE)
p1d <- p1d + geom_boxplot(alpha=0.7, outlier.shape = NA)
p1d <- p1d + scale_y_continuous(limits=c(0,100))
p1d <- p1d + labs(title="(b) Family-level", subtitle="", 
                  x="", y="")
p1d <- p1d + scale_colour_manual(values=c("grey40","deepskyblue2"))
p1d <- p1d + scale_x_discrete(breaks=c("N","Y"),
                              labels=c("Absent","Present"))
p1d <- p1d + theme(panel.background = element_rect(fill = 'white'),
                   axis.line.x = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.line.y = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.title.x = element_text(margin = unit(c(8, 0, 0, 0), "mm")),
                   axis.title.y = element_text(margin = unit(c(0, 5, 0, 0), "mm")),
                   axis.text.x = element_text(colour="black"),
                   axis.text.y = element_text(colour="black"),
                   plot.title = element_text(face="bold", hjust=0, colour="black"),
                   plot.subtitle = element_text(face="bold", hjust=0, colour="black", margin = unit(c(2, 0, 0, 0), "mm")),
                   legend.position = "none",
                   text = element_text(size=20))
p1d

## Plot ordered richness
make.sorted.plot <- function(x){
  ordered <- sort(x, T)
  plot(
    ordered,
    col = terrain.colors(10),
    xaxt = "n", pch = 16, cex = 2,
    ylim = c(min(ordered)*0.5, max(ordered)),
    xlim = c(0, length(x)+1),
    ylab = "Diversity measure", xlab = "Sites",
    main = substitute(x))
  text(ordered,
       names(ordered),
       srt = -75,
       pos = 4)
}
make.sorted.plot(net.fam.richness)

## Family richness does not appear much higher in ponds without crucian
## carp, indicating this species may have a negligible impact on the 
## macroinvertebrate community.
## Statistical comparison:
net.fam.regression <- glm.nb(net.fam.richness ~ Crucian, data=net.fam.alpha)
summary(net.fam.regression)
anova(net.fam.regression, test = "Chi")
drop1(net.fam.regression, test = "Chi")
summary(glht(glm(net.fam.richness ~ Crucian, data=net.fam.alpha), 
             linfct=mcp(Crucian="Tukey")))

## Check model meets GLM assumptions
## Test for overdispersion
18.666/16
1-pchisq(18.666, df=16)  # not overdispersed

## Plot the fitted data against the observed data
plot(net.fam.alpha$net.fam.richness ~ fitted(net.fam.regression))

## Hosmer and Lemeshow Goodness of Fit Test
hoslem.test(net.fam.alpha$net.fam.richness, fitted(net.fam.regression))

## Model supposedly fits well as p-value is not significant 
## i.e. no significant difference between the model and the observed data

## Perform model validation checks to ensure model is good fit to data and 
## making reliable predictions
## Assumption 1: residuals are normally distributed
sresid <- resid(net.fam.regression, type = "pearson")
hist(sresid)
lines(density(sresid,adjust=1))
qqnorm(sresid, cex=1.8, pch=20)
qqline(sresid, lty=2, lwd=2)
chkres(net.fam.regression)
shapiro.test(sresid) # P = 0.5825

## No deviation from normality as residuals are normally distributed
## therefore model is reliable.

## Assumption 2: no heteroscedascity
## Plot standardised residuals against each independent variable to 
## identify any source of heterogeneity i.e. independent variable that is 
## non-linearly associated with y
plot(sresid ~ net.fam.regression$fitted.values, pch=20, cex=2, cex.lab=1.5)
plot(sresid ~ net.fam.alpha$Crucian, pch=20, cex=2, cex.lab=1.5) # No heteroscedascity

## Assumption 3: no collinearity
## Only one variable being modelled so no collinearity present.

## Assumption 4: no serial auto-correlation
## can arise if there are unaccounted for relationships in data set or
## if there is confounding effect of time or space
durbinWatsonTest(net.fam.regression)

## No significant serial auto-correlation as p-value not significant
## Use graphical approach with Auto-Correlation Function (ACF)
acf(sresid, main = "Auto-correlation plot")
## Some autocorrelation at first time lag

## Assumption 5: model not biased by unduly influential observations
influence <- influence.measures(net.fam.regression)
summary(influence)
CD <- cooks.distance(net.fam.regression)
plot(CD ~ sresid)

## Cook's distance < 1 so observations not exerting strong influence on model
## parameters

## Model indicates no significant effect of crucian carp on alpha diversity
## NB: other indices of alpha diversity, such as Fishers Alpha and Shannon
## diversity, could not be used as they take abundance into account.
## We do not know whether sequencing data accurately reflects specimen
## abundance, thus we treat all data as presence-absence.

## Was sample size enough to accurately represent macroinvertebrate
## diversity?
## Plot species accumulation curve across ponds
plot(specaccum(net.fam.pa), 
     xlab = "Number of ponds", 
     ylab = "Number of families",
     ci.type="polygon", ci.col="grey")

## Number of ponds samples was adequate to fully represent macroinvertebrate
## diversity at family-level.


#'
#' ## Beta diversity
#' 

## Now look at beta diversity in crucian and non-crucian ponds.
## The beta.pair() function computes three dissimilarity metrics and uses 
## the argument index.family to calculate beta diversity according to 
## Sorensen or Jaccard index of total dissimilarity. The function returns 
## three matrices containing the pairwise between-site values of each 
## component of beta diversity (turnover, nestedness, total beta). The 
## dissimilarity matrices yielded by beta.pair are objects of class dist 
## and can be used for further analyses, e.g. NMDS, cluster analysis.
## (NB: Jaccard index is used to calculate beta diversity from 
## presence-absence data. Abundance data would use Bray-curtis 
## dissimilarity)

## Beta diversity across all ponds
net.fam.multi <- beta.multi(net.fam.pa, index.family="jaccard")
print(net.fam.multi)

## The majority of total beta diversity arises from species turnover
## rather than nestedness.

## Sampling across equal sites
net.fam.samp <- beta.sample(net.fam.pa, 
                            index.family="jaccard",
                            sites=8,                # minimum no. of sites in a group
                            samples=100)

## Plotting the distributions of components
dist.net.samp <- net.fam.samp$sampled.values
plot(density(dist.net.samp$beta.JAC),xlim=c(0,1), ylim=c(0,100), 
     xlab='Beta diversity', main='', lwd=3)
lines(density(dist.net.samp$beta.JAC), lty=1, lwd=2)
lines(density(dist.net.samp$beta.JNE), lty=1, lwd=2)
lines(density(dist.net.samp$beta.JTU), lty=2, lwd=2)

## Pairwise between-site values of each component of beta diversity
net.fam.dist <- beta.pair(net.fam.pa, index.family="jaccard")

## 1. TURNOVER PARTITION (COMPLETE CHANGE IN COMMUNITIES)
net.fam.bd.turn <- betadisper(net.fam.dist$beta.jtu, metadata$Crucian)

## Check homogeneity of multivariate dispersions. Groups being tested should 
## have the sample multivariate spread to conform to assumptions of PERMANOVA
mod.turn <- with(metadata, net.fam.bd.turn)
mod.turn

## Compute mean distance to centroid per group
tapply(net.fam.bd.turn$distances, metadata$Crucian, mean)

## Compute variance per group
tapply(net.fam.bd.turn$distances, metadata$Crucian, var)

## Ordination plot of turnover partition
plot(net.fam.bd.turn)

## Boxplot of turnover partition
boxplot(net.fam.bd.turn, xlab="Crucian carp", xaxt="n", bty="n")
axis(side=1, at=c(1,2), labels=c("Absent","Present"))

## Plots indicates that there is some difference in turnover partition
## of beta diversity between crucian and non-crucian ponds. 
## Statistically check whether turnover is different in crucian and
## non-crucian ponds using standard parametric anova or permutation
## tests.
anova(net.fam.bd.turn)     # No significant difference between ponds
permutest(net.fam.bd.turn) # No significant difference between ponds

## Analyse pairwise differences between groups (crucian/non-crucian) using 
## parametric Tukey's HSD test.
TukeyHSD(net.fam.bd.turn)  # No significant difference between groups

## Ordination of beta diversity partitioned by turnover:
## The metaMDS function automatically transforms data and checks solution
## robustness
net.fam.comm.turn <- metaMDS(net.fam.dist$beta.jtu, dist = "jaccard")

## Assess goodness of ordination fit (stress plot)
stressplot(net.fam.comm.turn)

## plot site scores as text
ordiplot(net.fam.comm.turn, display = "sites", type = "text")

## Build data frame with NMDS coordinates and metadata
net.NMDS1 <- net.fam.comm.turn$points[,1]
net.NMDS2 <- net.fam.comm.turn$points[,2]
net.fam.turn.NMDS <- data.frame(NMDS1=net.NMDS1, 
                                NMDS2=net.NMDS2,
                                Crucian = metadata$Crucian)

## Check data
head(net.fam.turn.NMDS)

## Plot data frame
p4a <- ggplot(net.fam.turn.NMDS, aes(x=NMDS1, y=NMDS2, colour=Crucian))
p4a <- p4a + geom_point() + stat_ellipse()
p4a <- p4a + labs(title="(a) Turnover",
                  subtitle="(i) Netting and microscopy",
                  x="", y="NMDS2")
p4a <- p4a + coord_cartesian(xlim=c(-1,1), ylim=c(-1,1))
p4a <- p4a + scale_colour_manual(name="Crucian carp",
                                 breaks=c("N","Y"),
                                 labels=c("Absent","Present"),
                                 values=c("grey40","deepskyblue2"))
p4a <- p4a + theme(panel.background = element_rect(fill = 'white'),
                   axis.line.x = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.line.y = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.title.x = element_text(margin = unit(c(8, 0, 0, 0), "mm")),
                   axis.title.y = element_text(margin = unit(c(0, 5, 0, 0), "mm")),
                   axis.text.x = element_text(colour="black"),
                   axis.text.y = element_text(colour="black"),
                   plot.title = element_text(face="bold", hjust=0, colour="black"),
                   plot.subtitle = element_text(face="bold", hjust=0, colour="black", margin = unit(c(2, 0, 0, 0), "mm")),
                   text = element_text(size=20),
                   legend.position = "bottom",
                   legend.key=element_blank(),
                   legend.key.size = unit(2, 'lines'))
p4a

## Statistically check difference in spatial turnover of communities
net.fam.turn.anosim <- anosim(net.fam.dist$beta.jtu, metadata$Crucian)

## Inspect results
net.fam.turn.anosim
summary(net.fam.turn.anosim)
plot(net.fam.turn.anosim)

## There appears to be no significant difference in spatial turnover
## Look at PermANOVA using adonis(), considered more robust than anosim()
net.fam.turn.adonis <- adonis(net.fam.dist$beta.jtu ~ Crucian, metadata)

## Inspect results
## no summary() or plot() methods included
net.fam.turn.adonis

## Results are not significant. Netting indicates there is no real 
## difference in species replacement (i.e. turnover) between
## ponds with crucian carp and ponds without crucian carp. Therefore,
## families in ponds with no fish are not substituted by families in ponds
## with crucian carp.


## 2. NESTEDNESS PARTITION (SUBSET OF CHANGE IN WIDER COMMUNITY)
net.fam.bd.nest <- betadisper(net.fam.dist$beta.jne, metadata$Crucian)

## Check homogeneity of multivariate dispersions. Groups being tested should 
## have the sample multivariate spread to conform to assumptions of PERMANOVA
mod.nest <- with(metadata, net.fam.bd.nest)
mod.nest

## Compute mean distance to centroid per group
tapply(net.fam.bd.nest$distances, metadata$Crucian, mean)

## Compute variance per group
tapply(net.fam.bd.nest$distances, metadata$Crucian, var)

## Ordination plot of turnover partition
plot(net.fam.bd.nest)

## Boxplot of turnover partition
boxplot(net.fam.bd.nest, xlab="Crucian carp", xaxt="n", bty="n")
axis(side=1, at=c(1,2), labels=c("Absent","Present"))

## Plots indicate that there is slight difference in nestedness partition
## of beta diversity between crucian and non-crucian ponds. 
## Statistically check whether nestedness is different in crucian and
## non-crucian ponds using standard parametric anova or permutation
## tests.
anova(net.fam.bd.nest)     # No significant difference between ponds
permutest(net.fam.bd.nest) # No significant difference between ponds

## Analyse pairwise differences between groups using parametric Tukey's HSD 
## test.
TukeyHSD(net.fam.bd.nest)  # No significant difference between ponds

## Ordination of beta diversity partitioned by nestedness:
net.fam.comm.nest <- metaMDS(net.fam.dist$beta.jne, dist = "jaccard")

## Assess goodness of ordination fit (stress plot)
stressplot(net.fam.comm.nest)

## plot site scores as text
ordiplot(net.fam.comm.nest, display = "sites", type = "text")

## Build data frame with NMDS coordinates and metadata
net.NMDS1 <- net.fam.comm.nest$points[,1]
net.NMDS2 <- net.fam.comm.nest$points[,2]
net.fam.nest.NMDS <- data.frame(NMDS1=net.NMDS1, 
                                NMDS2=net.NMDS2,
                                Crucian = metadata$Crucian)

## Check data
head(net.fam.nest.NMDS)

## Plot data frame
p4b <- ggplot(net.fam.nest.NMDS, aes(x=NMDS1, y=NMDS2, colour=Crucian))
p4b <- p4b + geom_point() + stat_ellipse()
p4b <- p4b + labs(title="(b) Nestedness", subtitle="", x="", y="")
p4b <- p4b + coord_cartesian(xlim=c(-1,1), ylim=c(-1,1))
p4b <- p4b + scale_colour_manual(name="Crucian carp",
                                 breaks=c("N","Y"),
                                 labels=c("Absent","Present"),
                                 values=c("grey40","deepskyblue2"))
p4b <- p4b + theme(panel.background = element_rect(fill = 'white'),
                   axis.line.x = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.line.y = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.title.x = element_text(margin = unit(c(8, 0, 0, 0), "mm")),
                   axis.title.y = element_text(margin = unit(c(0, 5, 0, 0), "mm")),
                   axis.text.x = element_text(colour="black"),
                   axis.text.y = element_text(colour="black"),
                   plot.title = element_text(face="bold", hjust=0, colour="black"),
                   plot.subtitle = element_text(face="bold", hjust=0, colour="black", margin = unit(c(2, 0, 0, 0), "mm")),
                   text = element_text(size=20),
                   legend.position="none")
p4b

## Statistically check difference in nestedness of communities
net.fam.nest.anosim <- anosim(net.fam.dist$beta.jne, metadata$Crucian)

## Inspect results
net.fam.nest.anosim
summary(net.fam.nest.anosim)
plot(net.fam.nest.anosim)

## There appears to be a significant difference in nestedness
## Look at PermANOVA using adonis(), considered more robust than anosim()
net.fam.nest.adonis <- adonis(net.fam.dist$beta.jne ~ Crucian, metadata)

## Inspect results
## no summary() or plot() methods included
net.fam.nest.adonis

## Result is not significant. Netting indicates there is no 
## substantial difference in species loss or gain (i.e. nestedness) 
## between ponds with crucian carp and ponds without crucian carp.


## 3. TOTAL BETA DIVERSITY
net.fam.bd.total <- betadisper(net.fam.dist$beta.jac, metadata$Crucian)

## Check homogeneity of multivariate dispersions. Groups being tested should 
## have the sample multivariate spread to conform to assumptions of PERMANOVA
mod.total <- with(metadata, net.fam.bd.total)
mod.total

## Compute mean distance to centroid per group
tapply(net.fam.bd.total$distances, metadata$Crucian, mean)

## Compute variance per group
tapply(net.fam.bd.total$distances, metadata$Crucian, var)

## Ordination plot of total beta diversity
plot(net.fam.bd.total)

## Boxplot of total beta diversity
boxplot(net.fam.bd.total, xlab="Crucian carp", xaxt="n", bty="n")
axis(side=1, at=c(1,2), labels=c("Absent","Present"))

## Plots indicate that there is little difference in total beta diversity 
## between crucian and non-crucian ponds. 
## Statistically check whether total beta is different in crucian and
## non-crucian ponds using standard parametric anova or permutation
## tests.
anova(net.fam.bd.total)     # No significant difference between ponds
permutest(net.fam.bd.total) # No significant difference between ponds

## Analyse pairwise differences between groups using parametric Tukey's HSD 
## test.
TukeyHSD(net.fam.bd.total)  # No significant difference between ponds

## Ordination of total beta diversity:
## The metaMDS function automatically transforms data and checks solution
## robustness
net.fam.comm.total <- metaMDS(net.fam.dist$beta.jac, dist = "jaccard")

## Assess goodness of ordination fit (stress plot)
stressplot(net.fam.comm.total)

## plot site scores as text
ordiplot(net.fam.comm.total, display = "sites", type = "text")

## Build data frame with NMDS coordinates and metadata
net.NMDS1 <- net.fam.comm.total$points[,1]
net.NMDS2 <- net.fam.comm.total$points[,2]
net.fam.total.NMDS <- data.frame(NMDS1=net.NMDS1,
                                 NMDS2=net.NMDS2,
                                 Crucian = metadata$Crucian)

## Check data
head(net.fam.total.NMDS)

## Plot data frame
p4c <- ggplot(net.fam.total.NMDS, aes(x=NMDS1, y=NMDS2, colour=Crucian)) 
p4c <- p4c + geom_point() + stat_ellipse()
p4c <- p4c + labs(title=expression(bold("(c) Total"~beta~"Diversity")), 
                  subtitle="", x="", y="")
p4c <- p4c + coord_cartesian(xlim=c(-1,1), ylim=c(-1,1))
p4c <- p4c + scale_colour_manual(name="Crucian carp",
                                 breaks=c("N","Y"),
                                 labels=c("Absent","Present"),
                                 values=c("grey40","deepskyblue2"))
p4c <- p4c + theme(panel.background = element_rect(fill = 'white'),
                   axis.line.x = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.line.y = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.title.x = element_text(margin = unit(c(8, 0, 0, 0), "mm")),
                   axis.title.y = element_text(margin = unit(c(0, 5, 0, 0), "mm")),
                   axis.text.x = element_text(colour="black"),
                   axis.text.y = element_text(colour="black"),
                   plot.title = element_text(face="bold", hjust=0, colour="black"),
                   plot.subtitle = element_text(face="bold", hjust=0, colour="black", margin = unit(c(2, 0, 0, 0), "mm")),
                   text = element_text(size=20),
                   legend.position="none")
p4c

## Statistically check difference in total beta diversity of ponds
net.fam.total.anosim <- anosim(net.fam.dist$beta.jac, metadata$Crucian)

## Inspect results
net.fam.total.anosim
summary(net.fam.total.anosim)
plot(net.fam.total.anosim)

## There appears to be no significant difference in total beta diversity
## Look at PermANOVA using adonis(), considered more robust than anosim()
net.fam.total.adonis <- adonis(net.fam.dist$beta.jac ~ Crucian, metadata)

## Inspect results
## no summary() or plot() methods included
net.fam.total.adonis

## Result is not significant. Netting indicates there is no variation in 
## overall family composition of ponds with crucian carp and ponds without 
## crucian carp

## Further exploration of total beta diversity
## Create matrix from total beta diversity dist object
net.fam.beta.temp <- as.matrix(net.fam.dist$beta.jac)
net.fam.beta.temp
net.fam.beta.temp2 <- t(combn(colnames(net.beta.temp),2))
net.fam.beta <- data.frame(net.fam.beta.temp2, dist=net.fam.beta.temp[net.fam.beta.temp2])
colnames(net.fam.beta) <- c("Pond1","Pond2","Jaccard")

## Subset data for crucian and non-crucian ponds
crucian <- subset(metadata, Crucian=="Y")
crucian$Site <- factor(crucian$Site)
non_crucian <- subset(metadata, Crucian=="N")
non_crucian$Site <- factor(non_crucian$Site)

## Make vectors of crucian and non-crucian ponds
crucian <- c(levels(crucian$Site))
non_crucian <- c(levels(non_crucian$Site))

## Loop over jaccard data frame and create new column saying what type of 
## combination we have
net.fam.beta$Combo <- factor(ifelse(net.fam.beta$Pond1%in%crucian&net.fam.beta$Pond2%in%crucian,"crucian-crucian",
                                    ifelse(net.fam.beta$Pond1%in%crucian&net.fam.beta$Pond2%in%non_crucian,"crucian-no crucian",
                                           ifelse(net.fam.beta$Pond1%in%non_crucian&net.fam.beta$Pond2%in%crucian,"crucian-no crucian",
                                                  ifelse(net.fam.beta$Pond2%in%non_crucian&net.fam.beta$Pond2%in%non_crucian,"no crucian-no crucian",
                                                         "Fail")))))

## Regression examining whether Jaccard distance is influenced by site 
## combinations
net.fam.beta.regression <- aov(Jaccard ~ Combo, data=net.fam.beta)
summary(net.fam.beta.regression)
anova(net.fam.beta.regression)

## Tukey post-hoc test examining difference between groups
TukeyHSD(net.fam.beta.regression, ordered = TRUE)

## Plot of jaccard distance across groups
p3d <- ggplot(net.fam.beta, aes(x=Combo, y=Jaccard))
p3d <- p3d + ggtitle("(a) Netting")
p3d <- p3d + geom_jitter(aes(colour=Combo), width=0.2)
p3d <- p3d + geom_boxplot(alpha=0.7, outlier.colour="red") 
p3d <- p3d + scale_y_continuous(limits=c(0,1))
p3d <- p3d + scale_colour_manual(values=c("deepskyblue2","limegreen","goldenrod1"))
p3d <- p3d + annotate("text", 
                      x = c("crucian-crucian",
                            "crucian-no crucian",
                            "no crucian-no crucian"), 
                      y = 1, 
                      label = c("a","a","a"), cex=10)
p3d <- p3d + labs(x="Combination", y="Jaccard dissimilarity")
p3d <- p3d + theme(panel.background = element_rect(fill = "white"), 
                   axis.line.x = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.line.y = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.title.x = element_text(margin = unit(c(8, 0, 0, 0), "mm")),
                   axis.title.y = element_text(margin = unit(c(0, 5, 0, 0), "mm")),
                   axis.text.x = element_text(colour="black"),
                   axis.text.y = element_text(colour="black"),
                   plot.title = element_text(face="bold"),
                   text = element_text(size=20),
                   legend.position = "none")
p3d

## A useful way to examine this result is to build a "tree" from it. 
## Here, a tree (actually a dendrogram) is a way to cluster the sites 
## together based on how "far apart" they are in family composition; 
## sites which have very similar family compositions will group together 
## on the tree.
## Three methods of clustering but 'average' linkage method (based on the 
## average dissimilarity between groups of sites) usually most robust:
jacc.cla <- hclust(net.fam.dist$beta.jac, method="average")
jacc.cls <- hclust(net.fam.dist$beta.jac, method="single")
jacc.clc <- hclust(net.fam.dist$beta.jac, method="complete")

## Display the classification trees for these methods and notice how the 
## shape of the trees changes.
plot(jacc.cla)
plot(jacc.cls)
plot(jacc.clc)

## Measure the correlation between your original dissimilarity matrix and 
## the inter-group dissimilarity at each step up the classification tree 
## via the cophenetic function:
cor(net.fam.dist$beta.jac, cophenetic(jacc.cla))
cor(net.fam.dist$beta.jac, cophenetic(jacc.cls))
cor(net.fam.dist$beta.jac, cophenetic(jacc.clc))

## Average linkage method appears to have strongest correlation
## Plot dendrogram of site Jaccard dissimilarity
plot(jacc.cla, hang = -1,
     main = "Sites clustered by Jaccard similarity",
     axes = FALSE, ylab = "")


#'
#' What do DNA metabarcoding and eDNA metabarcoding tell us? 
#' 



#' ---
#' 
#' 2) DNA metabarcoding

## Import refined DNA metabarcoding data
DNA.df <- read.csv("../Data/DNA_metabarcoding_pooled.csv", 
                   row.names=1, header=TRUE)
summary(DNA.df)
head(DNA.df)
names(DNA.df)
str(DNA.df)

## Remove '.' from sample names
colnames(DNA.df) <- gsub("[.]", " ", colnames(DNA.df))

## Before progressing with analysis of the bulk tissue data using vegan, we have 
## to alter the dataframe to contain only species level assignments
DNA.df <- DNA.df[,which(grepl(" ", colnames(DNA.df)))]

## Remove empty taxonomic assignments as these are problematic for vegan
DNA.df <- DNA.df[!sapply(DNA.df, function(x) all(x == 0))]


#'
#' ### Species level analysis
#' 
#' Basic summaries
#' 

## Total number of sequences per pond
sum.of.rows <- apply(DNA.df, 1, sum)
sort(sum.of.rows, decreasing = TRUE) 
sum(sum.of.rows)


## Total number of sequences per species across all sites
sum.of.columns <- apply(DNA.df, 2, sum)

## Actual read counts:
sort(sum.of.columns, decreasing = TRUE)
sum(sum.of.columns)

## Proportional read counts:
sort(round(sum.of.columns/sum(sum.of.columns)*100, 2), decreasing = TRUE)  # proportional read count


## Number of ponds where each species occurs
DNA.spec.pres <- apply(DNA.df > 0, 2, sum) 
sort(DNA.spec.pres, decreasing = TRUE)



#'
#' ## Data transformation
#' 
#' From now on, all data exploration and analyses will take place in the 
#' vegan package.
#' 

## Tranform data
DNA.spec.pa <- decostand(DNA.df, method = "pa", MARGIN = 1) # by rows (ponds)
head(DNA.spec.pa[,1:3], n = 3)


#'
#' ## Alpha diversity
#' 

## Basic richness
DNA.spp.richness <- specnumber(DNA.spec.pa)
DNA.spp.richness

## Plot alpha diversity
## Create data frame
DNA.spp.alpha <- data.frame(DNA.spp.richness)

## add metadata from external file
DNA.spp.alpha <- cbind(metadata[,1:2], DNA.spp.alpha)

## Reset row names of data frame for further indexing
rownames(DNA.spp.alpha) <- NULL

## Plot species richness
p1b <- ggplot(DNA.spp.alpha, aes(x=Crucian, y=DNA.spp.richness))
p1b <- p1b + geom_jitter(aes(colour=Crucian), cex=2, width=0.2, show.legend=FALSE)
p1b <- p1b + geom_boxplot(alpha=0.7, outlier.shape=NA)
p1b <- p1b + scale_y_continuous(limits=c(0,100))
p1b <- p1b + labs(subtitle="(ii) DNA metabarcoding", 
                  x="", y=expression(alpha~diversity))
p1b <- p1b + scale_colour_manual(values=c("grey40","deepskyblue2"))
p1b <- p1b + scale_x_discrete(breaks=c("N","Y"),
                              labels=c("Absent","Present"))
p1b <- p1b + theme(panel.background = element_rect(fill = 'white'),
                   axis.line.x = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.line.y = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.title.x = element_text(margin = unit(c(8, 0, 0, 0), "mm")),
                   axis.title.y = element_text(margin = unit(c(0, 5, 0, 0), "mm")),
                   axis.text.x = element_text(colour="black"),
                   axis.text.y = element_text(colour="black"),
                   plot.title = element_text(face="bold", hjust=0, colour="black"),
                   plot.subtitle = element_text(face="bold", hjust=0, colour="black", margin = unit(c(2, 0, 0, 0), "mm")),
                   legend.position = "none",
                   text = element_text(size=20))
p1b

## Plot ordered richness
make.sorted.plot <- function(x){
  ordered <- sort(x, T)
  plot(
    ordered,
    col = terrain.colors(10),
    xaxt = "n", pch = 16, cex = 2,
    ylim = c(min(ordered)*0.5, max(ordered)),
    xlim = c(0, length(x)+1),
    ylab = "Diversity measure", xlab = "Sites",
    main = substitute(x))
  text(ordered,
       names(ordered),
       srt = -75,
       pos = 4)
}
make.sorted.plot(DNA.spp.richness)

## Species richness does not appear higher in ponds without crucian
## carp, indicating this species may have a negligible impact on the 
## macroinvertebrate community.
## Statistical comparison:
DNA.spp.regression <- glm.nb(DNA.spp.richness ~ Crucian, data=DNA.spp.alpha)
summary(DNA.spp.regression)
anova(DNA.spp.regression, test = "Chi")
drop1(DNA.spp.regression, test = "Chi")
summary(glht(glm(DNA.spp.richness ~ Crucian, data=DNA.spp.alpha), 
             linfct=mcp(Crucian="Tukey")))

## Check model meets GLM assumptions
## Test for overdispersion
18.600/16
1-pchisq(18.600, df=16)  # not overdispersed

## Plot the fitted data against the observed data
plot(DNA.spp.alpha$DNA.spp.richness ~ fitted(DNA.spp.regression))

## Hosmer and Lemeshow Goodness of Fit Test
hoslem.test(DNA.spp.alpha$DNA.spp.richness, fitted(DNA.spp.regression))

## Model supposedly fits well as p-value is not significant 
## i.e. no significant difference between the model and the observed data

## Perform model validation checks to ensure model is good fit to data and 
## making reliable predictions
## Assumption 1: residuals are normally distributed
sresid <- resid(DNA.spp.regression, type = "pearson")
hist(sresid)
lines(density(sresid,adjust=1))
qqnorm(sresid, cex=1.8, pch=20)
qqline(sresid, lty=2, lwd=2)
chkres(DNA.spp.regression)
shapiro.test(sresid) # P = 0.5825

## No deviation from normality as residuals are normally distributed
## therefore model is reliable.

## Assumption 2: no heteroscedascity
## Plot standardised residuals against each independent variable to 
## identify any source of heterogeneity i.e. independent variable that is 
## non-linearly associated with y
plot(sresid ~ DNA.spp.regression$fitted.values, pch=20, cex=2, cex.lab=1.5)
plot(sresid ~ DNA.spp.alpha$Crucian, pch=20, cex=2, cex.lab=1.5) # No heteroscedascity

## Assumption 3: no collinearity
## Only one variable being modelled so no collinearity present.

## Assumption 4: no serial auto-correlation
## can arise if there are unaccounted for relationships in data set or
## if there is confounding effect of time or space
durbinWatsonTest(DNA.spp.regression)

## No significant serial auto-correlation as p-value not significant
## Use graphical approach with Auto-Correlation Function (ACF)
acf(sresid, main = "Auto-correlation plot")
## Some autocorrelation at first time lag

## Assumption 5: model not biased by unduly influential observations
influence <- influence.measures(DNA.spp.regression)
summary(influence)
CD <- cooks.distance(DNA.spp.regression)
plot(CD ~ sresid)

## Cook's distance < 1 so observations not exerting strong influence on model
## parameters

## Model indicates no significant effect of crucian carp on alpha diversity
## NB: other indexes of alpha diversity, such as Fishers Alpha and Shannon
## diversity, could not be used as they take abundance into account.
## We do not know whether sequencing data accurately reflects specimen
## abundance, thus we treat all data as presence-absence.

## Was sample size enough to accurately represent macroinvertebrate
## diversity?
## Plot species accumulation curve across ponds
plot(specaccum(DNA.df), 
     xlab = "Number of ponds", 
     ylab = "Number of species",
     ci.type="polygon", ci.col="grey")

## More ponds would have been required to fully represent macroinvertebrate
## diversity.


#'
#' ## Beta diversity
#' 

## Now look at beta diversity in crucian and non-crucian ponds.
## The beta.pair() function computes three dissimilarity metrics and uses 
## the argument index.family to calculate beta diversity according to 
## Sorensen or Jaccard index of total dissimilarity. The function returns 
## three matrices containing the pairwise between-site values of each 
## component of beta diversity (turnover, nestedness, total beta). The 
## dissimilarity matrices yielded by beta.pair are objects of class dist 
## and can be used for further analyses, e.g. NMDS, cluster analysis.
## (NB: Jaccard index is used to calculate beta diversity from 
## presence-absence data. Abundance data would use Bray-curtis 
## dissimilarity)

## Beta diversity across all ponds
DNA.multi <- beta.multi(DNA.spec.pa, index.family="jaccard")
print(DNA.multi)

## The majority of total beta diversity arises from species turnover
## rather than nestedness.

## Sampling across equal sites
DNA.samp <- beta.sample(DNA.spec.pa, 
                        index.family="jaccard",
                        sites=8,                # minimum no. of sites in a group
                        samples=100)

## Plotting the distributions of components
dist.DNA.samp <- DNA.samp$sampled.values
plot(density(dist.DNA.samp$beta.JAC),xlim=c(0,1), ylim=c(0,100), 
     xlab='Beta diversity', main='', lwd=3)
lines(density(dist.DNA.samp$beta.JAC), lty=1, lwd=2)
lines(density(dist.DNA.samp$beta.JNE), lty=1, lwd=2)
lines(density(dist.DNA.samp$beta.JTU), lty=2, lwd=2)

## Pairwise between-site values of each component of beta diversity
DNA.dist <- beta.pair(DNA.spec.pa, index.family="jaccard")

## 1. TURNOVER PARTITION (COMPLETE CHANGE IN COMMUNITIES)
DNA.bd.turn <- betadisper(DNA.dist$beta.jtu, metadata$Crucian)

## Check homogeneity of multivariate dispersions. Groups being tested should 
## have the sample multivariate spread to conform to assumptions of PERMANOVA
mod.turn <- with(metadata, DNA.bd.turn)
mod.turn

## Compute mean distance to centroid per group
tapply(DNA.bd.turn$distances, metadata$Crucian, mean)

## Compute variance per group
tapply(DNA.bd.turn$distances, metadata$Crucian, var)

## Ordination plot of turnover partition
plot(DNA.bd.turn)

## Boxplot of turnover partition
boxplot(DNA.bd.turn, xlab="Crucian carp", xaxt="n", bty="n")
axis(side=1, at=c(1,2), labels=c("Absent","Present"))

## Plots indicate that there is no real difference in turnover partition
## of beta diversity between crucian and non-crucian ponds. 
## Statistically check whether turnover is different in crucian and
## non-crucian ponds using standard parametric anova or permutation
## tests.
anova(DNA.bd.turn)     # No significant difference between ponds
permutest(DNA.bd.turn) # No significant difference between ponds

## Analyse pairwise differences between groups (crucian/non-crucian) using 
## parametric Tukey's HSD test.
TukeyHSD(DNA.bd.turn)  # No significant difference between groups

## Ordination of beta diversity partitioned by turnover:
## The metaMDS function automatically transforms data and checks solution
## robustness
DNA.comm.turn <- metaMDS(DNA.dist$beta.jtu, dist = "jaccard")

## Assess goodness of ordination fit (stress plot)
stressplot(DNA.comm.turn)

## plot site scores as text
ordiplot(DNA.comm.turn, display = "sites", type = "text")

## Build data frame with NMDS coordinates and metadata
DNA.NMDS1 <- DNA.comm.turn$points[,1]
DNA.NMDS2 <- DNA.comm.turn$points[,2]
DNA.turn.NMDS <- data.frame(NMDS1=DNA.NMDS1, 
                            NMDS2=DNA.NMDS2,
                            Crucian = metadata$Crucian)

## Check data
head(DNA.turn.NMDS)

## Plot data frame
p2d <- ggplot(DNA.turn.NMDS, aes(x=NMDS1, y=NMDS2, colour=Crucian))
p2d <- p2d + geom_point() + stat_ellipse()
p2d <- p2d + labs(subtitle="(ii) DNA metabarcoding", x="", y="NMDS2")
p2d <- p2d + coord_cartesian(xlim=c(-1,1), ylim=c(-1,1))
p2d <- p2d + scale_colour_manual(name="Crucian carp",
                                 breaks=c("N","Y"),
                                 labels=c("Absent","Present"),
                                 values=c("grey40","deepskyblue2"))
p2d <- p2d + theme(panel.background = element_rect(fill = 'white'),
                   axis.line.x = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.line.y = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.title.x = element_text(margin = unit(c(8, 0, 0, 0), "mm")),
                   axis.title.y = element_text(margin = unit(c(0, 5, 0, 0), "mm")),
                   axis.text.x = element_text(colour="black"),
                   axis.text.y = element_text(colour="black"),
                   plot.title = element_text(face="bold", hjust=0, color="black"),
                   plot.subtitle = element_text(face="bold", hjust=0, color="black", margin = unit(c(2, 0, 0, 0), "mm")),
                   text = element_text(size=20),
                   legend.position="none")
p2d

## Statistically check difference in spatial turnover of communities
DNA.turn.anosim <- anosim(DNA.dist$beta.jtu, metadata$Crucian)

## Inspect results
DNA.turn.anosim
summary(DNA.turn.anosim)
plot(DNA.turn.anosim)

## There appears to be no significant difference in spatial turnover
## Look at PermANOVA using adonis(), considered more robust than anosim()
DNA.turn.adonis <- adonis(DNA.dist$beta.jtu ~ Crucian, metadata)

## Inspect results
## no summary() or plot() methods included
DNA.turn.adonis

## Again result is not significant. DNA metabarcoding indicates there is no 
## substantial difference in species replacement (i.e. turnover) between
## ponds with crucian carp and ponds without crucian carp. Therefore,
## species in ponds with no fish are not substituted by species in ponds
## with crucian carp.


## 2. NESTEDNESS PARTITION (SUBSET OF CHANGE IN WIDER COMMUNITY)
DNA.bd.nest <- betadisper(DNA.dist$beta.jne, metadata$Crucian)

## Check homogeneity of multivariate dispersions. Groups being tested should 
## have the sample multivariate spread to conform to assumptions of PERMANOVA
DNA.nest <- with(metadata, DNA.bd.nest)
DNA.nest

## Compute mean distance to centroid per group
tapply(DNA.bd.nest$distances, metadata$Crucian, mean)

## Compute variance per group
tapply(DNA.bd.nest$distances, metadata$Crucian, var)

## Ordination plot of turnover partition
plot(DNA.bd.nest)

## Boxplot of turnover partition
boxplot(DNA.bd.nest, xlab="Crucian carp", xaxt="n", bty="n")
axis(side=1, at=c(1,2), labels=c("Absent","Present"))

## Plots indicates that there is slight difference in nestedness partition
## of beta diversity between crucian and non-crucian ponds. 
## Statistically check whether nestedness is different in crucian and
## non-crucian ponds using standard parametric anova or permutation
## tests.
anova(DNA.bd.nest)     # Significant difference between ponds
permutest(DNA.bd.nest) # Significant difference between ponds

## Analyse pairwise differences between groups using parametric Tukey's HSD 
## test.
TukeyHSD(DNA.bd.nest)  # Significant difference between ponds

## Ordination of beta diversity partitioned by nestedness:
DNA.comm.nest <- metaMDS(DNA.dist$beta.jne, dist = "jaccard")

## Assess goodness of ordination fit (stress plot)
stressplot(DNA.comm.nest)

## plot site scores as text
ordiplot(DNA.comm.nest, display = "sites", type = "text")

## Build data frame with NMDS coordinates and metadata
DNA.NMDS1 <- DNA.comm.nest$points[,1]
DNA.NMDS2 <- DNA.comm.nest$points[,2]
DNA.nest.NMDS <- data.frame(NMDS1=DNA.NMDS1, 
                            NMDS2=DNA.NMDS2,
                            Crucian = metadata$Crucian)

## Check data
head(DNA.nest.NMDS)

## Plot data frame
p2e <- ggplot(DNA.nest.NMDS, aes(x=NMDS1, y=NMDS2, colour=Crucian))
p2e <- p2e + geom_point() + stat_ellipse()
p2e <- p2e + labs(subtitle="", x="", y="")
p2e <- p2e + coord_cartesian(xlim=c(-1,1), ylim=c(-1,1))
p2e <- p2e + scale_colour_manual(name="Crucian carp",
                                 breaks=c("N","Y"),
                                 labels=c("Absent","Present"),
                                 values=c("grey40","deepskyblue2"))
p2e <- p2e + theme(panel.background = element_rect(fill = 'white'),
                   axis.line.x = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.line.y = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.title.x = element_text(margin = unit(c(8, 0, 0, 0), "mm")),
                   axis.title.y = element_text(margin = unit(c(0, 5, 0, 0), "mm")),
                   axis.text.x = element_text(colour="black"),
                   axis.text.y = element_text(colour="black"),
                   plot.title = element_text(face="bold", hjust=0, colour="black"),
                   plot.subtitle = element_text(face="bold", hjust=0, colour="black", margin = unit(c(2, 0, 0, 0), "mm")),
                   text = element_text(size=20),
                   legend.position="none")
p2e

## Statistically check difference in nestedness of communities
DNA.nest.anosim <- anosim(DNA.dist$beta.jne, metadata$Crucian)

## Inspect results
DNA.nest.anosim
summary(DNA.nest.anosim)
plot(DNA.nest.anosim)

## There appears to be no significant difference in nestedness
## Look at PermANOVA using adonis(), considered more robust than anosim()
DNA.nest.adonis <- adonis(DNA.dist$beta.jne ~ Crucian, metadata)

## Inspect results
## no summary() or plot() methods included
DNA.nest.adonis

## Again result is not significant. DNA metabarcoding indicates there is no 
## substantial difference in species loss or gain (i.e. nestedness) 
## between ponds with crucian carp and ponds without crucian carp.


## 3. TOTAL BETA DIVERSITY
DNA.bd.total <- betadisper(DNA.dist$beta.jac, metadata$Crucian)

## Check homogeneity of multivariate dispersions. Groups being tested should 
## have the sample multivariate spread to conform to assumptions of PERMANOVA
mod.total <- with(metadata, DNA.bd.total)
mod.total

## Compute mean distance to centroid per group
tapply(DNA.bd.total$distances, metadata$Crucian, mean)

## Compute variance per group
tapply(DNA.bd.total$distances, metadata$Crucian, var)

## Ordination plot of total beta diversity
plot(DNA.bd.total)

## Boxplot of total beta diversity
boxplot(DNA.bd.total, xlab="Crucian carp", xaxt="n", bty="n")
axis(side=1, at=c(1,2), labels=c("Absent","Present"))

## Plots indicates that there is some difference in total beta diversity 
## between crucian and non-crucian ponds. 
## Statistically check whether total beta is different in crucian and
## non-crucian ponds using standard parametric anova or permutation
## tests.
anova(DNA.bd.total)     # No significant difference between ponds
permutest(DNA.bd.total) # No significant difference between ponds

## Analyse pairwise differences between groups using parametric Tukey's 
## HSD test.
TukeyHSD(DNA.bd.total)  # No significant difference between ponds

## Ordination of total beta diversity:
## The metaMDS function automatically transforms data and checks solution
## robustness
DNA.comm.total <- metaMDS(DNA.dist$beta.jac, dist = "jaccard")

## Assess goodness of ordination fit (stress plot)
stressplot(DNA.comm.total)

## plot site scores as text
ordiplot(DNA.comm.total, display = "sites", type = "text")

## Build data frame with NMDS coordinates and metadata
DNA.NMDS1 <- DNA.comm.total$points[,1]
DNA.NMDS2 <- DNA.comm.total$points[,2]
DNA.total.NMDS <- data.frame(NMDS1=DNA.NMDS1,
                             NMDS2=DNA.NMDS2,
                             Crucian = metadata$Crucian)

## Check data
head(DNA.total.NMDS)

## Plot data frame
p2f <- ggplot(DNA.total.NMDS, aes(x=NMDS1, y=NMDS2, colour=Crucian)) 
p2f <- p2f + geom_point() + stat_ellipse()
p2f <- p2f + labs(subtitle="", x="", y="")
p2f <- p2f + coord_cartesian(xlim=c(-1,1), ylim=c(-1,1))
p2f <- p2f + scale_colour_manual(name="Crucian carp",
                                 breaks=c("N","Y"),
                                 labels=c("Absent","Present"),
                                 values=c("grey40","deepskyblue2"))
p2f <- p2f + theme(panel.background = element_rect(fill = 'white'),
                   axis.line.x = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.line.y = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.title.x = element_text(margin = unit(c(8, 0, 0, 0), "mm")),
                   axis.title.y = element_text(margin = unit(c(0, 5, 0, 0), "mm")),
                   axis.text.x = element_text(colour="black"),
                   axis.text.y = element_text(colour="black"),
                   plot.title = element_text(face="bold", hjust=0, colour="black"),
                   plot.subtitle = element_text(face="bold", hjust=0, colour="black", margin = unit(c(2, 0, 0, 0), "mm")),
                   text = element_text(size=20),
                   legend.position="none")
p2f

## Statistically check difference in total beta diversity of ponds
DNA.total.anosim <- anosim(DNA.dist$beta.jac, metadata$Crucian)

## Inspect results
DNA.total.anosim
summary(DNA.total.anosim)
plot(DNA.total.anosim)

## There appears to be no significant difference in total beta diversity
## Look at PermANOVA using adonis(), considered more robust than anosim()
DNA.total.adonis <- adonis(DNA.dist$beta.jac ~ Crucian, metadata)

## Inspect results
## no summary() or plot() methods included
DNA.total.adonis

## Again result is not significant. DNA metabarcoding indicates there is 
## no substantial variation in overall species composition of
## ponds with crucian carp and ponds without crucian carp

## Further exploration of total beta diversity
## Create matrix from total beta diversity dist object
DNA.beta.temp <- as.matrix(DNA.dist$beta.jac)
DNA.beta.temp
DNA.beta.temp2 <- t(combn(colnames(DNA.beta.temp),2))
DNA.beta <- data.frame(DNA.beta.temp2, dist=DNA.beta.temp[DNA.beta.temp2])
colnames(DNA.beta) <- c("Pond1","Pond2","Jaccard")

## Subset data for crucian and non-crucian ponds
crucian <- subset(metadata, Crucian=="Y")
crucian$Site <- factor(crucian$Site)
non_crucian <- subset(metadata, Crucian=="N")
non_crucian$Site <- factor(non_crucian$Site)

## Make vectors of crucian and non-crucian ponds
crucian <- c(levels(crucian$Site))
non_crucian <- c(levels(non_crucian$Site))

## Loop over jaccard data frame and create new column saying what type of 
## combination we have
DNA.beta$Combo <- factor(ifelse(DNA.beta$Pond1%in%crucian&DNA.beta$Pond2%in%crucian,"crucian-crucian",
                                ifelse(DNA.beta$Pond1%in%crucian&DNA.beta$Pond2%in%non_crucian,"crucian-no crucian",
                                       ifelse(DNA.beta$Pond1%in%non_crucian&DNA.beta$Pond2%in%crucian,"crucian-no crucian",
                                              ifelse(DNA.beta$Pond2%in%non_crucian&DNA.beta$Pond2%in%non_crucian,"no crucian-no crucian",
                                                     "Fail")))))

## Regression examining whether Jaccard distance is influenced by site 
## combinations
DNA.beta.regression <- aov(Jaccard ~ Combo, data=DNA.beta)
summary(DNA.beta.regression)
anova(DNA.beta.regression)

## Tukey post-hoc test examining difference between groups
TukeyHSD(DNA.beta.regression, ordered = TRUE)

## Plot of jaccard distance across groups
p3b <- ggplot(DNA.beta, aes(x=Combo, y=Jaccard))
p3b <- p3b + ggtitle("(b) Bulk tissue")
p3b <- p3b + geom_jitter(aes(colour=Combo), width=0.2)
p3b <- p3b + geom_boxplot(alpha=0.7, outlier.colour="red") 
p3b <- p3b + scale_y_continuous(limits=c(0,1))
p3b <- p3b + scale_colour_manual(values=c("deepskyblue2","limegreen","goldenrod1"))
p3b <- p3b + annotate("text", 
                      x = c("crucian-crucian",
                            "crucian-no crucian",
                            "no crucian-no crucian"), 
                      y = 0.5, 
                      label = c("a","a","a"), cex=10)
p3b <- p3b + labs(x="Combination", y="Jaccard dissimilarity")
p3b <- p3b + theme(panel.background = element_rect(fill = "white"), 
                   axis.line.x = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.line.y = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.title.x = element_text(margin = unit(c(8, 0, 0, 0), "mm")),
                   axis.title.y = element_text(margin = unit(c(0, 5, 0, 0), "mm")),
                   axis.text.x = element_text(colour="black"),
                   axis.text.y = element_text(colour="black"),
                   plot.title = element_text(face="bold"),
                   text = element_text(size=20),
                   legend.position = "none")
p3b

## A useful way to examine this result is to build a "tree" from it. 
## Here, a tree (actually a dendrogram) is a way to cluster the sites 
## together based on how "far apart" they are in species composition; 
## sites which have very similar species compositions will group together 
## on the tree.
## Three methods of clustering but 'average' linkage method (based on the 
## average dissimilarity between groups of sites) usually most robust:
jacc.cla <- hclust(DNA.dist$beta.jac, method="average")
jacc.cls <- hclust(DNA.dist$beta.jac, method="single")
jacc.clc <- hclust(DNA.dist$beta.jac, method="complete")

## Display the classification trees for these methods and notice how the 
## shape of the trees changes.
plot(jacc.cla)
plot(jacc.cls)
plot(jacc.clc)

## Measure the correlation between your original dissimilarity matrix and 
## the inter-group dissimilarity at each step up the classification tree 
## via the cophenetic function:
cor(DNA.dist$beta.jac, cophenetic(jacc.cla))
cor(DNA.dist$beta.jac, cophenetic(jacc.cls))
cor(DNA.dist$beta.jac, cophenetic(jacc.clc))

## Average linkage method appears to have strongest correlation
## Plot dendrogram of site Jaccard dissimilarity
plot(jacc.cla, hang = -1,
     main = "Sites clustered by Jaccard similarity",
     axes = FALSE, ylab = "")


#'
#' Are the same patterns observed at family level?
#' 


#'
#' ### Family level analysis
#' 

## Import refined family data from DNA metabarcoding
DNA.fam <- read.csv("../Data/DNA_metabarcoding_site_by_family.csv", 
                    row.names=1, header=TRUE)
summary(DNA.fam)
head(DNA.fam)
names(DNA.fam)
str(DNA.fam)

## Remove empty taxonomic assignments as these are problematic for vegan
DNA.fam <- DNA.fam[!sapply(DNA.fam, function(x) all(x == 0))]


#' 
#' Basic summaries
#' 

## Total number of sequences per pond
sum.of.rows <- apply(DNA.fam, 1, sum)
sort(sum.of.rows, decreasing = TRUE) 
sum(sum.of.rows)


## Total number of sequences per species across all sites
sum.of.columns <- apply(DNA.fam, 2, sum)

## Actual read counts:
sort(sum.of.columns, decreasing = TRUE)
sum(sum.of.columns)

## Proportional read counts:
sort(round(sum.of.columns/sum(sum.of.columns)*100, 2), decreasing = TRUE)


## Number of ponds where each species occurs
DNA.fam.pres <- apply(DNA.fam > 0, 2, sum) 
sort(DNA.fam.pres, decreasing = TRUE)


#'
#' ## Data transformation
#' 
#' From now on, all data exploration and analyses will take place in the 
#' vegan package.
#' 

## Tranform data
DNA.fam.pa <- decostand(DNA.fam, method = "pa", MARGIN = 1) # by rows (ponds)
head(DNA.fam.pa[,1:3], n = 3)


#'
#' ## Alpha diversity
#' 

## Basic richness
DNA.fam.richness <- specnumber(DNA.fam.pa)
DNA.fam.richness

## Plot alpha diversity
## Create data frame
DNA.fam.alpha <- data.frame(DNA.fam.richness)

## add metadata from external file
DNA.fam.alpha <- cbind(metadata[,1:2], DNA.fam.alpha)

## Reset row names of data frame for further indexing
rownames(DNA.fam.alpha) <- NULL

## Plot species richness
p1e <- ggplot(DNA.fam.alpha, aes(x=Crucian, y=DNA.fam.richness))
p1e <- p1e + geom_jitter(aes(colour=Crucian), cex=2, width=0.2, show.legend=FALSE)
p1e <- p1e + geom_boxplot(alpha=0.7, outlier.shape = NA)
p1e <- p1e + scale_y_continuous(limits=c(0,100))
p1e <- p1e + labs(subtitle="", x="", y="")
p1e <- p1e + scale_colour_manual(values=c("grey40","deepskyblue2"))
p1e <- p1e + scale_x_discrete(breaks=c("N","Y"),
                              labels=c("Absent","Present"))
p1e <- p1e + theme(panel.background = element_rect(fill = 'white'),
                   axis.line.x = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.line.y = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.title.x = element_text(margin = unit(c(8, 0, 0, 0), "mm")),
                   axis.title.y = element_text(margin = unit(c(0, 5, 0, 0), "mm")),
                   axis.text.x = element_text(colour="black"),
                   axis.text.y = element_text(colour="black"),
                   plot.title = element_text(face="bold", hjust=0, colour="black"),
                   plot.subtitle = element_text(face="bold", hjust=0, colour="black", margin = unit(c(2, 0, 0, 0), "mm")),
                   legend.position = "none",
                   text = element_text(size=20))
p1e

## Plot ordered richness
make.sorted.plot <- function(x){
  ordered <- sort(x, T)
  plot(
    ordered,
    col = terrain.colors(10),
    xaxt = "n", pch = 16, cex = 2,
    ylim = c(min(ordered)*0.5, max(ordered)),
    xlim = c(0, length(x)+1),
    ylab = "Diversity measure", xlab = "Sites",
    main = substitute(x))
  text(ordered,
       names(ordered),
       srt = -75,
       pos = 4)
}
make.sorted.plot(DNA.fam.richness)

## Species richness does not appear higher in ponds without crucian
## carp, indicating this species may have a negligible impact on the 
## macroinvertebrate community.
## Statistical comparison:
DNA.fam.regression <- glm.nb(DNA.fam.richness ~ Crucian, data=DNA.fam.alpha)
summary(DNA.fam.regression)
anova(DNA.fam.regression, test = "Chi")
drop1(DNA.fam.regression, test = "Chi")
summary(glht(glm(DNA.fam.richness ~ Crucian, data=DNA.fam.alpha), 
             linfct=mcp(Crucian="Tukey")))

## Check model meets GLM assumptions
## Test for overdispersion
16.463/16
1-pchisq(16.463, df=16)  # not overdispersed

## Plot the fitted data against the observed data
plot(DNA.fam.alpha$DNA.fam.richness ~ fitted(DNA.fam.regression))

## Hosmer and Lemeshow Goodness of Fit Test
hoslem.test(DNA.fam.alpha$DNA.fam.richness, fitted(DNA.fam.regression))

## Model supposedly fits well as p-value is not significant 
## i.e. no significant difference between the model and the observed data

## Model supposedly fits well as p-value is not significant 
## i.e. no significant difference between the model and the observed data

## Perform model validation checks to ensure model is good fit to data and 
## making reliable predictions
## Assumption 1: residuals are normally distributed
sresid <- resid(DNA.fam.regression, type = "pearson")
hist(sresid)
lines(density(sresid,adjust=1))
qqnorm(sresid, cex=1.8, pch=20)
qqline(sresid, lty=2, lwd=2)
chkres(DNA.fam.regression)
shapiro.test(sresid) # P = 0.5825

## No deviation from normality as residuals are normally distributed
## therefore model is reliable.

## Assumption 2: no heteroscedascity
## Plot standardised residuals against each independent variable to 
## identify any source of heterogeneity i.e. independent variable that is 
## non-linearly associated with y
plot(sresid ~ DNA.fam.regression$fitted.values, pch=20, cex=2, cex.lab=1.5)
plot(sresid ~ DNA.fam.alpha$Crucian, pch=20, cex=2, cex.lab=1.5) # No heteroscedascity

## Assumption 3: no collinearity
## Only one variable being modelled so no collinearity present.

## Assumption 4: no serial auto-correlation
## can arise if there are unaccounted for relationships in data set or
## if there is confounding effect of time or space
durbinWatsonTest(DNA.fam.regression)

## No significant serial auto-correlation as p-value not significant
## Use graphical approach with Auto-Correlation Function (ACF)
acf(sresid, main = "Auto-correlation plot")
## Some autocorrelation at first time lag

## Assumption 5: model not biased by unduly influential observations
influence <- influence.measures(DNA.fam.regression)
summary(influence)
CD <- cooks.distance(DNA.fam.regression)
plot(CD ~ sresid)

## Cook's distance < 1 so observations not exerting strong influence on model
## parameters

## Model finds no significant effect of crucian carp on alpha diversity
## NB: other indexes of alpha diversity, such as Fishers Alpha and Shannon
## diversity, could not be used as they take abundance into account.
## We do not know whether sequencing data accurately reflects specimen
## abundance, thus we treat all data as presence-absence.

## Was sample size enough to accurately represent macroinvertebrate
## diversity?
## Plot species accumulation curve across ponds
plot(specaccum(DNA.fam), 
     xlab = "Number of ponds", 
     ylab = "Number of species",
     ci.type="polygon", ci.col="grey")

## More ponds would have been required to fully represent macroinvertebrate
## diversity.


#'
#' ## Beta diversity
#' 

## Now look at beta diversity in crucian and non-crucian ponds.
## The beta.pair() function computes three dissimilarity metrics and uses 
## the argument index.family to calculate beta diversity according to 
## Sorensen or Jaccard index of total dissimilarity. The function returns 
## three matrices containing the pairwise between-site values of each 
## component of beta diversity (turnover, nestedness, total beta). The 
## dissimilarity matrices yielded by beta.pair are objects of class dist 
## and can be used for further analyses, e.g. NMDS, cluster analysis.
## (NB: Jaccard index is used to calculate beta diversity from 
## presence-absence data. Abundance data would use Bray-curtis 
## dissimilarity)

## Beta diversity across all ponds
DNA.fam.multi <- beta.multi(DNA.fam.pa, index.family="jaccard")
print(DNA.fam.multi)

## The majority of total beta diversity arises from species turnover
## rather than nestedness.

## Sampling across equal sites
DNA.fam.samp <- beta.sample(DNA.fam.pa, 
                            index.family="jaccard",
                            sites=8,                # minimum no. of sites in a group
                            samples=100)

## Plotting the distributions of components
dist.DNA.samp <- DNA.fam.samp$sampled.values
plot(density(dist.DNA.samp$beta.JAC),xlim=c(0,1), ylim=c(0,100), 
     xlab='Beta diversity', main='', lwd=3)
lines(density(dist.DNA.samp$beta.JAC), lty=1, lwd=2)
lines(density(dist.DNA.samp$beta.JNE), lty=1, lwd=2)
lines(density(dist.DNA.samp$beta.JTU), lty=2, lwd=2)

## Pairwise between-site values of each component of beta diversity
DNA.fam.dist <- beta.pair(DNA.fam.pa, index.family="jaccard")

## 1. TURNOVER PARTITION (COMPLETE CHANGE IN COMMUNITIES)
DNA.fam.bd.turn <- betadisper(DNA.fam.dist$beta.jtu, metadata$Crucian)

## Check homogeneity of multivariate dispersions. Groups being tested should 
## have the sample multivariate spread to conform to assumptions of PERMANOVA
mod.turn <- with(metadata, DNA.fam.bd.turn)
mod.turn

## Compute mean distance to centroid per group
tapply(DNA.fam.bd.turn$distances, metadata$Crucian, mean)

## Compute variance per group
tapply(DNA.fam.bd.turn$distances, metadata$Crucian, var)

## Ordination plot of turnover partition
plot(DNA.fam.bd.turn)

## Boxplot of turnover partition
boxplot(DNA.fam.bd.turn, xlab="Crucian carp", xaxt="n", bty="n")
axis(side=1, at=c(1,2), labels=c("Absent","Present"))

## Plots indicate that there is no real difference in turnover partition
## of beta diversity between crucian and non-crucian ponds. 
## Statistically check whether turnover is different in crucian and
## non-crucian ponds using standard parametric anova or permutation
## tests.
anova(DNA.fam.bd.turn)     # No significant difference between ponds
permutest(DNA.fam.bd.turn) # No significant difference between ponds

## Analyse pairwise differences between groups (crucian/non-crucian) using 
## parametric Tukey's HSD test.
TukeyHSD(DNA.fam.bd.turn)  # No significant difference between groups

## Ordination of beta diversity partitioned by turnover:
## The metaMDS function automatically transforms data and checks solution
## robustness
DNA.fam.comm.turn <- metaMDS(DNA.fam.dist$beta.jtu, dist = "jaccard")

## Assess goodness of ordination fit (stress plot)
stressplot(DNA.fam.comm.turn)

## plot site scores as text
ordiplot(DNA.fam.comm.turn, display = "sites", type = "text")

## Build data frame with NMDS coordinates and metadata
DNA.NMDS1 <- DNA.fam.comm.turn$points[,1]
DNA.NMDS2 <- DNA.fam.comm.turn$points[,2]
DNA.fam.turn.NMDS <- data.frame(NMDS1=DNA.NMDS1, 
                                NMDS2=DNA.NMDS2,
                                Crucian = metadata$Crucian)

## Check data
head(DNA.fam.turn.NMDS)

## Plot data frame
p4d <- ggplot(DNA.fam.turn.NMDS, aes(x=NMDS1, y=NMDS2, colour=Crucian))
p4d <- p4d + geom_point() + stat_ellipse()
p4d <- p4d + labs(subtitle="(ii) DNA metabarcoding", x="", y="NMDS2")
p4d <- p4d + coord_cartesian(xlim=c(-1,1), ylim=c(-1,1))
p4d <- p4d + scale_colour_manual(name="Crucian carp",
                                 breaks=c("N","Y"),
                                 labels=c("Absent","Present"),
                                 values=c("grey40","deepskyblue2"))
p4d <- p4d + theme(panel.background = element_rect(fill = 'white'),
                   axis.line.x = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.line.y = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.title.x = element_text(margin = unit(c(8, 0, 0, 0), "mm")),
                   axis.title.y = element_text(margin = unit(c(0, 5, 0, 0), "mm")),
                   axis.text.x = element_text(colour="black"),
                   axis.text.y = element_text(colour="black"),
                   plot.title = element_text(face="bold", hjust=0, colour="black"),
                   plot.subtitle = element_text(face="bold", hjust=0, colour="black", margin = unit(c(2, 0, 0, 0), "mm")),
                   text = element_text(size=20),
                   legend.position="none")
p4d

## Statistically check difference in spatial turnover of communities
DNA.fam.turn.anosim <- anosim(DNA.fam.dist$beta.jtu, metadata$Crucian)

## Inspect results
DNA.fam.turn.anosim
summary(DNA.fam.turn.anosim)
plot(DNA.fam.turn.anosim)

## There appears to be a significant difference in spatial turnover
## Look at PermANOVA using adonis(), considered more robust than anosim()
DNA.fam.turn.adonis <- adonis(DNA.fam.dist$beta.jtu ~ Crucian, metadata)

## Inspect results
## no summary() or plot() methods included
DNA.fam.turn.adonis

## Again result is significant. DNA metabarcoding indicates there is a
## substantial difference in species replacement (i.e. turnover) between
## ponds with crucian carp and ponds without crucian carp. Therefore,
## species in ponds with no fish are substituted by species in ponds
## with crucian carp.


## 2. NESTEDNESS PARTITION (SUBSET OF CHANGE IN WIDER COMMUNITY)
DNA.fam.bd.nest <- betadisper(DNA.fam.dist$beta.jne, metadata$Crucian)

## Check homogeneity of multivariate dispersions. Groups being tested should 
## have the sample multivariate spread to conform to assumptions of PERMANOVA
DNA.fam.nest <- with(metadata, DNA.fam.bd.nest)
DNA.fam.nest

## Compute mean distance to centroid per group
tapply(DNA.fam.bd.nest$distances, metadata$Crucian, mean)

## Compute variance per group
tapply(DNA.fam.bd.nest$distances, metadata$Crucian, var)

## Ordination plot of turnover partition
plot(DNA.fam.bd.nest)

## Boxplot of turnover partition
boxplot(DNA.fam.bd.nest, xlab="Crucian carp", xaxt="n", bty="n")
axis(side=1, at=c(1,2), labels=c("Absent","Present"))

## Plots indicates that there is no difference in nestedness partition
## of beta diversity between crucian and non-crucian ponds. 
## Statistically check whether nestedness is different in crucian and
## non-crucian ponds using standard parametric anova or permutation
## tests.
anova(DNA.fam.bd.nest)     # Significant difference between ponds
permutest(DNA.fam.bd.nest) # Significant difference between ponds

## Analyse pairwise differences between groups using parametric Tukey's HSD 
## test.
TukeyHSD(DNA.fam.bd.nest)  # No significant difference between ponds

## Ordination of beta diversity partitioned by nestedness:
DNA.fam.comm.nest <- metaMDS(DNA.fam.dist$beta.jne, dist = "jaccard")

## Assess goodness of ordination fit (stress plot)
stressplot(DNA.fam.comm.nest)

## plot site scores as text
ordiplot(DNA.fam.comm.nest, display = "sites", type = "text")

## Build data frame with NMDS coordinates and metadata
DNA.NMDS1 <- DNA.fam.comm.nest$points[,1]
DNA.NMDS2 <- DNA.fam.comm.nest$points[,2]
DNA.fam.nest.NMDS <- data.frame(NMDS1=DNA.NMDS1, 
                                NMDS2=DNA.NMDS2,
                                Crucian = metadata$Crucian)

## Check data
head(DNA.fam.nest.NMDS)

## Plot data frame
p4e <- ggplot(DNA.fam.nest.NMDS, aes(x=NMDS1, y=NMDS2, colour=Crucian))
p4e <- p4e + geom_point() + stat_ellipse()
p4e <- p4e + labs(subtitle="", x="", y="")
p4e <- p4e + coord_cartesian(xlim=c(-1,1), ylim=c(-1,1))
p4e <- p4e + scale_colour_manual(name="Crucian carp",
                                 breaks=c("N","Y"),
                                 labels=c("Absent","Present"),
                                 values=c("grey40","deepskyblue2"))
p4e <- p4e + theme(panel.background = element_rect(fill = 'white'),
                   axis.line.x = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.line.y = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.title.x = element_text(margin = unit(c(8, 0, 0, 0), "mm")),
                   axis.title.y = element_text(margin = unit(c(0, 5, 0, 0), "mm")),
                   axis.text.x = element_text(colour="black"),
                   axis.text.y = element_text(colour="black"),
                   plot.title = element_text(face="bold", hjust=0, colour="black"),
                   plot.subtitle = element_text(face="bold", hjust=0, colour="black", margin = unit(c(2, 0, 0, 0), "mm")),
                   text = element_text(size=20),
                   legend.position="none")
p4e

## Statistically check difference in nestedness of communities
DNA.fam.nest.anosim <- anosim(DNA.fam.dist$beta.jne, metadata$Crucian)

## Inspect results
DNA.fam.nest.anosim
summary(DNA.fam.nest.anosim)
plot(DNA.fam.nest.anosim)

## There appears to be no significant difference in nestedness
## Look at PermANOVA using adonis(), considered more robust than anosim()
DNA.fam.nest.adonis <- adonis(DNA.fam.dist$beta.jne ~ Crucian, metadata)

## Inspect results
## no summary() or plot() methods included
DNA.fam.nest.adonis

## Again result is not significant. DNA metabarcoding indicates there is no 
## substantial difference in species loss or gain (i.e. nestedness) 
## between ponds with crucian carp and ponds without crucian carp.


## 3. TOTAL BETA DIVERSITY
DNA.fam.bd.total <- betadisper(DNA.fam.dist$beta.jac, metadata$Crucian)

## Check homogeneity of multivariate dispersions. Groups being tested should 
## have the sample multivariate spread to conform to assumptions of PERMANOVA
mod.total <- with(metadata, DNA.fam.bd.total)
mod.total

## Compute mean distance to centroid per group
tapply(DNA.fam.bd.total$distances, metadata$Crucian, mean)

## Compute variance per group
tapply(DNA.fam.bd.total$distances, metadata$Crucian, var)

## Ordination plot of total beta diversity
plot(DNA.fam.bd.total)

## Boxplot of total beta diversity
boxplot(DNA.fam.bd.total, xlab="Crucian carp", xaxt="n", bty="n")
axis(side=1, at=c(1,2), labels=c("Absent","Present"))

## Plots indicates that there is no difference in total beta diversity 
## between crucian and non-crucian ponds. 
## Statistically check whether total beta is different in crucian and
## non-crucian ponds using standard parametric anova or permutation
## tests.
anova(DNA.fam.bd.total)     # No significant difference between ponds
permutest(DNA.fam.bd.total) # No significant difference between ponds

## Analyse pairwise differences between groups using parametric Tukey's 
## HSD test.
TukeyHSD(DNA.fam.bd.total)  # No significant difference between ponds

## Ordination of total beta diversity:
## The metaMDS function automatically transforms data and checks solution
## robustness
DNA.fam.comm.total <- metaMDS(DNA.fam.dist$beta.jac, dist = "jaccard")

## Assess goodness of ordination fit (stress plot)
stressplot(DNA.fam.comm.total)

## plot site scores as text
ordiplot(DNA.fam.comm.total, display = "sites", type = "text")

## Build data frame with NMDS coordinates and metadata
DNA.NMDS1 <- DNA.fam.comm.total$points[,1]
DNA.NMDS2 <- DNA.fam.comm.total$points[,2]
DNA.fam.total.NMDS <- data.frame(NMDS1=DNA.NMDS1,
                                 NMDS2=DNA.NMDS2,
                                 Crucian = metadata$Crucian)

## Check data
head(DNA.fam.total.NMDS)

## Plot data frame
p4f <- ggplot(DNA.fam.total.NMDS, aes(x=NMDS1, y=NMDS2, colour=Crucian)) 
p4f <- p4f + geom_point() + stat_ellipse()
p4f <- p4f + labs(subtitle="", x="", y="")
p4f <- p4f + coord_cartesian(xlim=c(-1,1), ylim=c(-1,1))
p4f <- p4f + scale_colour_manual(name="Crucian carp",
                                 breaks=c("N","Y"),
                                 labels=c("Absent","Present"),
                                 values=c("grey40","deepskyblue2"))
p4f <- p4f + theme(panel.background = element_rect(fill = 'white'),
                   axis.line.x = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.line.y = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.title.x = element_text(margin = unit(c(8, 0, 0, 0), "mm")),
                   axis.title.y = element_text(margin = unit(c(0, 5, 0, 0), "mm")),
                   axis.text.x = element_text(colour="black"),
                   axis.text.y = element_text(colour="black"),
                   plot.title = element_text(face="bold", hjust=0, colour="black"),
                   plot.subtitle = element_text(face="bold", hjust=0, colour="black", margin = unit(c(2, 0, 0, 0), "mm")),
                   text = element_text(size=20),
                   legend.position="none")
p4f

## Statistically check difference in total beta diversity of ponds
DNA.fam.total.anosim <- anosim(DNA.fam.dist$beta.jac, metadata$Crucian)

## Inspect results
DNA.fam.total.anosim
summary(DNA.fam.total.anosim)
plot(DNA.fam.total.anosim)

## There appears to be borderline significant difference in total beta diversity
## Look at PermANOVA using adonis(), considered more robust than anosim()
DNA.fam.total.adonis <- adonis(DNA.fam.dist$beta.jac ~ Crucian, metadata)

## Inspect results
## no summary() or plot() methods included
DNA.fam.total.adonis

## Again result is borderline significant. DNA metabarcoding indicates there 
## is some variation in overall species composition of ponds with 
## crucian carp and ponds without crucian carp

## Further exploration of total beta diversity
## Create matrix from total beta diversity dist object
DNA.fam.beta.temp <- as.matrix(DNA.dist$beta.jac)
DNA.fam.beta.temp
DNA.fam.beta.temp2 <- t(combn(colnames(DNA.fam.beta.temp),2))
DNA.fam.beta <- data.frame(DNA.fam.beta.temp2, dist=DNA.fam.beta.temp[DNA.fam.beta.temp2])
colnames(DNA.fam.beta) <- c("Pond1","Pond2","Jaccard")

## Subset data for crucian and non-crucian ponds
crucian <- subset(metadata, Crucian=="Y")
crucian$Site <- factor(crucian$Site)
non_crucian <- subset(metadata, Crucian=="N")
non_crucian$Site <- factor(non_crucian$Site)

## Make vectors of crucian and non-crucian ponds
crucian <- c(levels(crucian$Site))
non_crucian <- c(levels(non_crucian$Site))

## Loop over jaccard data frame and create new column saying what type of 
## combination we have
DNA.fam.beta$Combo <- factor(ifelse(DNA.fam.beta$Pond1%in%crucian&DNA.fam.beta$Pond2%in%crucian,"crucian-crucian",
                                    ifelse(DNA.fam.beta$Pond1%in%crucian&DNA.fam.beta$Pond2%in%non_crucian,"crucian-no crucian",
                                           ifelse(DNA.fam.beta$Pond1%in%non_crucian&DNA.fam.beta$Pond2%in%crucian,"crucian-no crucian",
                                                  ifelse(DNA.fam.beta$Pond2%in%non_crucian&DNA.fam.beta$Pond2%in%non_crucian,"no crucian-no crucian",
                                                         "Fail")))))

## Regression examining whether Jaccard distance is influenced by site 
## combinations
DNA.fam.beta.regression <- aov(Jaccard ~ Combo, data=DNA.fam.beta)
summary(DNA.fam.beta.regression)
anova(DNA.fam.beta.regression)

## Tukey post-hoc test examining difference between groups
TukeyHSD(DNA.fam.beta.regression, ordered = TRUE)

## Plot of jaccard distance across groups
p3e <- ggplot(DNA.fam.beta, aes(x=Combo, y=Jaccard))
p3e <- p3e + ggtitle("(b) Bulk tissue")
p3e <- p3e + geom_jitter(aes(colour=Combo), width=0.2)
p3e <- p3e + geom_boxplot(outlier.colour="red") 
p3e <- p3e + scale_y_continuous(limits=c(0,1))
p3e <- p3e + scale_colour_manual(values=c("deepskyblue2","limegreen","goldenrod1"))
p3e <- p3e + annotate("text", 
                      x = c("crucian-crucian",
                            "crucian-no crucian",
                            "no crucian-no crucian"), 
                      y = 0.5, 
                      label = c("a","a","a"), cex=10)
p3e <- p3e + labs(x="Combination", y="Jaccard dissimilarity")
p3e <- p3e + theme(panel.background = element_rect(fill = "white"), 
                   axis.line.x = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.line.y = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.title.x = element_text(margin = unit(c(8, 0, 0, 0), "mm")),
                   axis.title.y = element_text(margin = unit(c(0, 5, 0, 0), "mm")),
                   axis.text.x = element_text(colour="black"),
                   axis.text.y = element_text(colour="black"),
                   plot.title = element_text(face="bold"),
                   text = element_text(size=20),
                   legend.position = "none")
p3e

## A useful way to examine this result is to build a "tree" from it. 
## Here, a tree (actually a dendrogram) is a way to cluster the sites 
## together based on how "far apart" they are in species composition; 
## sites which have very similar species compositions will group together 
## on the tree.
## Three methods of clustering but 'average' linkage method (based on the 
## average dissimilarity between groups of sites) usually most robust:
jacc.cla <- hclust(DNA.dist$beta.jac, method="average")
jacc.cls <- hclust(DNA.dist$beta.jac, method="single")
jacc.clc <- hclust(DNA.dist$beta.jac, method="complete")

## Display the classification trees for these methods and notice how the 
## shape of the trees changes.
plot(jacc.cla)
plot(jacc.cls)
plot(jacc.clc)

## Measure the correlation between your original dissimilarity matrix and 
## the inter-group dissimilarity at each step up the classification tree 
## via the cophenetic function:
cor(DNA.dist$beta.jac, cophenetic(jacc.cla))
cor(DNA.dist$beta.jac, cophenetic(jacc.cls))
cor(DNA.dist$beta.jac, cophenetic(jacc.clc))

## Average linkage method appears to have strongest correlation
## Plot dendrogram of site Jaccard dissimilarity
plot(jacc.cla, hang = -1,
     main = "Sites clustered by Jaccard similarity",
     axes = FALSE, ylab = "")


#'
#' What does eDNA metabarcoding tell us?
#'



#'---
#'
#' ### 3) eDNA metabarcoding dataset
#'
#' Now, we need to examine the effect of crucian carp on invertebrate biodiversity
#' in the pooled eDNA samples.
#' 

## Import eDNA metabarcoding data
eDNA.df <- read.csv("../Data/eDNA_metabarcoding_pooled.csv", row.names=1, header=TRUE)
summary(eDNA.df)
head(eDNA.df)
names(eDNA.df)
str(eDNA.df)

## Remove '.' from sample names
colnames(eDNA.df) <- gsub("[.]", " ", colnames(eDNA.df))

## Before progressing with analysis of the bulk tissue data using vegan, we have 
## to alter the dataframe to contain only species level assignments
eDNA.df <- eDNA.df[,which(grepl(" ", colnames(eDNA.df)))]

## Remove empty taxonomic assignments as these are problematic for vegan
eDNA.df <- eDNA.df[!sapply(eDNA.df, function(x) all(x == 0))]


#'
#' Basic summaries
#' 

## Total number of sequences per pond
sum.of.rows <- apply(eDNA.df, 1, sum)
sort(sum.of.rows, decreasing = TRUE) 
sum(sum.of.rows)


## Total number of sequences per species across all sites
sum.of.columns <- apply(eDNA.df, 2, sum)

## Actual read counts:
sort(sum.of.columns, decreasing = TRUE)
sum(sum.of.columns)

## Proportional read counts:
sort(round(sum.of.columns/sum(sum.of.columns)*100, 2), decreasing = TRUE)


## Number of ponds where each species occurs
eDNA.spec.pres <- apply(eDNA.df > 0, 2, sum) 
sort(eDNA.spec.pres, decreasing = TRUE)



#'
#' ## Data transformation
#' 
#' From now on, all data exploration and analyses will take place in the 
#' vegan package.
#' 

## Tranform data
eDNA.spp.pa <- decostand(eDNA.df, method = "pa", MARGIN = 1) # by rows (ponds)
head(eDNA.spp.pa[,1:3], n = 3)


#'
#' ## Alpha diversity
#' 

## Basic richness - two ways to calculate:
eDNA.spp.richness <- specnumber(eDNA.spp.pa)
eDNA.spp.richness

## Plot alpha diversity
## Create data frame
eDNA.spp.alpha <- data.frame(eDNA.spp.richness)

## add metadata from external file
eDNA.spp.alpha <- cbind(metadata[,1:2], eDNA.spp.alpha)

## Reset row names of data frame for further indexing
rownames(eDNA.spp.alpha) <- NULL

## Plot species richness
p1c <- ggplot(eDNA.spp.alpha, aes(x=Crucian, y=eDNA.spp.richness))
p1c <- p1c + geom_jitter(aes(colour=Crucian), cex=2, width=0.2, show.legend=FALSE)
p1c <- p1c + geom_boxplot(alpha=0.7, outlier.shape = NA)
p1c <- p1c + scale_y_continuous(limits=c(0,100))
p1c <- p1c + labs(subtitle="(iii) eDNA metabarcoding", 
                  x="", y=expression(alpha~diversity))
p1c <- p1c + scale_colour_manual(values=c("grey40","deepskyblue2"))
p1c <- p1c + scale_x_discrete(breaks=c("N","Y"),
                              labels=c("Absent","Present"))
p1c <- p1c + theme(panel.background = element_rect(fill = 'white'),
                   axis.line.x = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.line.y = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.title.x = element_text(margin = unit(c(8, 0, 0, 0), "mm")),
                   axis.title.y = element_text(margin = unit(c(0, 5, 0, 0), "mm")),
                   axis.text.x = element_text(colour="black"),
                   axis.text.y = element_text(colour="black"),
                   plot.title = element_text(face="bold", hjust=0, colour="black"),
                   plot.subtitle = element_text(face="bold", hjust=0, colour="black", margin = unit(c(2, 0, 0, 0), "mm")),
                   legend.position = "none",
                   text = element_text(size=20))
p1c

## Plot ordered richness
make.sorted.plot <- function(x){
  ordered <- sort(x, T)
  plot(
    ordered,
    col = terrain.colors(10),
    xaxt = "n", pch = 16, cex = 2,
    ylim = c(min(ordered)*0.5, max(ordered)),
    xlim = c(0, length(x)+1),
    ylab = "Diversity measure", xlab = "Sites",
    main = substitute(x))
  text(ordered,
       names(ordered),
       srt = -75,
       pos = 4)
}
make.sorted.plot(eDNA.spp.richness)

## Species richness appears to be the same in ponds without crucian
## carp, indicating this species may have little impact on the 
## macroinvertebrate community.
## Statistical comparison:
eDNA.spp.regression <- glm.nb(eDNA.spp.richness ~ Crucian, data=eDNA.spp.alpha)
summary(eDNA.spp.regression)
anova(eDNA.spp.regression, test = "Chi")
drop1(eDNA.spp.regression, test = "Chi")
summary(glht(glm.nb(eDNA.spp.richness ~ Crucian, data=eDNA.spp.alpha), 
             linfct=mcp(Crucian="Tukey")))

## Check model meets GLM assumptions
## Test for overdispersion
18.695/16
1-pchisq(18.695, df=16)  # not overdispersed

## Plot the fitted data against the observed data
plot(eDNA.spp.alpha$eDNA.spp.richness ~ fitted(eDNA.spp.regression))

## Hosmer and Lemeshow Goodness of Fit Test
hoslem.test(eDNA.spp.alpha$eDNA.spp.richness, fitted(eDNA.spp.regression))

## Model supposedly fits well as p-value is not significant 
## i.e. no significant difference between the model and the observed data

## Perform model validation checks to ensure model is good fit to data and 
## making reliable predictions
## Assumption 1: residuals are normally distributed
sresid <- resid(eDNA.spp.regression, type = "pearson")
hist(sresid)
lines(density(sresid,adjust=1))
qqnorm(sresid, cex=1.8, pch=20)
qqline(sresid, lty=2, lwd=2)
chkres(eDNA.spp.regression)
shapiro.test(sresid) # P = 0.5825

## No deviation from normality as residuals are normally distributed
## therefore model is reliable.

## Assumption 2: no heteroscedascity
## Plot standardised residuals against each independent variable to 
## identify any source of heterogeneity i.e. independent variable that is 
## non-linearly associated with y
plot(sresid ~ eDNA.spp.regression$fitted.values, pch=20, cex=2, cex.lab=1.5)
plot(sresid ~ eDNA.spp.alpha$Crucian, pch=20, cex=2, cex.lab=1.5) # No heteroscedascity

## Assumption 3: no collinearity
## Only one variable being modelled so no collinearity present.

## Assumption 4: no serial auto-correlation
## can arise if there are unaccounted for relationships in data set or
## if there is confounding effect of time or space
durbinWatsonTest(eDNA.spp.regression)

## No significant serial auto-correlation as p-value not significant
## Use graphical approach with Auto-Correlation Function (ACF)
acf(sresid, main = "Auto-correlation plot")
## Some autocorrelation at first time lag

## Assumption 5: model not biased by unduly influential observations
influence <- influence.measures(eDNA.spp.regression)
summary(influence)
CD <- cooks.distance(eDNA.spp.regression)
plot(CD ~ sresid)

## Cook's distance < 1 so observations not exerting strong influence on model
## parameters

## Model finds no significant effect of crucian carp on alpha diversity
## NB: other indexes of alpha diversity, such as Fishers Alpha and Shannon
## diversity, could not be used as they take abundance into account.
## We do not know whether sequencing data accurately reflects specimen
## abundance, thus we treat all data as presence-absence.

## Was sample size enough to accurately represent macroinvertebrate
## diversity?
## Plot species accumulation curve across ponds
plot(specaccum(eDNA.df), 
     xlab = "Number of ponds", 
     ylab = "Number of species",
     ci.type="polygon", ci.col="grey")

## More ponds would have been required to fully represent macroinvertebrate
## diversity.


#'
#' ## Beta diversity
#' 

## Now look at beta diversity in crucian and non-crucian ponds.
## The beta.pair() function computes three dissimilarity metrics and uses 
## the argument index.family to calculate beta diversity according to 
## Sorensen or Jaccard index of total dissimilarity. The function returns 
## three matrices containing the pairwise between-site values of each 
## component of beta diversity (turnover, nestedness, total beta). The 
## dissimilarity matrices yielded by beta.pair are objects of class dist 
## and can be used for further analyses, e.g. NMDS, cluster analysis.
## (NB: Jaccard index is used to calculate beta diversity from 
## presence-absence data. Abundance data would use Bray-curtis 
## dissimilarity)

## Beta diversity across all ponds
eDNA.multi <- beta.multi(eDNA.spp.pa, index.family="jaccard")
print(eDNA.multi)

## The majority of total beta diversity arises from species turnover
## rather than nestedness.

## Sampling across equal sites
eDNA.samp <- beta.sample(eDNA.spp.pa, 
                         index.family="jaccard",
                         sites=8,                # minimum no. of sites in a group
                         samples=100)

## Plotting the distributions of components
dist.eDNA.samp <- eDNA.samp$sampled.values
plot(density(dist.eDNA.samp$beta.JAC),xlim=c(0,1), ylim=c(0,100), 
     xlab='Beta diversity', main='', lwd=3)
lines(density(dist.eDNA.samp$beta.JAC), lty=1, lwd=2)
lines(density(dist.eDNA.samp$beta.JNE), lty=1, lwd=2)
lines(density(dist.eDNA.samp$beta.JTU), lty=2, lwd=2)

## Pairwise between-site values of each component of beta diversity
eDNA.dist <- beta.pair(eDNA.spp.pa, index.family="jaccard")

## 1. TURNOVER PARTITION (COMPLETE CHANGE IN COMMUNITIES)
eDNA.bd.turn <- betadisper(eDNA.dist$beta.jtu, metadata$Crucian)

## Check homogeneity of multivariate dispersions. Groups being tested should 
## have the sample multivariate spread to conform to assumptions of PERMANOVA
mod.turn <- with(metadata, eDNA.bd.turn)
mod.turn

## Compute mean distance to centroid per group
tapply(eDNA.bd.turn$distances, metadata$Crucian, mean)

## Compute variance per group
tapply(eDNA.bd.turn$distances, metadata$Crucian, var)

## Ordination plot of turnover partition
plot(eDNA.bd.turn)

## Boxplot of turnover partition
boxplot(eDNA.bd.turn, xlab="Crucian carp", xaxt="n", bty="n")
axis(side=1, at=c(1,2), labels=c("Absent","Present"))

## Plots indicate that there is substantial difference in turnover partition
## of beta diversity between crucian and non-crucian ponds. 
## Statistically check whether turnover is different in crucian and
## non-crucian ponds using standard parametric anova or permutation
## tests.
anova(eDNA.bd.turn)     # No significant difference between ponds
permutest(eDNA.bd.turn) # No significant difference between ponds

## Analyse pairwise differences between groups (crucian/non-crucian) using 
## parametric Tukey's HSD test.
TukeyHSD(eDNA.bd.turn)  # No significant difference between groups

## Ordination of beta diversity partitioned by turnover:
## The metaMDS function automatically transforms data and checks solution
## robustness
eDNA.comm.turn <- metaMDS(eDNA.dist$beta.jtu, dist = "jaccard")

## Assess goodness of ordination fit (stress plot)
stressplot(eDNA.comm.turn)

## plot site scores as text
ordiplot(eDNA.comm.turn, display = "sites", type = "text")

## Build data frame with NMDS coordinates and metadata
eDNA.NMDS1 <- eDNA.comm.turn$points[,1]
eDNA.NMDS2 <- eDNA.comm.turn$points[,2]
eDNA.turn.NMDS <- data.frame(NMDS1=eDNA.NMDS1, 
                             NMDS2=eDNA.NMDS2,
                             Crucian = metadata$Crucian)

## Check data
head(eDNA.turn.NMDS)

## Plot data frame
p2g <- ggplot(eDNA.turn.NMDS, aes(x=NMDS1, y=NMDS2, colour=Crucian))
p2g <- p2g + geom_point() + stat_ellipse()
p2g <- p2g + labs(subtitle="(iii) eDNA metabarcoding", x="", y="NMDS2")
p2g <- p2g + coord_cartesian(xlim=c(-1,1), ylim=c(-1,1))
p2g <- p2g + scale_colour_manual(name="Crucian carp",
                                 breaks=c("N","Y"),
                                 labels=c("Absent","Present"),
                                 values=c("grey40","deepskyblue2"))
p2g <- p2g + theme(panel.background = element_rect(fill = 'white'),
                   axis.line.x = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.line.y = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.title.x = element_text(margin = unit(c(8, 0, 0, 0), "mm")),
                   axis.title.y = element_text(margin = unit(c(0, 5, 0, 0), "mm")),
                   axis.text.x = element_text(colour="black"),
                   axis.text.y = element_text(colour="black"),
                   plot.title = element_text(face="bold", hjust=0, colour="black"),
                   plot.subtitle = element_text(face="bold", hjust=0, colour="black", margin = unit(c(2, 0, 0, 0), "mm")),
                   text = element_text(size=20),
                   legend.position="none")
p2g

## Statistically check difference in spatial turnover of communities
eDNA.turn.anosim <- anosim(eDNA.dist$beta.jtu, metadata$Crucian)

## Inspect results
eDNA.turn.anosim
summary(eDNA.turn.anosim)
plot(eDNA.turn.anosim)

## There appears to be a significant difference in spatial turnover
## Look at PermANOVA using adonis(), considered more robust than anosim()
eDNA.turn.adonis <- adonis(eDNA.dist$beta.jtu ~ Crucian, metadata)

## Inspect results
## no summary() or plot() methods included
eDNA.turn.adonis

## Again result is significant. eDNA metabarcoding indicates there is a 
## substantial difference in species replacement (i.e. turnover) between
## ponds with crucian carp and ponds without crucian carp. Therefore,
## species in ponds with no fish are substituted by species in ponds
## with crucian carp.


## 2. NESTEDNESS PARTITION (SUBSET OF CHANGE IN WIDER COMMUNITY)
eDNA.bd.nest <- betadisper(eDNA.dist$beta.jne, metadata$Crucian)

## Check homogeneity of multivariate dispersions. Groups being tested should 
## have the sample multivariate spread to conform to assumptions of PERMANOVA
eDNA.nest <- with(metadata, eDNA.bd.nest)
eDNA.nest

## Compute mean distance to centroid per group
tapply(eDNA.bd.nest$distances, metadata$Crucian, mean)

## Compute variance per group
tapply(eDNA.bd.nest$distances, metadata$Crucian, var)

## Ordination plot of turnover partition
plot(eDNA.bd.nest)

## Boxplot of turnover partition
boxplot(eDNA.bd.nest, xlab="Crucian carp", xaxt="n", bty="n")
axis(side=1, at=c(1,2), labels=c("Absent","Present"))

## Plots indicates that there is no difference in nestedness partition
## of beta diversity between crucian and non-crucian ponds. 
## Statistically check whether nestedness is different in crucian and
## non-crucian ponds using standard parametric anova or permutation
## tests.
anova(eDNA.bd.nest)     # No significant difference between ponds
permutest(eDNA.bd.nest) # No significant difference between ponds

## Analyse pairwise differences between groups using parametric Tukey's HSD 
## test.
TukeyHSD(eDNA.bd.nest)  # No significant difference between ponds

## Ordination of beta diversity partitioned by nestedness:
eDNA.comm.nest <- metaMDS(eDNA.dist$beta.jne, dist = "jaccard")

## Assess goodness of ordination fit (stress plot)
stressplot(eDNA.comm.nest)

## plot site scores as text
ordiplot(eDNA.comm.nest, display = "sites", type = "text")

## Build data frame with NMDS coordinates and metadata
eDNA.NMDS1 <- eDNA.comm.nest$points[,1]
eDNA.NMDS2 <- eDNA.comm.nest$points[,2]
eDNA.nest.NMDS <- data.frame(NMDS1=eDNA.NMDS1, 
                             NMDS2=eDNA.NMDS2,
                             Crucian = metadata$Crucian)

## Check data
head(eDNA.nest.NMDS)

## Plot data frame
p2h <- ggplot(eDNA.nest.NMDS, aes(x=NMDS1, y=NMDS2, colour=Crucian))
p2h <- p2h + geom_point() + stat_ellipse()
p2h <- p2h + labs(subtitle="", x="", y="")
p2h <- p2h + coord_cartesian(xlim=c(-1,1), ylim=c(-1,1))
p2h <- p2h + scale_colour_manual(name="Crucian carp",
                                 breaks=c("N","Y"),
                                 labels=c("Absent","Present"),
                                 values=c("grey40","deepskyblue2"))
p2h <- p2h + theme(panel.background = element_rect(fill = 'white'),
                   axis.line.x = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.line.y = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.title.x = element_text(margin = unit(c(8, 0, 0, 0), "mm")),
                   axis.title.y = element_text(margin = unit(c(0, 5, 0, 0), "mm")),
                   axis.text.x = element_text(colour="black"),
                   axis.text.y = element_text(colour="black"),
                   plot.title = element_text(face="bold", hjust=0, colour="black"),
                   plot.subtitle = element_text(face="bold", hjust=0, colour="black", margin = unit(c(2, 0, 0, 0), "mm")),
                   text = element_text(size=20),
                   legend.position="none")
p2h

## Statistically check difference in nestedness of communities
eDNA.nest.anosim <- anosim(eDNA.dist$beta.jne, metadata$Crucian)

## Inspect results
eDNA.nest.anosim
summary(eDNA.nest.anosim)
plot(eDNA.nest.anosim)

## There appears to be no significant difference in nestedness
## Look at PermANOVA using adonis(), considered more robust than anosim()
eDNA.nest.adonis <- adonis(eDNA.dist$beta.jne ~ Crucian, metadata)

## Inspect results
## no summary() or plot() methods included
eDNA.nest.adonis

## Result is not significant. eDNA metabarcoding indicates there is no 
## substantial difference in species loss or gain (i.e. nestedness) 
## between ponds with crucian carp and ponds without crucian carp.


## 3. TOTAL BETA DIVERSITY
eDNA.bd.total <- betadisper(eDNA.dist$beta.jac, metadata$Crucian)

## Check homogeneity of multivariate dispersions. Groups being tested should 
## have the sample multivariate spread to conform to assumptions of PERMANOVA
mod.total <- with(metadata, eDNA.bd.total)
mod.total

## Compute mean distance to centroid per group
tapply(eDNA.bd.total$distances, metadata$Crucian, mean)

## Compute variance per group
tapply(eDNA.bd.total$distances, metadata$Crucian, var)

## Ordination plot of total beta diversity
plot(eDNA.bd.total)

## Boxplot of total beta diversity
boxplot(eDNA.bd.total, xlab="Crucian carp", xaxt="n", bty="n")
axis(side=1, at=c(1,2), labels=c("Absent","Present"))

## Plots indicates that there is substantial difference in total beta diversity 
## between crucian and non-crucian ponds. 
## Statistically check whether total beta is different in crucian and
## non-crucian ponds using standard parametric anova or permutation
## tests.
anova(eDNA.bd.total)     # Significant difference between ponds
permutest(eDNA.bd.total) # Significant difference between ponds

## Analyse pairwise differences between groups using parametric Tukey's 
## HSD test.
TukeyHSD(eDNA.bd.total)  # Significant difference between ponds

## Ordination of total beta diversity:
## The metaMDS function automatically transforms data and checks solution
## robustness
eDNA.comm.total <- metaMDS(eDNA.dist$beta.jac, dist = "jaccard")

## Assess goodness of ordination fit (stress plot)
stressplot(eDNA.comm.total)

## plot site scores as text
ordiplot(eDNA.comm.total, display = "sites", type = "text")

## Build data frame with NMDS coordinates and metadata
eDNA.NMDS1 <- eDNA.comm.total$points[,1]
eDNA.NMDS2 <- eDNA.comm.total$points[,2]
eDNA.total.NMDS <- data.frame(NMDS1=eDNA.NMDS1,
                              NMDS2=eDNA.NMDS2,
                              Crucian = metadata$Crucian)

## Check data
head(eDNA.total.NMDS)

## Plot data frame
p2i <- ggplot(eDNA.total.NMDS, aes(x=NMDS1, y=NMDS2, colour=Crucian)) 
p2i <- p2i + geom_point() + stat_ellipse()
p2i <- p2i + labs(subtitle="", x="", y="")
p2i <- p2i + coord_cartesian(xlim=c(-1,1), ylim=c(-1,1))
p2i <- p2i + scale_colour_manual(name="Crucian carp",
                                 breaks=c("N","Y"),
                                 labels=c("Absent","Present"),
                                 values=c("grey40","deepskyblue2"))
p2i <- p2i + theme(panel.background = element_rect(fill = 'white'),
                   axis.line.x = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.line.y = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.title.x = element_text(margin = unit(c(8, 0, 0, 0), "mm")),
                   axis.title.y = element_text(margin = unit(c(0, 5, 0, 0), "mm")),
                   axis.text.x = element_text(colour="black"),
                   axis.text.y = element_text(colour="black"),
                   plot.title = element_text(face="bold", hjust=0, colour="black"),
                   plot.subtitle = element_text(face="bold", hjust=0, colour="black", margin = unit(c(2, 0, 0, 0), "mm")),
                   text = element_text(size=20),
                   legend.position="none")
p2i

## Statistically check difference in total beta diversity of ponds
eDNA.total.anosim <- anosim(eDNA.dist$beta.jac, metadata$Crucian)

## Inspect results
eDNA.total.anosim
summary(eDNA.total.anosim)
plot(eDNA.total.anosim)

## There appears to be a significant difference in total beta diversity
## Look at PermANOVA using adonis(), considered more robust than anosim()
eDNA.total.adonis <- adonis(eDNA.dist$beta.jac ~ Crucian, metadata)

## Inspect results
## no summary() or plot() methods included
eDNA.total.adonis

## Again result is significant. DNA metabarcoding indicates there is 
## substantial variation in overall species composition of
## ponds with crucian carp and ponds without crucian carp

## Further exploration of total beta diversity
## Create matrix from total beta diversity dist object
eDNA.beta.temp <- as.matrix(eDNA.dist$beta.jac)
eDNA.beta.temp
eDNA.beta.temp2 <- t(combn(colnames(eDNA.beta.temp),2))
eDNA.beta <- data.frame(eDNA.beta.temp2, dist=eDNA.beta.temp[eDNA.beta.temp2])
colnames(eDNA.beta) <- c("Pond1","Pond2","Jaccard")

## Loop over jaccard data frame and create new column saying what type of 
## combination we have
eDNA.beta$Combo <- factor(ifelse(eDNA.beta$Pond1%in%crucian&eDNA.beta$Pond2%in%crucian,"crucian-crucian",
                                ifelse(eDNA.beta$Pond1%in%crucian&eDNA.beta$Pond2%in%non_crucian,"crucian-no crucian",
                                       ifelse(eDNA.beta$Pond1%in%non_crucian&eDNA.beta$Pond2%in%crucian,"crucian-no crucian",
                                              ifelse(eDNA.beta$Pond2%in%non_crucian&eDNA.beta$Pond2%in%non_crucian,"no crucian-no crucian",
                                                     "Fail")))))

## Regression examining whether Jaccard distance is influenced by site 
## combinations
eDNA.beta.regression <- aov(Jaccard ~ Combo, data=eDNA.beta)
summary(eDNA.beta.regression)
anova(eDNA.beta.regression)

## Tukey post-hoc test examining difference between groups
TukeyHSD(eDNA.beta.regression, ordered = TRUE)

## Plot of jaccard distance across groups
p3c <- ggplot(eDNA.beta, aes(x=Combo, y=Jaccard))
p3c <- p3c + ggtitle("(c) eDNA")
p3c <- p3c + geom_jitter(aes(colour=Combo), width=0.2)
p3c <- p3c + geom_boxplot(alpha=0.7, outlier.colour="red") 
p3c <- p3c + scale_y_continuous(limits=c(0,1))
p3c <- p3c + scale_colour_manual(values=c("deepskyblue2","limegreen","goldenrod1"))
p3c <- p3c + annotate("text", 
                      x = c("crucian-crucian",
                            "crucian-no crucian",
                            "no crucian-no crucian"), 
                      y = 0.5, 
                      label = c("a","a","b"), cex=10)
p3c <- p3c + labs(x="Combination", y="Jaccard dissimilarity")
p3c <- p3c + theme(panel.background = element_rect(fill = "white"), 
                   axis.line.x = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.line.y = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.title.x = element_text(margin = unit(c(8, 0, 0, 0), "mm")),
                   axis.title.y = element_text(margin = unit(c(0, 5, 0, 0), "mm")),
                   axis.text.x = element_text(colour="black"),
                   axis.text.y = element_text(colour="black"),
                   plot.title = element_text(face="bold"),
                   text = element_text(size=20),
                   legend.position = "none")
p3c

## A useful way to examine this result is to build a "tree" from it. 
## Here, a tree (actually a dendrogram) is a way to cluster the sites 
## together based on how "far apart" they are in species composition; 
## sites which have very similar species compositions will group together 
## on the tree.
## Three methods of clustering but 'average' linkage method (based on the 
## average dissimilarity between groups of sites) usually most robust:
jacc.cla <- hclust(eDNA.dist$beta.jac, method="average")
jacc.cls <- hclust(eDNA.dist$beta.jac, method="single")
jacc.clc <- hclust(eDNA.dist$beta.jac, method="complete")

## Display the classification trees for these methods and notice how the 
## shape of the trees changes.
plot(jacc.cla)
plot(jacc.cls)
plot(jacc.clc)

## Measure the correlation between your original dissimilarity matrix and 
## the inter-group dissimilarity at each step up the classification tree 
## via the cophenetic function:
cor(eDNA.dist$beta.jac, cophenetic(jacc.cla))
cor(eDNA.dist$beta.jac, cophenetic(jacc.cls))
cor(eDNA.dist$beta.jac, cophenetic(jacc.clc))

## Average linkage method appears to have strongest correlation
## Plot dendrogram of site Jaccard dissimilarity
plot(jacc.cla, hang = -1,
     main = "Sites clustered by Jaccard similarity",
     axes = FALSE, ylab = "")


#' 
#' eDNA metabarcoding indicates that there is no difference in alpha diversity,
#' but there is a difference in beta diversity of ponds with or without crucian 
#' carp, with respect to species turnover.
#' 
#' Are these patterns observed at family level?
#' 


#'
#' ### Family level analysis
#' 

## Import refined family data from DNA metabarcoding
eDNA.fam <- read.csv("../Data/eDNA_metabarcoding_site_by_family.csv", 
                     row.names=1, header=TRUE)
summary(eDNA.fam)
head(eDNA.fam)
names(eDNA.fam)
str(eDNA.fam)

## Remove empty taxonomic assignments as these are problematic for vegan
eDNA.fam <- eDNA.fam[!sapply(eDNA.fam, function(x) all(x == 0))]


#' 
#' Basic summaries
#' 

## Total number of sequences per pond
sum.of.rows <- apply(eDNA.fam, 1, sum)
sort(sum.of.rows, decreasing = TRUE) 
sum(sum.of.rows)


## Total number of sequences per species across all sites
sum.of.columns <- apply(eDNA.fam, 2, sum)

## Actual read counts:
sort(sum.of.columns, decreasing = TRUE)
sum(sum.of.columns)

## Proportional read counts:
sort(round(sum.of.columns/sum(sum.of.columns)*100, 2), decreasing = TRUE)


## Number of ponds where each species occurs
eDNA.fam.pres <- apply(eDNA.fam > 0, 2, sum) 
sort(eDNA.fam.pres, decreasing = TRUE)



#'
#' ## Data transformation
#' 
#' From now on, all data exploration and analyses will take place in the 
#' vegan package.
#' 

## Tranform data
eDNA.fam.pa <- decostand(eDNA.fam, method = "pa", MARGIN = 1) # by rows (ponds)
head(eDNA.fam.pa[,1:3], n = 3)


#'
#' ## Alpha diversity
#' 

## Basic richness
eDNA.fam.richness <- specnumber(eDNA.fam.pa)
eDNA.fam.richness

## Plot alpha diversity
## Create data frame
eDNA.fam.alpha <- data.frame(eDNA.fam.richness)

## add metadata from external file
eDNA.fam.alpha <- cbind(metadata[,1:2], eDNA.fam.alpha)

## Reset row names of data frame for further indexing
rownames(eDNA.fam.alpha) <- NULL

## Plot species richness
p1f <- ggplot(eDNA.fam.alpha, aes(x=Crucian, y=eDNA.fam.richness))
p1f <- p1f + geom_jitter(aes(colour=Crucian), cex=2, width=0.2, show.legend=FALSE)
p1f <- p1f + geom_boxplot(alpha=0.7, outlier.shape = NA)
p1f <- p1f + scale_y_continuous(limits=c(0,100))
p1f <- p1f + labs(subtitle="",x="", y="")
p1f <- p1f + scale_colour_manual(values=c("grey40","deepskyblue2"))
p1f <- p1f + scale_x_discrete(breaks=c("N","Y"),
                              labels=c("Absent","Present"))
p1f <- p1f + theme(panel.background = element_rect(fill = 'white'),
                   axis.line.x = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.line.y = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.title.x = element_text(margin = unit(c(8, 0, 0, 0), "mm")),
                   axis.title.y = element_text(margin = unit(c(0, 5, 0, 0), "mm")),
                   axis.text.x = element_text(colour="black"),
                   axis.text.y = element_text(colour="black"),
                   plot.title = element_text(face="bold", hjust=0, colour="black"),
                   plot.subtitle = element_text(face="bold", hjust=0, colour="black", margin = unit(c(2, 0, 0, 0), "mm")),
                   legend.position = "none",
                   text = element_text(size=20))
p1f

## Plot ordered richness
make.sorted.plot <- function(x){
  ordered <- sort(x, T)
  plot(
    ordered,
    col = terrain.colors(10),
    xaxt = "n", pch = 16, cex = 2,
    ylim = c(min(ordered)*0.5, max(ordered)),
    xlim = c(0, length(x)+1),
    ylab = "Diversity measure", xlab = "Sites",
    main = substitute(x))
  text(ordered,
       names(ordered),
       srt = -75,
       pos = 4)
}
make.sorted.plot(eDNA.fam.richness)

## Species richness does not appear higher in ponds without crucian
## carp, indicating this species may have a negligible impact on the 
## macroinvertebrate community.
## Statistical comparison:
eDNA.fam.regression <- glm.nb(eDNA.fam.richness ~ Crucian, data=eDNA.fam.alpha)
summary(eDNA.fam.regression)
anova(eDNA.fam.regression, test = "Chi")
drop1(eDNA.fam.regression, test = "Chi")
summary(glht(glm.nb(eDNA.fam.richness ~ Crucian, data=eDNA.fam.alpha), 
             linfct=mcp(Crucian="Tukey")))

## Check model meets GLM assumptions
## Test for overdispersion
18.807/16
1-pchisq(18.807, df=16)  # not overdispersed

## Plot the fitted data against the observed data
plot(eDNA.fam.alpha$eDNA.fam.richness ~ fitted(eDNA.fam.regression))

## Hosmer and Lemeshow Goodness of Fit Test
hoslem.test(eDNA.fam.alpha$eDNA.fam.richness, fitted(eDNA.fam.regression))

## Model supposedly fits well as p-value is not significant 
## i.e. no significant difference between the model and the observed data

## Perform model validation checks to ensure model is good fit to data and 
## making reliable predictions
## Assumption 1: residuals are normally distributed
sresid <- resid(eDNA.fam.regression, type = "pearson")
hist(sresid)
lines(density(sresid,adjust=1))
qqnorm(sresid, cex=1.8, pch=20)
qqline(sresid, lty=2, lwd=2)
chkres(eDNA.fam.regression)
shapiro.test(sresid) # P = 0.5825

## No deviation from normality as residuals are normally distributed
## therefore model is reliable.

## Assumption 2: no heteroscedascity
## Plot standardised residuals against each independent variable to 
## identify any source of heterogeneity i.e. independent variable that is 
## non-linearly associated with y
plot(sresid ~ eDNA.fam.regression$fitted.values, pch=20, cex=2, cex.lab=1.5)
plot(sresid ~ eDNA.fam.alpha$Crucian, pch=20, cex=2, cex.lab=1.5) # No heteroscedascity

## Assumption 3: no collinearity
## Only one variable being modelled so no collinearity present.

## Assumption 4: no serial auto-correlation
## can arise if there are unaccounted for relationships in data set or
## if there is confounding effect of time or space
durbinWatsonTest(eDNA.fam.regression)

## No significant serial auto-correlation as p-value not significant
## Use graphical approach with Auto-Correlation Function (ACF)
acf(sresid, main = "Auto-correlation plot")
## Some autocorrelation at first time lag

## Assumption 5: model not biased by unduly influential observations
influence <- influence.measures(eDNA.fam.regression)
summary(influence)
CD <- cooks.distance(eDNA.fam.regression)
plot(CD ~ sresid)

## Cook's distance < 1 so observations not exerting strong influence on model
## parameters

## Model finds no significant effect of crucian carp on alpha diversity
## NB: other indexes of alpha diversity, such as Fishers Alpha and Shannon
## diversity, could not be used as they take abundance into account.
## We do not know whether sequencing data accurately reflects specimen
## abundance, thus we treat all data as presence-absence.

## Was sample size enough to accurately represent macroinvertebrate
## diversity?
## Plot species accumulation curve across ponds
plot(specaccum(eDNA.fam), 
     xlab = "Number of ponds", 
     ylab = "Number of species",
     ci.type="polygon", ci.col="grey")

## More ponds would have been required to fully represent macroinvertebrate
## diversity.


#'
#' ## Beta diversity
#' 

## Now look at beta diversity in crucian and non-crucian ponds.
## The beta.pair() function computes three dissimilarity metrics and uses 
## the argument index.family to calculate beta diversity according to 
## Sorensen or Jaccard index of total dissimilarity. The function returns 
## three matrices containing the pairwise between-site values of each 
## component of beta diversity (turnover, nestedness, total beta). The 
## dissimilarity matrices yielded by beta.pair are objects of class dist 
## and can be used for further analyses, e.g. NMDS, cluster analysis.
## (NB: Jaccard index is used to calculate beta diversity from 
## presence-absence data. Abundance data would use Bray-curtis 
## dissimilarity)

## Beta diversity across all ponds
eDNA.fam.multi <- beta.multi(eDNA.fam.pa, index.family="jaccard")
print(eDNA.fam.multi)

## The majority of total beta diversity arises from species turnover
## rather than nestedness.

## Sampling across equal sites
eDNA.fam.samp <- beta.sample(eDNA.fam.pa, 
                             index.family="jaccard",
                             sites=8,                # minimum no. of sites in a group
                             samples=100)

## Plotting the distributions of components
dist.eDNA.samp <- eDNA.fam.samp$sampled.values
plot(density(dist.eDNA.samp$beta.JAC),xlim=c(0,1), ylim=c(0,100), 
     xlab='Beta diversity', main='', lwd=3)
lines(density(dist.eDNA.samp$beta.JAC), lty=1, lwd=2)
lines(density(dist.eDNA.samp$beta.JNE), lty=1, lwd=2)
lines(density(dist.eDNA.samp$beta.JTU), lty=2, lwd=2)

## Pairwise between-site values of each component of beta diversity
eDNA.fam.dist <- beta.pair(eDNA.fam.pa, index.family="jaccard")

## 1. TURNOVER PARTITION (COMPLETE CHANGE IN COMMUNITIES)
eDNA.fam.bd.turn <- betadisper(eDNA.fam.dist$beta.jtu, metadata$Crucian)

## Check homogeneity of multivariate dispersions. Groups being tested should 
## have the sample multivariate spread to conform to assumptions of PERMANOVA
mod.turn <- with(metadata, eDNA.fam.bd.turn)
mod.turn

## Compute mean distance to centroid per group
tapply(eDNA.fam.bd.turn$distances, metadata$Crucian, mean)

## Compute variance per group
tapply(eDNA.fam.bd.turn$distances, metadata$Crucian, var)

## Ordination plot of turnover partition
plot(eDNA.fam.bd.turn)

## Boxplot of turnover partition
boxplot(eDNA.fam.bd.turn, xlab="Crucian carp", xaxt="n", bty="n")
axis(side=1, at=c(1,2), labels=c("Absent","Present"))

## Plots indicate that there is no real difference in turnover partition
## of beta diversity between crucian and non-crucian ponds. 
## Statistically check whether turnover is different in crucian and
## non-crucian ponds using standard parametric anova or permutation
## tests.
anova(eDNA.fam.bd.turn)     # No significant difference between ponds
permutest(eDNA.fam.bd.turn) # No significant difference between ponds

## Analyse pairwise differences between groups (crucian/non-crucian) using 
## parametric Tukey's HSD test.
TukeyHSD(eDNA.fam.bd.turn)  # No significant difference between groups

## Ordination of beta diversity partitioned by turnover:
## The metaMDS function automatically transforms data and checks solution
## robustness
eDNA.fam.comm.turn <- metaMDS(eDNA.fam.dist$beta.jtu, dist = "jaccard")

## Assess goodness of ordination fit (stress plot)
stressplot(eDNA.fam.comm.turn)

## plot site scores as text
ordiplot(eDNA.fam.comm.turn, display = "sites", type = "text")

## Build data frame with NMDS coordinates and metadata
eDNA.NMDS1 <- eDNA.fam.comm.turn$points[,1]
eDNA.NMDS2 <- eDNA.fam.comm.turn$points[,2]
eDNA.fam.turn.NMDS <- data.frame(NMDS1=DNA.NMDS1, 
                                 NMDS2=DNA.NMDS2,
                                 Crucian = metadata$Crucian)

## Check data
head(eDNA.fam.turn.NMDS)

## Plot data frame
p4g <- ggplot(eDNA.fam.turn.NMDS, aes(x=NMDS1, y=NMDS2, colour=Crucian))
p4g <- p4g + geom_point() + stat_ellipse()
p4g <- p4g + labs(subtitle="(iii) eDNA metabarcoding", x="", y="NMDS2")
p4g <- p4g + coord_cartesian(xlim=c(-1,1), ylim=c(-1,1))
p4g <- p4g + scale_colour_manual(name="Crucian carp",
                                 breaks=c("N","Y"),
                                 labels=c("Absent","Present"),
                                 values=c("grey40","deepskyblue2"))
p4g <- p4g + theme(panel.background = element_rect(fill = 'white'),
                   axis.line.x = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.line.y = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.title.x = element_text(margin = unit(c(8, 0, 0, 0), "mm")),
                   axis.title.y = element_text(margin = unit(c(0, 5, 0, 0), "mm")),
                   axis.text.x = element_text(colour="black"),
                   axis.text.y = element_text(colour="black"),
                   plot.title = element_text(face="bold", hjust=0, colour="black"),
                   plot.subtitle = element_text(face="bold", hjust=0, colour="black", margin = unit(c(2, 0, 0, 0), "mm")),
                   text = element_text(size=20),
                   legend.position="none")
p4g

## Statistically check difference in spatial turnover of communities
eDNA.fam.turn.anosim <- anosim(eDNA.fam.dist$beta.jtu, metadata$Crucian)

## Inspect results
eDNA.fam.turn.anosim
summary(eDNA.fam.turn.anosim)
plot(eDNA.fam.turn.anosim)

## There appears to be a significant difference in spatial turnover
## Look at PermANOVA using adonis(), considered more robust than anosim()
eDNA.fam.turn.adonis <- adonis(eDNA.fam.dist$beta.jtu ~ Crucian, metadata)

## Inspect results
## no summary() or plot() methods included
eDNA.fam.turn.adonis

## Result is borderline significant. eDNA metabarcoding indicates there is
## some difference in species replacement (i.e. turnover) between
## ponds with crucian carp and ponds without crucian carp. Therefore,
## species in ponds with no fish are substituted by species in ponds
## with crucian carp.


## 2. NESTEDNESS PARTITION (SUBSET OF CHANGE IN WIDER COMMUNITY)
eDNA.fam.bd.nest <- betadisper(eDNA.fam.dist$beta.jne, metadata$Crucian)

## Check homogeneity of multivariate dispersions. Groups being tested should 
## have the sample multivariate spread to conform to assumptions of PERMANOVA
eDNA.fam.nest <- with(metadata, eDNA.fam.bd.nest)
eDNA.fam.nest

## Compute mean distance to centroid per group
tapply(eDNA.fam.bd.nest$distances, metadata$Crucian, mean)

## Compute variance per group
tapply(eDNA.fam.bd.nest$distances, metadata$Crucian, var)

## Ordination plot of turnover partition
plot(eDNA.fam.bd.nest)

## Boxplot of turnover partition
boxplot(eDNA.fam.bd.nest, xlab="Crucian carp", xaxt="n", bty="n")
axis(side=1, at=c(1,2), labels=c("Absent","Present"))

## Plots indicates that there is slight difference in nestedness partition
## of beta diversity between crucian and non-crucian ponds. 
## Statistically check whether nestedness is different in crucian and
## non-crucian ponds using standard parametric anova or permutation
## tests.
anova(eDNA.fam.bd.nest)     # No significant difference between ponds
permutest(eDNA.fam.bd.nest) # No significant difference between ponds

## Analyse pairwise differences between groups using parametric Tukey's HSD 
## test.
TukeyHSD(eDNA.fam.bd.nest)  # No significant difference between ponds

## Ordination of beta diversity partitioned by nestedness:
eDNA.fam.comm.nest <- metaMDS(eDNA.fam.dist$beta.jne, dist = "jaccard")

## Assess goodness of ordination fit (stress plot)
stressplot(eDNA.fam.comm.nest)

## plot site scores as text
ordiplot(eDNA.fam.comm.nest, display = "sites", type = "text")

## Build data frame with NMDS coordinates and metadata
eDNA.NMDS1 <- eDNA.fam.comm.nest$points[,1]
eDNA.NMDS2 <- eDNA.fam.comm.nest$points[,2]
eDNA.fam.nest.NMDS <- data.frame(NMDS1=eDNA.NMDS1, 
                                 NMDS2=eDNA.NMDS2,
                                 Crucian = metadata$Crucian)

## Check data
head(eDNA.fam.nest.NMDS)

## Plot data frame
p4h <- ggplot(eDNA.fam.nest.NMDS, aes(x=NMDS1, y=NMDS2, colour=Crucian))
p4h <- p4h + geom_point() + stat_ellipse()
p4h <- p4h + labs(subtitle="", x="", y="")
p4h <- p4h + coord_cartesian(xlim=c(-1,1), ylim=c(-1,1))
p4h <- p4h + scale_colour_manual(name="Crucian carp",
                                 breaks=c("N","Y"),
                                 labels=c("Absent","Present"),
                                 values=c("grey40","deepskyblue2"))
p4h <- p4h + theme(panel.background = element_rect(fill = 'white'),
                   axis.line.x = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.line.y = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.title.x = element_text(margin = unit(c(8, 0, 0, 0), "mm")),
                   axis.title.y = element_text(margin = unit(c(0, 5, 0, 0), "mm")),
                   axis.text.x = element_text(colour="black"),
                   axis.text.y = element_text(colour="black"),
                   plot.title = element_text(face="bold", hjust=0, colour="black"),
                   plot.subtitle = element_text(face="bold", hjust=0, colour="black", margin = unit(c(2, 0, 0, 0), "mm")),
                   text = element_text(size=20),
                   legend.position="none")
p4h

## Statistically check difference in nestedness of communities
eDNA.fam.nest.anosim <- anosim(eDNA.fam.dist$beta.jne, metadata$Crucian)

## Inspect results
eDNA.fam.nest.anosim
summary(eDNA.fam.nest.anosim)
plot(eDNA.fam.nest.anosim)

## There appears to be no significant difference in nestedness
## Look at PermANOVA using adonis(), considered more robust than anosim()
eDNA.fam.nest.adonis <- adonis(eDNA.fam.dist$beta.jne ~ Crucian, metadata)

## Inspect results
## no summary() or plot() methods included
eDNA.fam.nest.adonis

## Again result is not significant. DNA metabarcoding indicates there is no 
## substantial difference in species loss or gain (i.e. nestedness) 
## between ponds with crucian carp and ponds without crucian carp.


## 3. TOTAL BETA DIVERSITY
eDNA.fam.bd.total <- betadisper(eDNA.fam.dist$beta.jac, metadata$Crucian)

## Check homogeneity of multivariate dispersions. Groups being tested should 
## have the sample multivariate spread to conform to assumptions of PERMANOVA
mod.total <- with(metadata, eDNA.fam.bd.total)
mod.total

## Compute mean distance to centroid per group
tapply(eDNA.fam.bd.total$distances, metadata$Crucian, mean)

## Compute variance per group
tapply(eDNA.fam.bd.total$distances, metadata$Crucian, var)

## Ordination plot of total beta diversity
plot(eDNA.fam.bd.total)

## Boxplot of total beta diversity
boxplot(eDNA.fam.bd.total, xlab="Crucian carp", xaxt="n", bty="n")
axis(side=1, at=c(1,2), labels=c("Absent","Present"))

## Plots indicates that there is large difference in total beta diversity 
## between crucian and non-crucian ponds. 
## Statistically check whether total beta is different in crucian and
## non-crucian ponds using standard parametric anova or permutation
## tests.
anova(eDNA.fam.bd.total)     # Significant difference between ponds
permutest(eDNA.fam.bd.total) # Significant difference between ponds

## Analyse pairwise differences between groups using parametric Tukey's 
## HSD test.
TukeyHSD(eDNA.fam.bd.total)  # Significant difference between ponds

## Ordination of total beta diversity:
## The metaMDS function automatically transforms data and checks solution
## robustness
eDNA.fam.comm.total <- metaMDS(eDNA.fam.dist$beta.jac, dist = "jaccard")

## Assess goodness of ordination fit (stress plot)
stressplot(eDNA.fam.comm.total)

## plot site scores as text
ordiplot(eDNA.fam.comm.total, display = "sites", type = "text")

## Build data frame with NMDS coordinates and metadata
eDNA.NMDS1 <- eDNA.fam.comm.total$points[,1]
eDNA.NMDS2 <- eDNA.fam.comm.total$points[,2]
eDNA.fam.total.NMDS <- data.frame(NMDS1=eDNA.NMDS1,
                                  NMDS2=eDNA.NMDS2,
                                  Crucian = metadata$Crucian)

## Check data
head(eDNA.fam.total.NMDS)

## Plot data frame
p4i <- ggplot(eDNA.fam.total.NMDS, aes(x=NMDS1, y=NMDS2, colour=Crucian)) 
p4i <- p4i + geom_point() + stat_ellipse()
p4i <- p4i + labs(subtitle="", x="", y="")
p4i <- p4i + coord_cartesian(xlim=c(-1,1), ylim=c(-1,1))
p4i <- p4i + scale_colour_manual(name="Crucian carp",
                                 breaks=c("N","Y"),
                                 labels=c("Absent","Present"),
                                 values=c("grey40","deepskyblue2"))
p4i <- p4i + theme(panel.background = element_rect(fill = 'white'),
                   axis.line.x = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.line.y = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.title.x = element_text(margin = unit(c(8, 0, 0, 0), "mm")),
                   axis.title.y = element_text(margin = unit(c(0, 5, 0, 0), "mm")),
                   axis.text.x = element_text(colour="black"),
                   axis.text.y = element_text(colour="black"),
                   plot.title = element_text(face="bold", hjust=0, colour="black"),
                   plot.subtitle = element_text(face="bold", hjust=0, colour="black", margin = unit(c(2, 0, 0, 0), "mm")),
                   text = element_text(size=20),
                   legend.position="none")
p4i

## Statistically check difference in total beta diversity of ponds
eDNA.fam.total.anosim <- anosim(eDNA.fam.dist$beta.jac, metadata$Crucian)

## Inspect results
eDNA.fam.total.anosim
summary(eDNA.fam.total.anosim)
plot(eDNA.fam.total.anosim)

## There appears to be a significant difference in total beta diversity
## Look at PermANOVA using adonis(), considered more robust than anosim()
eDNA.fam.total.adonis <- adonis(eDNA.fam.dist$beta.jac ~ Crucian, metadata)

## Inspect results
## no summary() or plot() methods included
eDNA.fam.total.adonis

## Again result is significant. eDNA metabarcoding indicates there 
## is some variation in overall species composition of ponds with 
## crucian carp and ponds without crucian carp.

## Further exploration of total beta diversity
## Create matrix from total beta diversity dist object
eDNA.fam.beta.temp <- as.matrix(eDNA.dist$beta.jac)
eDNA.fam.beta.temp
eDNA.fam.beta.temp2 <- t(combn(colnames(eDNA.fam.beta.temp),2))
eDNA.fam.beta <- data.frame(eDNA.fam.beta.temp2, dist=eDNA.fam.beta.temp[eDNA.fam.beta.temp2])
colnames(eDNA.fam.beta) <- c("Pond1","Pond2","Jaccard")

## Subset data for crucian and non-crucian ponds
crucian <- subset(metadata, Crucian=="Y")
crucian$Site <- factor(crucian$Site)
non_crucian <- subset(metadata, Crucian=="N")
non_crucian$Site <- factor(non_crucian$Site)

## Make vectors of crucian and non-crucian ponds
crucian <- c(levels(crucian$Site))
non_crucian <- c(levels(non_crucian$Site))

## Loop over jaccard data frame and create new column saying what type of 
## combination we have
eDNA.fam.beta$Combo <- factor(ifelse(eDNA.fam.beta$Pond1%in%crucian&eDNA.fam.beta$Pond2%in%crucian,"crucian-crucian",
                                    ifelse(eDNA.fam.beta$Pond1%in%crucian&eDNA.fam.beta$Pond2%in%non_crucian,"crucian-no crucian",
                                           ifelse(eDNA.fam.beta$Pond1%in%non_crucian&eDNA.fam.beta$Pond2%in%crucian,"crucian-no crucian",
                                                  ifelse(eDNA.fam.beta$Pond2%in%non_crucian&eDNA.fam.beta$Pond2%in%non_crucian,"no crucian-no crucian",
                                                         "Fail")))))

## Regression examining whether Jaccard distance is influenced by site 
## combinations
eDNA.fam.beta.regression <- aov(Jaccard ~ Combo, data=eDNA.fam.beta)
summary(eDNA.fam.beta.regression)
anova(eDNA.fam.beta.regression)

## Tukey post-hoc test examining difference between groups
TukeyHSD(eDNA.fam.beta.regression, ordered = TRUE)

## Plot of jaccard distance across groups
p3f <- ggplot(DNA.fam.beta, aes(x=Combo, y=Jaccard))
p3f <- p3f + ggtitle("(c) eDNA")
p3f <- p3f + geom_jitter(aes(colour=Combo), width=0.2)
p3f <- p3f + geom_boxplot(alpha=0.7, outlier.colour="red") 
p3f <- p3f + scale_y_continuous(limits=c(0,1))
p3f <- p3f + scale_colour_manual(values=c("deepskyblue2","limegreen","goldenrod1"))
p3f <- p3f + annotate("text", 
                      x = c("crucian-crucian",
                            "crucian-no crucian",
                            "no crucian-no crucian"), 
                      y = 0.5, 
                      label = c("a","a","b"), cex=10)
p3f <- p3f + labs(x="Combination", y="Jaccard dissimilarity")
p3f <- p3f + theme(panel.background = element_rect(fill = "white"), 
                   axis.line.x = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.line.y = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.title.x = element_text(margin = unit(c(8, 0, 0, 0), "mm")),
                   axis.title.y = element_text(margin = unit(c(0, 5, 0, 0), "mm")),
                   axis.text.x = element_text(colour="black"),
                   axis.text.y = element_text(colour="black"),
                   plot.title = element_text(face="bold"),
                   text = element_text(size=20),
                   legend.position = "none")
p3f

## A useful way to examine this result is to build a "tree" from it. 
## Here, a tree (actually a dendrogram) is a way to cluster the sites 
## together based on how "far apart" they are in species composition; 
## sites which have very similar species compositions will group together 
## on the tree.
## Three methods of clustering but 'average' linkage method (based on the 
## average dissimilarity between groups of sites) usually most robust:
jacc.cla <- hclust(DNA.dist$beta.jac, method="average")
jacc.cls <- hclust(DNA.dist$beta.jac, method="single")
jacc.clc <- hclust(DNA.dist$beta.jac, method="complete")

## Display the classification trees for these methods and notice how the 
## shape of the trees changes.
plot(jacc.cla)
plot(jacc.cls)
plot(jacc.clc)

## Measure the correlation between your original dissimilarity matrix and 
## the inter-group dissimilarity at each step up the classification tree 
## via the cophenetic function:
cor(DNA.dist$beta.jac, cophenetic(jacc.cla))
cor(DNA.dist$beta.jac, cophenetic(jacc.cls))
cor(DNA.dist$beta.jac, cophenetic(jacc.clc))

## Average linkage method appears to have strongest correlation
## Plot dendrogram of site Jaccard dissimilarity
plot(jacc.cla, hang = -1,
     main = "Sites clustered by Jaccard similarity",
     axes = FALSE, ylab = "")


#'
#' What do all three methods combined tell us? 
#' 



#' ---
#'
#' 4. The full suite of monitoring tools
#'
#' Combine species inventories from all three biodiversity monitoring tools and
#' assess the impact of crucian carp on invertebrate diversity in ponds.
#' 
#' 
#' ### Species level analysis
#' 

## First, replicate all dataframes
netting <- net.df
DNA.meta <- DNA.df
eDNA.meta <- eDNA.df

## First, add columns containing pond ID, whether pond contains crucian carp,
## and which tool was used to each dataframe 
netting$Sample <- rownames(netting)
netting$Crucian <- metadata$Crucian
netting$Method <- c("Netting")
netting <- netting[,c(92:94,1:91)]
rownames(netting) <- NULL

DNA.meta$Sample <- rownames(DNA.meta)
DNA.meta$Crucian <- metadata$Crucian
DNA.meta$Method <- c("DNA")
DNA.meta <- DNA.meta[,c(142:144,1:141)]
rownames(DNA.meta) <- NULL

eDNA.meta$Sample <- rownames(eDNA.meta)
eDNA.meta$Crucian <- metadata$Crucian
eDNA.meta$Method <- c("eDNA")
eDNA.meta <- eDNA.meta[,c(161:163,1:160)]
rownames(eDNA.meta) <- NULL

## Combine data frames
comb.df <- smartbind(netting, DNA.meta, eDNA.meta)

## Replace NAs with 0s
comb.df[is.na(comb.df)] <- 0

## Take the first three columns and store in new dataframe as metadata
comb.metadata <- comb.df[,1:3]
rownames(comb.metadata) <- NULL

## Add methodology to pond ID in dataframe of assignments
comb.df <- within(comb.df, id <- paste(Sample, Method, sep="_"))
comb.df <- comb.df[,c(276,1:275)]

## Remove metadata columns and rename ID column
comb.df <- comb.df[,-c(2:4)]
colnames(comb.df)[1] <- "Sample"

## Save dataframe in current form for comparing monitoring tools later
method.df <- comb.df
rownames(method.df) <- method.df$Sample
method.df <- method.df[,-1]

## Now we can pool samples in the comb.df
## Remove methodology from sample name
comb.df$Sample <- gsub("_Netting|_DNA|_eDNA", "", comb.df$Sample)
comb.df[,2:273] <- lapply(comb.df[,2:273], function(x) as.numeric(as.character(x)))
comb.df <- ddply(comb.df, .(Sample), numcolwise(sum))

## Make Sample column row names
rownames(comb.df) <- comb.df$Sample
comb.df <- comb.df[-1]

## Remove empty taxonomic assignments
comb.df <- comb.df[!sapply(comb.df, function(x) all(x == 0))]

## Make copy of dataframe for analysing individual invertebrate orders in ponds
## with and without crucian carp later
comb.order.spp <- comb.df



#'
#' Basic summaries
#' 

## Number of ponds where each species occurs
spec.pres <- apply(comb.df > 0, 2, sum) 
sort(spec.pres, decreasing = TRUE)


#'
#' ## Data transformation
#' 
#' From now on, all data exploration and analyses will take place in the 
#' vegan package.
#' 

## Tranform data
comb.pa <- decostand(comb.df, method = "pa", MARGIN = 1) # by rows (ponds)
head(comb.pa[,1:3], n = 3)


#'
#' ## Alpha diversity
#' 

## Basic richness - two ways to calculate:
comb.richness <- specnumber(comb.pa)
comb.richness

## Plot alpha diversity
## Create data frame
comb.alpha <- data.frame(comb.richness)

## add metadata from external file
comb.alpha <- cbind(metadata[,1:2], comb.alpha)

## Reset row names of data frame for further indexing
rownames(comb.alpha) <- NULL

## Plot species richness
p1g <- ggplot(comb.alpha, aes(x=Crucian, y=comb.richness))
p1g <- p1g + geom_jitter(aes(colour=Crucian), cex=2, width=0.2, show.legend=FALSE)
p1g <- p1g + geom_boxplot(alpha=0.7, outlier.shape = NA)
p1g <- p1g + scale_y_continuous(limits=c(0,100))
p1g <- p1g + labs(subtitle="(iv) Methods combined", 
                  x="Crucian carp", y=expression(alpha~diversity))
p1g <- p1g + scale_colour_manual(values=c("grey40","deepskyblue2"))
p1g <- p1g + scale_x_discrete(breaks=c("N","Y"),
                              labels=c("Absent","Present"))
p1g <- p1g + theme(panel.background = element_rect(fill = 'white'),
                   axis.line.x = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.line.y = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.title.x = element_text(margin = unit(c(8, 0, 0, 0), "mm")),
                   axis.title.y = element_text(margin = unit(c(0, 5, 0, 0), "mm")),
                   axis.text.x = element_text(colour="black"),
                   axis.text.y = element_text(colour="black"),
                   plot.title = element_text(face="bold", hjust=0, colour="black"),
                   plot.subtitle = element_text(face="bold", hjust=0, colour="black", margin = unit(c(2, 0, 0, 0), "mm")),
                   legend.position = "none",
                   text = element_text(size=20))
p1g

## Plot ordered richness
make.sorted.plot <- function(x){
  ordered <- sort(x, T)
  plot(
    ordered,
    col = terrain.colors(10),
    xaxt = "n", pch = 16, cex = 2,
    ylim = c(min(ordered)*0.5, max(ordered)),
    xlim = c(0, length(x)+1),
    ylab = "Diversity measure", xlab = "Sites",
    main = substitute(x))
  text(ordered,
       names(ordered),
       srt = -75,
       pos = 4)
}
make.sorted.plot(comb.richness)

## Species richness appears to be the same in ponds with and without crucian
## carp, indicating this species may have negligible impact on the macroinvertebrate 
## community.
## Statistical comparison:
comb.regression <- glm.nb(comb.richness ~ Crucian, data=comb.alpha)
summary(comb.regression)
anova(comb.regression, test = "Chi")
drop1(comb.regression, test = "Chi")
summary(glht(glm.nb(comb.richness ~ Crucian, data=comb.alpha), 
             linfct=mcp(Crucian="Tukey")))

## Check model meets GLM assumptions
## Test for overdispersion
18.095/16
1-pchisq(18.095, df=16)  # not overdispersed

## Plot the fitted data against the observed data
plot(comb.alpha$comb.richness ~ fitted(comb.regression))

## Hosmer and Lemeshow Goodness of Fit Test
hoslem.test(comb.alpha$comb.richness, fitted(comb.regression))

## Model supposedly fits well as p-value is not significant 
## i.e. no significant difference between the model and the observed data

## Perform model validation checks to ensure model is good fit to data and 
## making reliable predictions
## Assumption 1: residuals are normally distributed
sresid <- resid(comb.regression, type = "pearson")
hist(sresid)
lines(density(sresid,adjust=1))
qqnorm(sresid, cex=1.8, pch=20)
qqline(sresid, lty=2, lwd=2)
chkres(comb.regression)
shapiro.test(sresid) # P = 0.5825

## No deviation from normality as residuals are normally distributed
## therefore model is reliable.

## Assumption 2: no heteroscedascity
## Plot standardised residuals against each independent variable to 
## identify any source of heterogeneity i.e. independent variable that is 
## non-linearly associated with y
plot(sresid ~ comb.regression$fitted.values, pch=20, cex=2, cex.lab=1.5)
plot(sresid ~ comb.alpha$Crucian, pch=20, cex=2, cex.lab=1.5) # No heteroscedascity

## Assumption 3: no collinearity
## Only one variable being modelled so no collinearity present.

## Assumption 4: no serial auto-correlation
## can arise if there are unaccounted for relationships in data set or
## if there is confounding effect of time or space
durbinWatsonTest(comb.regression)

## No significant serial auto-correlation as p-value not significant
## Use graphical approach with Auto-Correlation Function (ACF)
acf(sresid, main = "Auto-correlation plot")
## Some autocorrelation at first time lag

## Assumption 5: model not biased by unduly influential observations
influence <- influence.measures(comb.regression)
summary(influence)
CD <- cooks.distance(comb.regression)
plot(CD ~ sresid)

## Model finds no significant effect of crucian carp on alpha diversity
## NB: other indexes of alpha diversity, such as Fishers Alpha and Shannon
## diversity, could not be used as they take abundance into account.
## We do not know whether sequencing data accurately reflects specimen
## abundance, thus we treat all data as presence-absence.

## Was sample size enough to accurately represent macroinvertebrate
## diversity?
## Plot species accumulation curve across ponds
plot(specaccum(comb.df), 
     xlab = "Number of ponds", 
     ylab = "Number of species",
     ci.type="polygon", ci.col="grey")

## More ponds would have been required to fully represent macroinvertebrate
## diversity.


#' 
#' Alpha diversity of different invertebrate groups in ponds with and without
#' crucian carp.
#' 

## Import data containing order information for invertebrate species and families
spp.order <- read.csv("../Data/Invertebrate_species_order_data.csv", header=TRUE)

## Make columns in each dataframe characters rather than factor variables
spp.order$Species <- as.character(spp.order$Species)
spp.order$Group <- as.character(spp.order$Group)
fam.order$Family <- as.character(fam.order$Family)
fam.order$Group <- as.character(fam.order$Group)

## Transpose dataframe
order.df <- data.frame(t(comb.order.spp))

## Tranform data to presence-absence
order.df[order.df > 0] <- 1

## Make row names a new column in dataframe
order.df$Species <- rownames(order.df)
order.df <- order.df[,c(19,1:18)]
rownames(order.df) <- NULL

## Add order data to netting data
order.df <- merge(order.df, spp.order, by.x="Species", by.y="Species", all.x=TRUE)
order.df <- order.df[,c(1,20,2:19)]

## Remove species column, and merge data by order
order.df <- order.df[,-1]
order.df <- ddply(order.df, .(Group), numcolwise(sum))

## Make Group column row names and transpose dataframe
rownames(order.df) <- order.df$Group
order.df <- order.df[,-1]
order.dat <- data.frame(t(order.df))

## Make row names column in dataframe
order.dat$Pond <- rownames(order.dat)
order.dat <- order.dat[,c(25,1:24)]
rownames(order.dat) <- NULL

## Create new column specifying whether pond contains crucian carp
order.dat$Crucian <- factor(ifelse(order.dat$Pond %in% metadata$Site, as.character(metadata$Crucian), "NA"))
order.dat <- order.dat[,c(1,26,2:25)]

## Melt dataframe and rename new columns
order.melt <- melt(order.dat, id=c("Pond","Crucian"))
colnames(order.melt)[3:4] <- c("Group","Richness")

## Create additional dataframes to hold text annotations
text1 <- data.frame(label=c("","","","","*","","","","","","",""),
                    Group=c("Annelida","Arachnida",
                            "Bryozoa","Cnidaria",
                            "Coleoptera","Collembola",
                            "Crustacea","Diptera",
                            "Ephemeroptera","Gastrotricha",
                            "Hemiptera","Hirudinea"))

text2 <- data.frame(label=c("","","","**","","","","","","","",""),
                    Group=c("Hymenoptera","Lepidoptera",
                            "Megaloptera","Mollusca",
                            "Nematoda","Odonata",
                            "Platyhelminthes","Psocoptera",
                            "Rotifera","Tardigrada",
                            "Thysanoptera","Trichoptera"))

## Plot Group richness in crucian carp and non-fish ponds
p5ai <- ggplot(order.melt[order.melt$Group %in% c("Annelida","Arachnida",
                                                  "Bryozoa","Cnidaria",
                                                  "Coleoptera","Collembola",
                                                  "Crustacea","Diptera",
                                                  "Ephemeroptera","Gastrotricha",
                                                  "Hemiptera","Hirudinea"),],
               aes(x=Crucian, y=Richness))
p5ai <- p5ai + geom_jitter(aes(colour=Crucian), width=0.2, show.legend=FALSE)
p5ai <- p5ai + geom_boxplot(alpha=0.7, outlier.shape=NA)
p5ai <- p5ai + coord_cartesian(ylim=c(0,16))
p5ai <- p5ai + scale_y_continuous(breaks=seq(0,16,1))
p5ai <- p5ai + labs(title="(a) Species-level",
                    x="", y=expression(alpha~diversity))
p5ai <- p5ai + geom_text(data=text1, mapping=aes(x=1.5, y=16, label=label), 
                         size=10)
p5ai <- p5ai + scale_colour_manual(values=c("grey40","deepskyblue2"))
p5ai <- p5ai + scale_x_discrete(breaks=c("N","Y"),
                                labels=c("Absent","Present"))
p5ai <- p5ai + theme_bw()
p5ai <- p5ai + theme(panel.background = element_rect(fill = "white"),
                     panel.grid.major = element_blank(), 
                     panel.grid.minor = element_blank(),
                     plot.title = element_text(face="bold", hjust=0, colour="black"),
                     plot.subtitle = element_text(face="bold", hjust=0, colour="black", margin=unit(c(2,0,2,0), "mm")),
                     axis.line.x = element_line(colour="black", size=0.5, linetype="solid"),
                     axis.line.y = element_line(colour="black", size=0.5, linetype="solid"),
                     axis.title.x = element_blank(),
                     axis.title.y = element_text(margin=unit(c(0, 5, 0, 0), "mm")),
                     axis.text.x = element_text(colour="black", size=12),
                     axis.text.y = element_text(colour="black", size=20),
                     strip.text.x = element_text(size=12),
                     legend.position = "none",
                     text = element_text(size=20))
p5ai <- p5ai + facet_grid(. ~ Group)
p5ai

p5aii <- ggplot(order.melt[order.melt$Group %in% c("Hymenoptera","Lepidoptera",
                                                   "Megaloptera","Mollusca",
                                                   "Nematoda","Odonata",
                                                   "Platyhelminthes","Psocoptera",
                                                   "Rotifera","Tardigrada",
                                                   "Thysanoptera","Trichoptera"),],
                aes(x=Crucian, y=Richness))
p5aii <- p5aii + geom_jitter(aes(colour=Crucian), width=0.2, show.legend=FALSE)
p5aii <- p5aii + geom_boxplot(alpha=0.7, outlier.shape=NA)
p5aii <- p5aii + coord_cartesian(ylim=c(0,16))
p5aii <- p5aii + scale_y_continuous(breaks=seq(0,16,1))
p5aii <- p5aii + labs(x="Crucian carp", y=expression(alpha~diversity))
p5aii <- p5aii + geom_text(data=text2, mapping=aes(x=1.5, y=16, label=label), 
                           size=10)
p5aii <- p5aii + scale_colour_manual(values=c("grey40","deepskyblue2"))
p5aii <- p5aii + scale_x_discrete(breaks=c("N","Y"),
                                  labels=c("Absent","Present"))
p5aii <- p5aii + theme_bw()
p5aii <- p5aii + theme(panel.background = element_rect(fill = "white"),
                       panel.grid.major = element_blank(), 
                       panel.grid.minor = element_blank(),
                       plot.title = element_text(face="bold", hjust=0, colour="black"),
                       axis.line.x = element_line(colour="black", size=0.5, linetype="solid"),
                       axis.line.y = element_line(colour="black", size=0.5, linetype="solid"),
                       axis.title.x = element_text(margin=unit(c(8, 0, 0, 0), "mm")),
                       axis.title.y = element_text(margin=unit(c(0, 5, 0, 0), "mm")),
                       axis.text.x = element_text(colour="black", size=12),
                       axis.text.y = element_text(colour="black", size=20),
                       strip.text.x = element_text(size=12),
                       legend.position = "none",
                       text = element_text(size=20))
p5aii <- p5aii + facet_grid(. ~ Group)
p5aii

## Plot together
p5a <- grid.arrange(p5ai,p5aii, nrow=2)

## Statistically test for differences in invertebrate species richness
order.alpha.regression <- glm.nb(Richness ~ Group/Crucian, data=order.melt)
summary(order.alpha.regression)
anova(order.alpha.regression, test = "Chi")
drop1(order.alpha.regression, test = "Chi")

## Check model meets GLM assumptions
## Test for overdispersion
360.86/384
1-pchisq(360.86, df=384)  # not overdispersed

## Plot the fitted data against the observed data
plot(order.melt$Richness ~ fitted(order.alpha.regression))

## Hosmer and Lemeshow Goodness of Fit Test
hoslem.test(order.melt$Richness, fitted(order.alpha.regression))

## Model supposedly fits well as p-value is not significant 
## i.e. no significant difference between the model and the observed data

## Perform model validation checks to ensure model is good fit to data and 
## making reliable predictions
## Assumption 1: residuals are normally distributed
sresid <- resid(order.alpha.regression, type = "pearson")
hist(sresid)
lines(density(sresid,adjust=1))
qqnorm(sresid, cex=1.8, pch=20)
qqline(sresid, lty=2, lwd=2)
chkres(order.alpha.regression)
shapiro.test(sresid) # P = 1.886e-12

## Some deviation from normality as residuals are normally distributed
## therefore model may not be reliable.

## Assumption 2: no heteroscedascity
## Plot standardised residuals against each independent variable to 
## identify any source of heterogeneity i.e. independent variable that is 
## non-linearly associated with y
plot(sresid ~ order.alpha.regression$fitted.values, pch=20, cex=2, cex.lab=1.5)
plot(sresid ~ order.melt$Crucian, pch=20, cex=2, cex.lab=1.5) # No heteroscedascity
plot(sresid ~ order.melt$Group, pch=20, cex=2, cex.lab=1.5) # No heteroscedascity

## Assumption 3: no collinearity
vif(order.alpha.regression)

## Assumption 4: no serial auto-correlation
## can arise if there are unaccounted for relationships in data set or
## if there is confounding effect of time or space
durbinWatsonTest(order.alpha.regression)

## No significant serial auto-correlation as p-value not significant
## Use graphical approach with Auto-Correlation Function (ACF)
acf(sresid, main = "Auto-correlation plot")
## Some autocorrelation at first time lag

## Assumption 5: model not biased by unduly influential observations
influence <- influence.measures(order.alpha.regression)
summary(influence)
CD <- cooks.distance(order.alpha.regression)
plot(CD ~ sresid)

## Cook's distance < 1 so observations not exerting strong influence on model
## parameters



#'
#' ## Beta diversity
#' 
#' Previously, only the impact of crucian carp presence-absence on pond 
#' invertebrate communities was examined. Now that we have combined the data
#' from all three methods and thus have the most holistic invertebrate
#' inventories for each pond, we will look at the impact of abiotic variables
#' in conjunction with crucian carp presence-absence. We will use Reduncy 
#' Analysis (RDA) and variance partitioning to partition the variation in pond
#' invertebrate community composition by biotic and abiotic variable for each
#' component of beta diversity, i.e. nestedness, turnover, and total beta 
#' diversity.
#' 

## First, tidy up environmental metadata
## Make new dataframe containing only variables relevant to RDA
env.data <- metadata[,c(1:2,6:12)]

## Make first column containing pond ID the row names of dataframe
rownames(env.data) <- env.data$Site
env.data <- env.data[,-1]

## Code crucian carp presence-absence as numeric (0, 1) for RDA
env.data$Crucian <- gsub("Y", "1", env.data$Crucian)
env.data$Crucian <- gsub("N", "0", env.data$Crucian)
env.data$Crucian <- as.numeric(env.data$Crucian)

## Check environmental data for collinearity
plot(env.data[,1:8], 
     lower.panel = panel.cor, 
     upper.panel = panel.smooth2)

## Percentage of submerged macrophyte cover is strongly collinear (+/- 0.5) 
## with other variables. Percentage of emergent cover and emergent perimeter 
## are collinear. 
## Remove percentages of submerged macrophyte cover and emergent perimeter
## (less informative than emergent cover).
env.data <- env.data[,-c(5,7)]

## Check for collinearity
plot(env.data[,1:6], 
     lower.panel = panel.cor, 
     upper.panel = panel.smooth2)


## Now, examine beta diversity across all ponds
comb.multi <- beta.multi(comb.pa, index.family="jaccard")
print(comb.multi)

## The majority of total beta diversity arises from species turnover
## rather than nestedness.

## Sampling across equal sites
comb.samp <- beta.sample(comb.pa, 
                        index.family="jaccard",
                        sites=8,                # minimum no. of sites in a group
                        samples=100)

## Plotting the distributions of components
dist.comb.samp <- comb.samp$sampled.values
plot(density(dist.comb.samp$beta.JAC),xlim=c(0,1), ylim=c(0,100), 
     xlab='Beta diversity', main='', lwd=3)
lines(density(dist.comb.samp$beta.JAC), lty=1, lwd=2)
lines(density(dist.comb.samp$beta.JNE), lty=1, lwd=2)
lines(density(dist.comb.samp$beta.JTU), lty=2, lwd=2)

## Now get pairwise between-site values of each component of beta diversity
comb.dist <- beta.pair(comb.pa, index.family="jaccard")

## Convert each partition of beta diversity to a matrix if you want to 
## write as a csv file
#net.turn <- as.matrix(dist(net.beta$beta.jtu))
#net.nest <- as.matrix(dist(net.beta$beta.jne))
#net.total <- as.matrix(dist(net.beta$beta.jac))


## 1. TURNOVER PARTITION (COMPLETE CHANGE IN COMMUNITIES)

## First, test whether ponds with and without crucian carp have different
## communities using PERMANOVA and visualise differences with NMDS
comb.bd.turn <- betadisper(comb.dist$beta.jtu, metadata$Crucian)

## Check homogeneity of multivariate dispersions. Groups being tested should 
## have the sample multivariate spread to conform to assumptions of PERMANOVA
mod.turn <- with(metadata, comb.bd.turn)
mod.turn

## Compute mean distance to centroid per group
tapply(comb.bd.turn$distances, metadata$Crucian, mean)

## Compute variance per group
tapply(comb.bd.turn$distances, metadata$Crucian, var)

## Ordination plot of turnover partition
plot(comb.bd.turn)

## Boxplot of turnover partition
boxplot(comb.bd.turn, xlab="Crucian carp", xaxt="n", bty="n")
axis(side=1, at=c(1,2), labels=c("Absent","Present"))

## Plots indicate that there is substantial difference in turnover partition
## of beta diversity between crucian and non-crucian ponds. 
## Statistically check whether turnover is different in crucian and
## non-crucian ponds using standard parametric anova or permutation
## tests.
anova(comb.bd.turn)     # No significant difference between ponds
permutest(comb.bd.turn) # No significant difference between ponds

## Analyse pairwise differences between groups (crucian/non-crucian) using 
## parametric Tukey's HSD test.
TukeyHSD(comb.bd.turn)  # No significant difference between groups

## Ordination of beta diversity partitioned by turnover:
## The metaMDS function automatically transforms data and checks solution
## robustness
comb.bd.turn <- metaMDS(comb.dist$beta.jtu, dist = "jaccard")

## Assess goodness of ordination fit (stress plot)
stressplot(comb.bd.turn)

## plot site scores as text
ordiplot(comb.bd.turn, display = "sites", type = "text")

## Build data frame with NMDS coordinates and metadata
comb.NMDS1 <- comb.bd.turn$points[,1]
comb.NMDS2 <- comb.bd.turn$points[,2]
comb.turn.NMDS <- data.frame(NMDS1=comb.NMDS1, 
                             NMDS2=comb.NMDS2,
                             Crucian = comb.metadata$Crucian)

## Check data
head(comb.turn.NMDS)

## Plot data frame
p2j <- ggplot(comb.turn.NMDS, aes(x=NMDS1, y=NMDS2, colour=Crucian))
p2j <- p2j + geom_point() + stat_ellipse()
p2j <- p2j + labs(subtitle="(iv) Methods combined", x="NMDS1", y="NMDS2")
p2j <- p2j + coord_cartesian(xlim=c(-1,1), ylim=c(-1,1))
p2j <- p2j + scale_colour_manual(name="Crucian carp",
                                 breaks=c("N","Y"),
                                 labels=c("Absent","Present"),
                                 values=c("grey40","deepskyblue2"))
p2j <- p2j + theme(panel.background = element_rect(fill = 'white'),
                   axis.line.x = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.line.y = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.title.x = element_text(margin = unit(c(8, 0, 0, 0), "mm")),
                   axis.title.y = element_text(margin = unit(c(0, 5, 0, 0), "mm")),
                   axis.text.x = element_text(colour="black"),
                   axis.text.y = element_text(colour="black"),
                   plot.title = element_text(face="bold", hjust=0, colour="black"),
                   plot.subtitle = element_text(face="bold", hjust=0, colour="black", margin = unit(c(2, 0, 0, 0), "mm")),
                   text = element_text(size=20),
                   legend.position="none")
p2j

## Statistically check difference in spatial turnover of communities
comb.turn.anosim <- anosim(comb.dist$beta.jtu, metadata$Crucian)

## Inspect results
comb.turn.anosim
summary(comb.turn.anosim)
plot(comb.turn.anosim)

## There appears to be a significant difference in spatial turnover
## Look at PermANOVA using adonis(), considered more robust than anosim()
comb.turn.adonis <- adonis(comb.dist$beta.jtu ~ Crucian, metadata)

## Inspect results
## no summary() or plot() methods included
comb.turn.adonis

## Again result is significant. The combined data indicates there is a
## substantial difference in species replacement (i.e. turnover) between
## ponds with crucian carp and ponds without crucian carp. Therefore,
## species in ponds with no fish are substituted by species in ponds
## with crucian carp.


## Use RDA and variance partitioning to examine the influence of biotic and 
## abiotic variables on turnover partition of beta diversity

## First, compute principal coordinate decomposition (classical scaling) for 
## turnover distance matrix using the pcoa() function from the ape package. Use 
## lingoes correction to account for negative eigenvalues.
pcoa.jtu <- pcoa(comb.dist$beta.jtu, correction="lingoes", rn=NULL)

## Inspect outputs
pcoa.jtu$correction
pcoa.jtu$note
pcoa.jtu$trace

## The principal component coordinates for each diversity matrix can be written
## to a csv file for inspection
#write.csv(pcoa.jtu$vectors, "../Data/Combined_data_species_turnover_eigenvectors.csv")

## Create groups of variables for RDA
## Biotic:
biotic <- data.frame(env.data$Crucian)
colnames(biotic) <- "Crucian"

## Abiotic:
abiotic <- env.data[,c(2:6)]

## log10 transform abiotic data to remove units
abiotic <- log10(abiotic+1)

## Perform forward model selection for each group of explanatory variables
## Adjusted R-squared will be used as a goodness-of-fit measure. Model selection
## needs to be performed for each group of variables, excluding those containing
## only one variable.
abiotic.rda.null <- rda(pcoa.jtu$vectors ~ 1, abiotic)  # null model
abiotic.rda.all <- rda(pcoa.jtu$vectors ~ ., abiotic)   # model with all variables
step.env <- ordiR2step(abiotic.rda.null, abiotic.rda.all, 
                       direction="forward", perm.max = 1000)

## Summary table and plot:
step.env$anova
plot(step.env)
## Indicates that only pond area should be included from this group of variables
## in model.

## Run RDA with selected biotic and abiotic variables
## Varpart between the groups - of the abiotic variables that have been log-transformed
mod <- varpart(pcoa.jtu$vectors, ~ biotic$Crucian, ~ abiotic$Area)
mod
plot(mod, digits=2, cutoff=0, bg=c("skyblue2","grey60"), 
     Xnames=c("Biotic", "Abiotic"), id.size=1)
## The output indicates that crucian carp presence-absence has a larger
## individual fraction of explained variance. We can also see that there is 
## a fraction of shared variance which indicates that biotic and abiotic 
## variable effects are somewhat dependent on one another.

## Test for significance of the whole model:
mod2 <- rda(pcoa.jtu$vectors ~ biotic$Crucian + abiotic$Area)
summary(mod2)
coef(mod2)       # canonical coefficients
vif.cca(mod2)    # no collinearity present in model
mod2             # 17.5% variance is explained by variables in model
anova(mod2)      # Model is significant
RsquareAdj(mod2) # 6.5% variance explained
plot(mod2)

## Inertia is another name for variation or variance in this case. Total refers to 
## total variance, Constrained refers to the amount of variance explained by the 
## explanatory variables, Unconstrained? refers to the residual variance. Constrained + 
## Unconstrained = Total. An R2 statistic can be derived simply as Constrained/Total. 
## The function RsquareAdj computes R2 and R2-adjusted. The variable Rank indicates 
## the number of variables included. The eigenvalues are displayed for both the 
## constrained and unconstrained axes. In this context, these eigenvalues indicate 
## how much variance each of the axes contribute to.

## Testing significance of the individual groups:
rda.biotic <- rda(formula = pcoa.jtu$vectors ~ biotic$Crucian + Condition(abiotic$Area))
summary(rda.biotic)
anova(rda.biotic)
## Conditioned abiotic variable explains less variation (8.3%) than crucian
## carp presence-absence (9.1%).

rda.abiotic <- rda(formula = pcoa.jtu$vectors ~ abiotic$Area + Condition(biotic$Crucian))
summary(rda.abiotic)
anova(rda.abiotic)
## Abiotic variable explains less variation (6.6%) than crucian carp 
## presence-absence (10.9%).

## Check whether any variables should be dropped from model
drop1(mod2, test="perm")
## Pond area should potentially be dropped as not significant

## Plot model result to get a sense of which variables are correlating with which 
## ponds along which axes
plot(mod2, type='n', scaling=1)
orditorp(mod2, display='sp', cex=0.5, scaling=1, col='blue')
text(mod2, display='cn', col='red')

## Plot of variables against sites
plot(mod2, type = "text")

## Perform hypothesis testing
anova(mod2, perm=1000)               # overall model fit
anova(mod2, by="margin", perm=1000)  # significance of marginal effects (Type III)
anova(mod2, by="term", perm=1000)    # significance of each term in model
anova(mod2, by="axis", perm=1000)    # significance of each axis


## 2. NESTEDNESS PARTITION (SUBSET OF CHANGE IN WIDER COMMUNITY)
comb.bd.nest <- betadisper(comb.dist$beta.jne, metadata$Crucian)

## Check homogeneity of multivariate dispersions. Groups being tested should 
## have the sample multivariate spread to conform to assumptions of PERMANOVA
comb.nest <- with(metadata, comb.bd.nest)
comb.nest

## Compute mean distance to centroid per group
tapply(comb.bd.nest$distances, metadata$Crucian, mean)

## Compute variance per group
tapply(comb.bd.nest$distances, metadata$Crucian, var)

## Ordination plot of turnover partition
plot(comb.bd.nest)

## Boxplot of turnover partition
boxplot(comb.bd.nest, xlab="Crucian carp", xaxt="n", bty="n")
axis(side=1, at=c(1,2), labels=c("Absent","Present"))

## Plots indicates that there is no difference in nestedness partition
## of beta diversity between crucian and non-crucian ponds. 
## Statistically check whether nestedness is different in crucian and
## non-crucian ponds using standard parametric anova or permutation
## tests.
anova(comb.bd.nest)     # No significant difference between ponds
permutest(comb.bd.nest) # No significant difference between ponds

## Analyse pairwise differences between groups using parametric Tukey's HSD 
## test.
TukeyHSD(comb.bd.nest)  # No significant difference between ponds

## Ordination of beta diversity partitioned by nestedness:
comb.comm.nest <- metaMDS(comb.dist$beta.jne, dist = "jaccard")

## Assess goodness of ordination fit (stress plot)
stressplot(comb.comm.nest)

## plot site scores as text
ordiplot(comb.comm.nest, display = "sites", type = "text")

## Build data frame with NMDS coordinates and metadata
comb.NMDS1 <- comb.comm.nest$points[,1]
comb.NMDS2 <- comb.comm.nest$points[,2]
comb.nest.NMDS <- data.frame(NMDS1=comb.NMDS1, 
                             NMDS2=comb.NMDS2,
                             Crucian = metadata$Crucian)

## Check data
head(comb.nest.NMDS)

## Plot data frame
p2k <- ggplot(comb.nest.NMDS, aes(x=NMDS1, y=NMDS2, colour=Crucian))
p2k <- p2k + geom_point() + stat_ellipse()
p2k <- p2k + labs(subtitle="", x="NMDS1", y="")
p2k <- p2k + coord_cartesian(xlim=c(-1,1), ylim=c(-1,1))
p2k <- p2k + scale_colour_manual(name="Crucian carp",
                                 breaks=c("N","Y"),
                                 labels=c("Absent","Present"),
                                 values=c("grey40","deepskyblue2"))
p2k <- p2k + theme(panel.background = element_rect(fill = 'white'),
                   axis.line.x = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.line.y = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.title.x = element_text(margin = unit(c(8, 0, 0, 0), "mm")),
                   axis.title.y = element_text(margin = unit(c(0, 5, 0, 0), "mm")),
                   axis.text.x = element_text(colour="black"),
                   axis.text.y = element_text(colour="black"),
                   plot.title = element_text(face="bold", hjust=0, colour="black"),
                   plot.subtitle = element_text(face="bold", hjust=0, colour="black", margin = unit(c(2, 0, 0, 0), "mm")),
                   text = element_text(size=20),
                   legend.position="none")
p2k

## Statistically check difference in nestedness of communities
comb.nest.anosim <- anosim(comb.dist$beta.jne, metadata$Crucian)

## Inspect results
comb.nest.anosim
summary(comb.nest.anosim)
plot(comb.nest.anosim)

## There appears to be no significant difference in nestedness
## Look at PermANOVA using adonis(), considered more robust than anosim()
comb.nest.adonis <- adonis(comb.dist$beta.jne ~ Crucian, metadata)

## Inspect results
## no summary() or plot() methods included
comb.nest.adonis

## Result is not significant. The combined data indicates there is no
## substantial difference in species loss or gain (i.e. nestedness) 
## between ponds with crucian carp and ponds without crucian carp.


## Use RDA and variance partitioning to examine the influence of biotic and 
## abiotic variables on nestedness partition of beta diversity

## First, compute principal coordinate decomposition (classical scaling) for 
## nestedness distance matrix using the pcoa() function from the ape package. Use 
## lingoes correction to account for negative eigenvalues.
pcoa.jne <- pcoa(comb.dist$beta.jne, correction="lingoes", rn=NULL)

## Inspect outputs
pcoa.jne$correction
pcoa.jne$note
pcoa.jne$trace

## The principal component coordinates for each diversity matrix can be written
## to a csv file for inspection
#write.csv(pcoa.jne$vectors, "../Data/Combined_data_species_nestedness_eigenvectors.csv")

## Groups of variables were previously created for RDA of turnover
## Perform forward model selection for each group of explanatory variables
## Adjusted R-squared will be used as a goodness-of-fit measure. Model selection
## needs to be performed for each group of variables, excluding those containing
## only one variable.
abiotic.rda.null <- rda(pcoa.jne$vectors ~ 1, abiotic)  # null model
abiotic.rda.all <- rda(pcoa.jne$vectors ~ ., abiotic)   # model with all variables
step.env <- ordiR2step(abiotic.rda.null, abiotic.rda.all, 
                       direction="forward", perm.max = 1000)

## Summary table and plot:
step.env$anova
plot(step.env)
## Indicates that no abiotic variables should be included in model

## Run RDA with biotic variable
## Test for significance of the whole model:
mod2 <- rda(pcoa.jne$vectors ~ biotic$Crucian)
summary(mod2)
coef(mod2)       # canonical coefficients
vif.cca(mod2)    # no collinearity present in model
mod2             # 0.002% variance is explained by variables in model
anova(mod2)      # Model is not significant
RsquareAdj(mod2) # -0.04% variance explained?
plot(mod2)

## Inertia is another name for variation or variance in this case. Total refers to 
## total variance, Constrained refers to the amount of variance explained by the 
## explanatory variables, Unconstrained? refers to the residual variance. Constrained + 
## Unconstrained = Total. An R2 statistic can be derived simply as Constrained/Total. 
## The function RsquareAdj computes R2 and R2-adjusted. The variable Rank indicates 
## the number of variables included. The eigenvalues are displayed for both the 
## constrained and unconstrained axes. In this context, these eigenvalues indicate 
## how much variance each of the axes contribute to.

## Check whether any variables should be dropped from model
drop1(mod2, test="perm")
## Crucian carp presence-absence not significant

## Plot model result to get a sense of which variables are correlating with which 
## ponds along which axes
plot(mod2, type='n', scaling=1)
orditorp(mod2, display='sp', cex=0.5, scaling=1, col='blue')
text(mod2, display='cn', col='red')

## Plot of variables against sites
plot(mod2, type = "text")

## Perform hypothesis testing
anova(mod2, perm=1000)               # overall model fit
anova(mod2, by="margin", perm=1000)  # significance of marginal effects (Type III)
anova(mod2, by="term", perm=1000)    # significance of each term in model
anova(mod2, by="axis", perm=1000)    # significance of each axis


## 3. TOTAL BETA DIVERSITY
comb.bd.total <- betadisper(comb.dist$beta.jac, metadata$Crucian)

## Check homogeneity of multivariate dispersions. Groups being tested should 
## have the sample multivariate spread to conform to assumptions of PERMANOVA
mod.total <- with(metadata, comb.bd.total)
mod.total

## Compute mean distance to centroid per group
tapply(comb.bd.total$distances, metadata$Crucian, mean)

## Compute variance per group
tapply(comb.bd.total$distances, metadata$Crucian, var)

## Ordination plot of total beta diversity
plot(comb.bd.total)

## Boxplot of total beta diversity
boxplot(comb.bd.total, xlab="Crucian carp", xaxt="n", bty="n")
axis(side=1, at=c(1,2), labels=c("Absent","Present"))

## Plots indicates that there is substantial difference in total beta diversity 
## between crucian and non-crucian ponds. 
## Statistically check whether total beta is different in crucian and
## non-crucian ponds using standard parametric anova or permutation
## tests.
anova(comb.bd.total)     # Significant difference between ponds
permutest(comb.bd.total) # Significant difference between ponds

## Analyse pairwise differences between groups using parametric Tukey's 
## HSD test.
TukeyHSD(comb.bd.total)  # Significant difference between ponds

## Ordination of total beta diversity:
## The metaMDS function automatically transforms data and checks solution
## robustness
comb.comm.total <- metaMDS(comb.dist$beta.jac, dist = "jaccard")

## Assess goodness of ordination fit (stress plot)
stressplot(comb.comm.total)

## plot site scores as text
ordiplot(comb.comm.total, display = "sites", type = "text")

## Build data frame with NMDS coordinates and metadata
comb.NMDS1 <- comb.comm.total$points[,1]
comb.NMDS2 <- comb.comm.total$points[,2]
comb.total.NMDS <- data.frame(NMDS1=comb.NMDS1,
                              NMDS2=comb.NMDS2,
                              Crucian = metadata$Crucian)

## Check data
head(comb.total.NMDS)

## Plot data frame
p2l <- ggplot(comb.total.NMDS, aes(x=NMDS1, y=NMDS2, colour=Crucian)) 
p2l <- p2l + geom_point() + stat_ellipse()
p2l <- p2l + labs(subtitle="", x="NMDS1", y="")
p2l <- p2l + coord_cartesian(xlim=c(-1,1), ylim=c(-1,1))
p2l <- p2l + scale_colour_manual(name="Crucian carp",
                                 breaks=c("N","Y"),
                                 labels=c("Absent","Present"),
                                 values=c("grey40","deepskyblue2"))
p2l <- p2l + theme(panel.background = element_rect(fill = 'white'),
                   axis.line.x = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.line.y = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.title.x = element_text(margin = unit(c(8, 0, 0, 0), "mm")),
                   axis.title.y = element_text(margin = unit(c(0, 5, 0, 0), "mm")),
                   axis.text.x = element_text(colour="black"),
                   axis.text.y = element_text(colour="black"),
                   plot.title = element_text(face="bold", hjust=0, colour="black"),
                   plot.subtitle = element_text(face="bold", hjust=0, colour="black", margin = unit(c(2, 0, 0, 0), "mm")),
                   text = element_text(size=20),
                   legend.position="none")
p2l

## Statistically check difference in total beta diversity of ponds
comb.total.anosim <- anosim(comb.dist$beta.jac, metadata$Crucian)

## Inspect results
comb.total.anosim
summary(comb.total.anosim)
plot(comb.total.anosim)

## There appears to be a significant difference in total beta diversity
## Look at PermANOVA using adonis(), considered more robust than anosim()
comb.total.adonis <- adonis(comb.dist$beta.jac ~ Crucian, metadata)

## Inspect results
## no summary() or plot() methods included
comb.total.adonis

## Again result is significant. The combined data indicates there is 
## substantial variation in overall species composition of
## ponds with crucian carp and ponds without crucian carp


## Use RDA and variance partitioning to examine the influence of biotic and 
## abiotic variables on total beta diversity

## First, compute principal coordinate decomposition (classical scaling) for 
## total beta distance matrix using the pcoa() function from the ape package. Use 
## lingoes correction to account for negative eigenvalues.
pcoa.jac <- pcoa(comb.dist$beta.jac, correction="lingoes", rn=NULL)

## Inspect outputs
pcoa.jac$correction
pcoa.jac$note
pcoa.jac$trace

## The principal component coordinates for each diversity matrix can be written
## to a csv file for inspection
#write.csv(pcoa.jac$vectors, "../Data/Combined_data_species_totalbeta_eigenvectors.csv")

## Groups of variables were previously created for RDA of turnover
## Perform forward model selection for each group of explanatory variables
## Adjusted R-squared will be used as a goodness-of-fit measure. Model selection
## needs to be performed for each group of variables, excluding those containing
## only one variable.
abiotic.rda.null <- rda(pcoa.jac$vectors ~ 1, abiotic)  # null model
abiotic.rda.all <- rda(pcoa.jac$vectors ~ ., abiotic)   # model with all variables
step.env <- ordiR2step(abiotic.rda.null, abiotic.rda.all, 
                       direction="forward", perm.max = 1000)

## Summary table and plot:
step.env$anova
plot(step.env)
## Indicates that only pond area should be included in model.

## Run RDA with selected biotic and abiotic variables
## Varpart between the groups - of the abiotic variables that have been log-transformed
mod <- varpart(pcoa.jac$vectors, ~ biotic$Crucian, ~ abiotic$Area)
mod
plot(mod, digits=2, cutoff=0, bg=c("skyblue2","grey60"), 
     Xnames=c("Biotic", "Abiotic"), id.size=1)
## The output indicates that crucian carp presence-absence has a larger
## individual fraction of explained variance. We can also see that there is 
## a fraction of shared variance which indicates that biotic and abiotic 
## variable effects are somewhat dependent on one another.

## Test for significance of the whole model:
mod2 <- rda(pcoa.jac$vectors ~ biotic$Crucian + abiotic$Area)
summary(mod2)
coef(mod2)       # canonical coefficients
vif.cca(mod2)    # no collinearity present in model
mod2             # 15.61% variance is explained by variables in model
anova(mod2)      # Model is significant
RsquareAdj(mod2) # 4.35% variance explained
plot(mod2)

## Inertia is another name for variation or variance in this case. Total refers to 
## total variance, Constrained refers to the amount of variance explained by the 
## explanatory variables, Unconstrained? refers to the residual variance. Constrained + 
## Unconstrained = Total. An R2 statistic can be derived simply as Constrained/Total. 
## The function RsquareAdj computes R2 and R2-adjusted. The variable Rank indicates 
## the number of variables included. The eigenvalues are displayed for both the 
## constrained and unconstrained axes. In this context, these eigenvalues indicate 
## how much variance each of the axes contribute to.

## Testing significance of the individual groups:
rda.biotic <- rda(formula = pcoa.jac$vectors ~ biotic$Crucian + Condition(abiotic$Area))
summary(rda.biotic)
anova(rda.biotic)
## Conditioned abiotic variable explains less variation (7.5%) than crucian
## carp presence-absence (8.1%).

rda.abiotic <- rda(formula = pcoa.jac$vectors ~ abiotic$Area + Condition(biotic$Crucian))
summary(rda.abiotic)
anova(rda.abiotic)
## Abiotic variable explains less variation (6.1%) than crucian carp 
## presence-absence (9.5%).

## Check whether any variables should be dropped from model
drop1(mod2, test="perm")
## Pond area should potentially be dropped as not significant

## Plot model result to get a sense of which variables are correlating with which 
## ponds along which axes
plot(mod2, type='n', scaling=1)
orditorp(mod2, display='sp', cex=0.5, scaling=1, col='blue')
text(mod2, display='cn', col='red')

## Plot of variables against sites
plot(mod2, type = "text")

## Perform hypothesis testing
anova(mod2, perm=1000)               # overall model fit
anova(mod2, by="margin", perm=1000)  # significance of marginal effects (Type III)
anova(mod2, by="term", perm=1000)    # significance of each term in model
anova(mod2, by="axis", perm=1000)    # significance of each axis


## Further exploration of total beta diversity
## Create matrix from total beta diversity dist object
comb.beta.temp <- as.matrix(comb.dist$beta.jac)
comb.beta.temp
comb.beta.temp2 <- t(combn(colnames(comb.beta.temp),2))
comb.beta <- data.frame(comb.beta.temp2, dist=comb.beta.temp[comb.beta.temp2])
colnames(comb.beta) <- c("Pond1","Pond2","Jaccard")

## Loop over jaccard data frame and create new column saying what type of 
## combination we have
comb.beta$Combo <- factor(ifelse(comb.beta$Pond1%in%crucian&comb.beta$Pond2%in%crucian,"crucian-crucian",
                                 ifelse(comb.beta$Pond1%in%crucian&comb.beta$Pond2%in%non_crucian,"crucian-no crucian",
                                        ifelse(comb.beta$Pond1%in%non_crucian&comb.beta$Pond2%in%crucian,"crucian-no crucian",
                                               ifelse(comb.beta$Pond2%in%non_crucian&comb.beta$Pond2%in%non_crucian,"no crucian-no crucian",
                                                      "Fail")))))

## Regression examining whether Jaccard distance is influenced by site 
## combinations
comb.beta.regression <- aov(Jaccard ~ Combo, data=comb.beta)
summary(comb.beta.regression)
anova(comb.beta.regression)

## Tukey post-hoc test examining difference between groups
TukeyHSD(comb.beta.regression, ordered = TRUE)

## Plot of jaccard distance across groups
p3g <- ggplot(comb.beta, aes(x=Combo, y=Jaccard))
p3g <- p3g + ggtitle("(d) Combined")
p3g <- p3g + geom_jitter(aes(colour=Combo), width=0.2)
p3g <- p3g + geom_boxplot(alpha=0.7, outlier.colour="red") 
p3g <- p3g + scale_y_continuous(limits=c(0,1))
p3g <- p3g + scale_colour_manual(values=c("deepskyblue2","limegreen","goldenrod1"))
p3g <- p3g + annotate("text", 
                      x = c("crucian-crucian",
                            "crucian-no crucian",
                            "no crucian-no crucian"), 
                      y = 0.5, 
                      label = c("a","a","b"), cex=10)
p3g <- p3g + labs(x="Combination", y="Jaccard dissimilarity")
p3g <- p3g + theme(panel.background = element_rect(fill = "white"), 
                   axis.line.x = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.line.y = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.title.x = element_text(margin = unit(c(8, 0, 0, 0), "mm")),
                   axis.title.y = element_text(margin = unit(c(0, 5, 0, 0), "mm")),
                   axis.text.x = element_text(colour="black"),
                   axis.text.y = element_text(colour="black"),
                   plot.title = element_text(face="bold"),
                   text = element_text(size=20),
                   legend.key=element_blank(),
                   legend.key.size = unit(2, 'lines'))
p3g

## A useful way to examine this result is to build a "tree" from it. 
## Here, a tree (actually a dendrogram) is a way to cluster the sites 
## together based on how "far apart" they are in species composition; 
## sites which have very similar species compositions will group together 
## on the tree.
## Three methods of clustering but 'average' linkage method (based on the 
## average dissimilarity between groups of sites) usually most robust:
jacc.cla <- hclust(comb.dist$beta.jac, method="average")
jacc.cls <- hclust(comb.dist$beta.jac, method="single")
jacc.clc <- hclust(comb.dist$beta.jac, method="complete")

## Display the classification trees for these methods and notice how the 
## shape of the trees changes.
plot(jacc.cla)
plot(jacc.cls)
plot(jacc.clc)

## Measure the correlation between your original dissimilarity matrix and 
## the inter-group dissimilarity at each step up the classification tree 
## via the cophenetic function:
cor(comb.dist$beta.jac, cophenetic(jacc.cla))
cor(comb.dist$beta.jac, cophenetic(jacc.cls))
cor(comb.dist$beta.jac, cophenetic(jacc.clc))

## Average linkage method appears to have strongest correlation
## Plot dendrogram of site Jaccard dissimilarity
plot(jacc.cla, hang = -1,
     main = "Sites clustered by Jaccard similarity",
     axes = FALSE, ylab = "")


#' 
#' The combined data indicates that there is no difference in alpha diversity,
#' but there is a difference in beta diversity of ponds with or without crucian 
#' carp. This difference in total beta diversity stems from species turnover, 
#' as opposed to nestedness.
#' 
#' Are the patterns the same at family level?
#' 



#' 
#' ### Family level analysis
#' 

## First, replicate all dataframes
netting.fam <- net.fam
DNA.meta.fam <- DNA.fam
eDNA.meta.fam <- eDNA.fam

## First, add columns containing pond ID, whether pond contains crucian carp,
## and which tool was used to each dataframe 
netting.fam$Sample <- rownames(netting.fam)
netting.fam$Crucian <- metadata$Crucian
netting.fam$Method <- c("Netting")
netting.fam <- netting.fam[,c(39:41,1:38)]
rownames(netting.fam) <- NULL

DNA.meta.fam$Sample <- rownames(DNA.meta.fam)
DNA.meta.fam$Crucian <- metadata$Crucian
DNA.meta.fam$Method <- c("DNA")
DNA.meta.fam <- DNA.meta.fam[,c(58:60,1:57)]
rownames(DNA.meta.fam) <- NULL

eDNA.meta.fam$Sample <- rownames(eDNA.meta.fam)
eDNA.meta.fam$Crucian <- metadata$Crucian
eDNA.meta.fam$Method <- c("eDNA")
eDNA.meta.fam <- eDNA.meta.fam[,c(93:95,1:92)]
rownames(eDNA.meta.fam) <- NULL

## Combine data frames
comb.fam.df <- smartbind(netting.fam, DNA.meta.fam, eDNA.meta.fam)

## Replace NAs with 0s
comb.fam.df[is.na(comb.fam.df)] <- 0

## Take the first three columns and store in new dataframe as metadata
comb.fam.metadata <- comb.fam.df[,1:3]
rownames(comb.fam.metadata) <- NULL

## Add methodology to pond ID in dataframe of assignments
comb.fam.df <- within(comb.fam.df, id <- paste(Sample, Method, sep="_"))
comb.fam.df <- comb.fam.df[,c(116,1:115)]

## Remove metadata columns and rename ID column
comb.fam.df <- comb.fam.df[,-c(2:4)]
colnames(comb.fam.df)[1] <- "Sample"

## Save dataframe in current form for comparing monitoring tools later
method.fam.df <- comb.fam.df
rownames(method.fam.df) <- method.fam.df$Sample
method.fam.df <- method.fam.df[,-1]

## Now we can pool samples in the comb.df
## Remove methodology from sample name
comb.fam.df$Sample <- gsub("_Netting|_DNA|_eDNA", "", comb.fam.df$Sample)
comb.fam.df[,2:113] <- lapply(comb.fam.df[,2:113], function(x) as.numeric(as.character(x)))
comb.fam.df <- ddply(comb.fam.df, .(Sample), numcolwise(sum))

## Make Sample column row names
rownames(comb.fam.df) <- comb.fam.df$Sample
comb.fam.df <- comb.fam.df[,-1]

## Remove empty taxonomic assignments
comb.fam.df <- comb.fam.df[!sapply(comb.fam.df, function(x) all(x == 0))]

## Make copy of dataframe for analysing individual invertebrate orders in ponds
## with and without crucian carp later
comb.order.fam <- comb.fam.df


#'
#' Basic summaries
#' 

## Number of ponds where each family occurs
fam.pres <- apply(comb.fam.df > 0, 2, sum) 
sort(fam.pres, decreasing = TRUE)[1:18]


#'
#' ## Data transformation
#' 
#' From now on, all data exploration and analyses will take place in the 
#' vegan package.
#' 

## Tranform data
comb.fam.pa <- decostand(comb.fam.df, method = "pa", MARGIN = 1) # by rows (ponds)
head(comb.fam.pa[,1:3], n = 3)


#'
#' ## Alpha diversity
#' 

## Basic richness - two ways to calculate:
comb.fam.richness <- specnumber(comb.fam.pa)
comb.fam.richness

## Plot alpha diversity
## Create data frame
comb.fam.alpha <- data.frame(comb.fam.richness)

## add metadata from external file
comb.fam.alpha <- cbind(metadata[,1:2], comb.fam.alpha)

## Reset row names of data frame for further indexing
rownames(comb.fam.alpha) <- NULL

## Plot species richness
p1h <- ggplot(comb.fam.alpha, aes(x=Crucian, y=comb.fam.richness))
p1h <- p1h + geom_jitter(aes(colour=Crucian), cex=2, width=0.2, show.legend=FALSE)
p1h <- p1h + geom_boxplot(alpha=0.7, outlier.shape = NA)
p1h <- p1h + scale_y_continuous(limits=c(0,100))
p1h <- p1h + labs(subtitle="",x="Crucian carp", y="")
p1h <- p1h + scale_colour_manual(values=c("grey40","deepskyblue2"))
p1h <- p1h + scale_x_discrete(breaks=c("N","Y"),
                              labels=c("Absent","Present"))
p1h <- p1h + theme(panel.background = element_rect(fill = 'white'),
                   axis.line.x = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.line.y = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.title.x = element_text(margin = unit(c(8, 0, 0, 0), "mm")),
                   axis.title.y = element_text(margin = unit(c(0, 5, 0, 0), "mm")),
                   axis.text.x = element_text(colour="black"),
                   axis.text.y = element_text(colour="black"),
                   plot.title = element_text(face="bold", hjust=0, colour="black"),
                   plot.subtitle = element_text(face="bold", hjust=0, colour="black", margin = unit(c(2, 0, 0, 0), "mm")),
                   legend.position = "none",
                   text = element_text(size=20))
p1h

## Plot ordered richness
make.sorted.plot <- function(x){
  ordered <- sort(x, T)
  plot(
    ordered,
    col = terrain.colors(10),
    xaxt = "n", pch = 16, cex = 2,
    ylim = c(min(ordered)*0.5, max(ordered)),
    xlim = c(0, length(x)+1),
    ylab = "Diversity measure", xlab = "Sites",
    main = substitute(x))
  text(ordered,
       names(ordered),
       srt = -75,
       pos = 4)
}
make.sorted.plot(comb.fam.richness)

## Species richness appears to be the same in ponds with and without crucian
## carp, indicating this species may have negligible impact on the macroinvertebrate 
## community.
## Statistical comparison:
comb.fam.regression <- glm.nb(comb.fam.richness ~ Crucian, data=comb.fam.alpha)
summary(comb.fam.regression)
anova(comb.fam.regression, test = "Chi")
drop1(comb.fam.regression, test = "Chi")
summary(glht(glm.nb(comb.fam.richness ~ Crucian, data=comb.fam.alpha), 
             linfct=mcp(Crucian="Tukey")))

## Check model meets GLM assumptions
## Test for overdispersion
17.989/16
1-pchisq(17.989, df=16)  # not overdispersed

## Plot the fitted data against the observed data
plot(comb.fam.alpha$comb.fam.richness ~ fitted(comb.fam.regression))

## Hosmer and Lemeshow Goodness of Fit Test
hoslem.test(comb.fam.alpha$comb.fam.richness, fitted(comb.fam.regression))

## Model supposedly fits well as p-value is not significant 
## i.e. no significant difference between the model and the observed data

## Perform model validation checks to ensure model is good fit to data and 
## making reliable predictions
## Assumption 1: residuals are normally distributed
sresid <- resid(comb.fam.regression, type = "pearson")
hist(sresid)
lines(density(sresid,adjust=1))
qqnorm(sresid, cex=1.8, pch=20)
qqline(sresid, lty=2, lwd=2)
chkres(comb.fam.regression)
shapiro.test(sresid) # P = 0.5825

## No deviation from normality as residuals are normally distributed
## therefore model is reliable.

## Assumption 2: no heteroscedascity
## Plot standardised residuals against each independent variable to 
## identify any source of heterogeneity i.e. independent variable that is 
## non-linearly associated with y
plot(sresid ~ comb.fam.regression$fitted.values, pch=20, cex=2, cex.lab=1.5)
plot(sresid ~ comb.fam.alpha$Crucian, pch=20, cex=2, cex.lab=1.5) # No heteroscedascity

## Assumption 3: no collinearity
## Only one variable being modelled so no collinearity present.

## Assumption 4: no serial auto-correlation
## can arise if there are unaccounted for relationships in data set or
## if there is confounding effect of time or space
durbinWatsonTest(comb.fam.regression)

## No significant serial auto-correlation as p-value not significant
## Use graphical approach with Auto-Correlation Function (ACF)
acf(sresid, main = "Auto-correlation plot")
## Some autocorrelation at first time lag

## Assumption 5: model not biased by unduly influential observations
influence <- influence.measures(comb.fam.regression)
summary(influence)
CD <- cooks.distance(comb.fam.regression)
plot(CD ~ sresid)

## Model finds no significant effect of crucian carp on alpha diversity
## NB: other indexes of alpha diversity, such as Fishers Alpha and Shannon
## diversity, could not be used as they take abundance into account.
## We do not know whether sequencing data accurately reflects specimen
## abundance, thus we treat all data as presence-absence.

## Was sample size enough to accurately represent macroinvertebrate
## diversity?
## Plot species accumulation curve across ponds
plot(specaccum(comb.fam.df), 
     xlab = "Number of ponds", 
     ylab = "Number of families",
     ci.type="polygon", ci.col="grey")

## More ponds would have been required to fully represent macroinvertebrate
## diversity.


#' 
#' Alpha diversity of different invertebrate groups in ponds with and without
#' crucian carp.
#' 

## Import data containing order information for invertebrate species and families
fam.order <- read.csv("../Data/Invertebrate_family_order_data.csv", header=TRUE)

## Make columns in each dataframe characters rather than factor variables
fam.order$Family <- as.character(fam.order$Family)
fam.order$Group <- as.character(fam.order$Group)

## Transpose dataframe
order.fam.df <- data.frame(t(comb.order.fam))

## Tranform data to presence-absence
order.fam.df[order.fam.df > 0] <- 1

## Make row names a new column in dataframe
order.fam.df$Family <- rownames(order.fam.df)
order.fam.df <- order.fam.df[,c(19,1:18)]
rownames(order.fam.df) <- NULL

## Add order data to netting data
order.fam.df <- merge(order.fam.df, fam.order, by.x="Family", by.y="Family", all.x=TRUE)
order.fam.df <- order.fam.df[,c(1,20,2:19)]

## Remove species column, and merge data by order
order.fam.df <- order.fam.df[,-1]
order.fam.df <- ddply(order.fam.df, .(Group), numcolwise(sum))

## Make Group column row names and transpose dataframe
rownames(order.fam.df) <- order.fam.df$Group
order.fam.df <- order.fam.df[,-1]
order.fam.dat <- data.frame(t(order.fam.df))

## Make row names column in dataframe
order.fam.dat$Pond <- rownames(order.fam.dat)
order.fam.dat <- order.fam.dat[,c(25,1:24)]
rownames(order.fam.dat) <- NULL

## Create new column specifying whether pond contains crucian carp
order.fam.dat$Crucian <- factor(ifelse(order.fam.dat$Pond %in% metadata$Site, as.character(metadata$Crucian), "NA"))
order.fam.dat <- order.fam.dat[,c(1,26,2:25)]

## Melt dataframe and rename new columns
order.fam.melt <- melt(order.fam.dat, id=c("Pond","Crucian"))
colnames(order.fam.melt)[3:4] <- c("Group","Richness")

## Plot Group richness in crucian carp and non-fish ponds
p5bi <- ggplot(order.fam.melt[order.fam.melt$Group %in% c("Annelida","Arachnida",
                                                          "Bryozoa","Cnidaria",
                                                          "Coleoptera","Collembola",
                                                          "Crustacea","Diptera",
                                                          "Ephemeroptera","Gastrotricha",
                                                          "Hemiptera","Hirudinea"),],
               aes(x=Crucian, y=Richness))
p5bi <- p5bi + geom_jitter(aes(colour=Crucian), width=0.2, show.legend=FALSE)
p5bi <- p5bi + geom_boxplot(alpha=0.7, outlier.shape=NA)
p5bi <- p5bi + coord_cartesian(ylim=c(0,10))
p5bi <- p5bi + scale_y_continuous(breaks=seq(0,16,1))
p5bi <- p5bi + labs(title="(b) Family-level",
                    x="", y=expression(alpha~diversity))
p5bi <- p5bi + scale_colour_manual(values=c("grey40","deepskyblue2"))
p5bi <- p5bi + scale_x_discrete(breaks=c("N","Y"),
                                labels=c("Absent","Present"))
p5bi <- p5bi + theme_bw()
p5bi <- p5bi + theme(panel.background = element_rect(fill = "white"),
                     panel.grid.major = element_blank(), 
                     panel.grid.minor = element_blank(),
                     plot.title = element_text(face="bold", hjust=0, colour="black"),
                     plot.subtitle = element_text(face="bold", hjust=0, colour="black", margin=unit(c(2,0,2,0), "mm")),
                     axis.line.x = element_line(colour="black", size=0.5, linetype="solid"),
                     axis.line.y = element_line(colour="black", size=0.5, linetype="solid"),
                     axis.title.x = element_blank(),
                     axis.title.y = element_text(margin=unit(c(0, 5, 0, 0), "mm")),
                     axis.text.x = element_text(colour="black", size=12),
                     axis.text.y = element_text(colour="black", size=20),
                     strip.text.x = element_text(size=12),
                     legend.position = "none",
                     text = element_text(size=20))
p5bi <- p5bi + facet_grid(. ~ Group)
p5bi

p5bii <- ggplot(order.fam.melt[order.fam.melt$Group %in% c("Hymenoptera","Lepidoptera",
                                                   "Megaloptera","Mollusca",
                                                   "Nematoda","Odonata",
                                                   "Platyhelminthes","Psocoptera",
                                                   "Rotifera","Tardigrada",
                                                   "Thysanoptera","Trichoptera"),],
                aes(x=Crucian, y=Richness))
p5bii <- p5bii + geom_jitter(aes(colour=Crucian), width=0.2, show.legend=FALSE)
p5bii <- p5bii + geom_boxplot(alpha=0.7, outlier.shape=NA)
p5bii <- p5bii + coord_cartesian(ylim=c(0,10))
p5bii <- p5bii + scale_y_continuous(breaks=seq(0,16,1))
p5bii <- p5bii + labs(x="Crucian carp", y=expression(alpha~diversity))
p5bii <- p5bii + scale_colour_manual(values=c("grey40","deepskyblue2"))
p5bii <- p5bii + scale_x_discrete(breaks=c("N","Y"),
                                  labels=c("Absent","Present"))
p5bii <- p5bii + theme_bw()
p5bii <- p5bii + theme(panel.background = element_rect(fill = "white"),
                       panel.grid.major = element_blank(), 
                       panel.grid.minor = element_blank(),
                       plot.title = element_text(face="bold", hjust=0, colour="black"),
                       axis.line.x = element_line(colour="black", size=0.5, linetype="solid"),
                       axis.line.y = element_line(colour="black", size=0.5, linetype="solid"),
                       axis.title.x = element_text(margin=unit(c(8, 0, 0, 0), "mm")),
                       axis.title.y = element_text(margin=unit(c(0, 5, 0, 0), "mm")),
                       axis.text.x = element_text(colour="black", size=12),
                       axis.text.y = element_text(colour="black", size=20),
                       strip.text.x = element_text(size=12),
                       legend.position = "none",
                       text = element_text(size=20))
p5bii <- p5bii + facet_grid(. ~ Group)
p5bii

## Plot species-level and family-level results alongside one another
p5 <- grid.arrange(p5ai,p5aii,p5bi,p5bii, nrow=4)

## Statistically test for differences in invertebrate species richness
order.alpha.regression <- glm.nb(Richness ~ Group/Crucian, data=order.fam.melt)
summary(order.alpha.regression)
anova(order.alpha.regression, test = "Chi")
drop1(order.alpha.regression, test = "Chi")

## Check model meets GLM assumptions
## Test for overdispersion
270.59/384
1-pchisq(270.59, df=384)  # not overdispersed

## Plot the fitted data against the observed data
plot(order.fam.melt$Richness ~ fitted(order.alpha.regression))

## Hosmer and Lemeshow Goodness of Fit Test
hoslem.test(order.fam.melt$Richness, fitted(order.alpha.regression))

## Model supposedly fits well as p-value is not significant 
## i.e. no significant difference between the model and the observed data

## Perform model validation checks to ensure model is good fit to data and 
## making reliable predictions
## Assumption 1: residuals are normally distributed
sresid <- resid(order.alpha.regression, type = "pearson")
hist(sresid)
lines(density(sresid,adjust=1))
qqnorm(sresid, cex=1.8, pch=20)
qqline(sresid, lty=2, lwd=2)
chkres(order.alpha.regression)
shapiro.test(sresid) # P = 1.364e-13

## Some deviation from normality as residuals are normally distributed
## therefore model may not be reliable.

## Assumption 2: no heteroscedascity
## Plot standardised residuals against each independent variable to 
## identify any source of heterogeneity i.e. independent variable that is 
## non-linearly associated with y
plot(sresid ~ order.alpha.regression$fitted.values, pch=20, cex=2, cex.lab=1.5)
plot(sresid ~ order.fam.melt$Crucian, pch=20, cex=2, cex.lab=1.5) # No heteroscedascity
plot(sresid ~ order.fam.melt$Group, pch=20, cex=2, cex.lab=1.5) # No heteroscedascity

## Assumption 3: no collinearity
vif(order.alpha.regression)

## Assumption 4: no serial auto-correlation
## can arise if there are unaccounted for relationships in data set or
## if there is confounding effect of time or space
durbinWatsonTest(order.alpha.regression)

## No significant serial auto-correlation as p-value not significant
## Use graphical approach with Auto-Correlation Function (ACF)
acf(sresid, main = "Auto-correlation plot")
## Some autocorrelation at first time lag

## Assumption 5: model not biased by unduly influential observations
influence <- influence.measures(order.alpha.regression)
summary(influence)
CD <- cooks.distance(order.alpha.regression)
plot(CD ~ sresid)

## Cook's distance < 1 so observations not exerting strong influence on model
## parameters



#'
#' ## Beta diversity
#' 
#' Previously, only the impact of crucian carp presence-absence on pond 
#' invertebrate communities was examined. Now that we have combined the data
#' from all three methods and thus have the most holistic invertebrate
#' inventories for each pond, we will look at the impact of abiotic variables
#' in conjunction with crucian carp presence-absence. We will use Reduncy 
#' Analysis (RDA) and variance partitioning to partition the variation in pond
#' invertebrate community composition by biotic and abiotic variable for each
#' component of beta diversity, i.e. nestedness, turnover, and total beta 
#' diversity.
#' 
#' The environmental metadata was previously tidied and variable groups created
#' for the species-level analysis. Repeat RDA and variation partitioning for 
#' each component of beta diversity at family level
#'

## Examine beta diversity across all ponds
comb.fam.multi <- beta.multi(comb.fam.pa, index.family="jaccard")
print(comb.fam.multi)

## The majority of total beta diversity arises from species turnover
## rather than nestedness.

## Sampling across equal sites
comb.fam.samp <- beta.sample(comb.fam.pa, 
                             index.family="jaccard",
                             sites=8,                # minimum no. of sites in a group
                             samples=100)

## Plotting the distributions of components
dist.comb.fam.samp <- comb.fam.samp$sampled.values
plot(density(dist.comb.fam.samp$beta.JAC),xlim=c(0,1), ylim=c(0,100), 
     xlab='Beta diversity', main='', lwd=3)
lines(density(dist.comb.fam.samp$beta.JAC), lty=1, lwd=2)
lines(density(dist.comb.fam.samp$beta.JNE), lty=1, lwd=2)
lines(density(dist.comb.fam.samp$beta.JTU), lty=2, lwd=2)

## Now get pairwise between-site values of each component of beta diversity
comb.fam.dist <- beta.pair(comb.fam.pa, index.family="jaccard")

## Convert each partition of beta diversity to a matrix if you want to 
## write as a csv file
#comb.fam.turn <- as.matrix(dist(comb.fam.dist$beta.jtu))
#comb.fam.nest <- as.matrix(dist(comb.fam.dist$beta.jne))
#comb.fam.total <- as.matrix(dist(comb.fam.dist$beta.jac))


## 1. TURNOVER PARTITION (COMPLETE CHANGE IN COMMUNITIES)

## First, test whether ponds with and without crucian carp have different
## communities using PERMANOVA and visualise differences with NMDS
comb.fam.bd.turn <- betadisper(comb.fam.dist$beta.jtu, metadata$Crucian)

## Check homogeneity of multivariate dispersions. Groups being tested should 
## have the sample multivariate spread to conform to assumptions of PERMANOVA
mod.turn <- with(metadata, comb.fam.bd.turn)
mod.turn

## Compute mean distance to centroid per group
tapply(comb.fam.bd.turn$distances, metadata$Crucian, mean)

## Compute variance per group
tapply(comb.fam.bd.turn$distances, metadata$Crucian, var)

## Ordination plot of turnover partition
plot(comb.fam.bd.turn)

## Boxplot of turnover partition
boxplot(comb.fam.bd.turn, xlab="Crucian carp", xaxt="n", bty="n")
axis(side=1, at=c(1,2), labels=c("Absent","Present"))

## Plots indicate that there is some difference in turnover partition
## of beta diversity between crucian and non-crucian ponds. 
## Statistically check whether turnover is different in crucian and
## non-crucian ponds using standard parametric anova or permutation
## tests.
anova(comb.fam.bd.turn)     # No significant difference between ponds
permutest(comb.fam.bd.turn) # No significant difference between ponds

## Analyse pairwise differences between groups (crucian/non-crucian) using 
## parametric Tukey's HSD test.
TukeyHSD(comb.fam.bd.turn)  # No significant difference between groups

## Ordination of beta diversity partitioned by turnover:
## The metaMDS function automatically transforms data and checks solution
## robustness
comb.fam.bd.turn <- metaMDS(comb.fam.dist$beta.jtu, dist = "jaccard")

## Assess goodness of ordination fit (stress plot)
stressplot(comb.fam.bd.turn)

## plot site scores as text
ordiplot(comb.fam.bd.turn, display = "sites", type = "text")

## Build data frame with NMDS coordinates and metadata
comb.NMDS1 <- comb.fam.bd.turn$points[,1]
comb.NMDS2 <- comb.fam.bd.turn$points[,2]
comb.fam.turn.NMDS <- data.frame(NMDS1=comb.NMDS1, 
                                 NMDS2=comb.NMDS2,
                                 Crucian = metadata$Crucian)

## Check data
head(comb.fam.turn.NMDS)

## Plot data frame
p4j <- ggplot(comb.fam.turn.NMDS, aes(x=NMDS1, y=NMDS2, colour=Crucian))
p4j <- p4j + geom_point() + stat_ellipse()
p4j <- p4j + labs(subtitle="(iv) Methods combined", x="NMDS1", y="NMDS2")
p4j <- p4j + coord_cartesian(xlim=c(-1,1), ylim=c(-1,1))
p4j <- p4j + scale_colour_manual(name="Crucian carp",
                                 breaks=c("N","Y"),
                                 labels=c("Absent","Present"),
                                 values=c("grey40","deepskyblue2"))
p4j <- p4j + theme(panel.background = element_rect(fill = 'white'),
                   axis.line.x = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.line.y = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.title.x = element_text(margin = unit(c(8, 0, 0, 0), "mm")),
                   axis.title.y = element_text(margin = unit(c(0, 5, 0, 0), "mm")),
                   axis.text.x = element_text(colour="black"),
                   axis.text.y = element_text(colour="black"),
                   plot.title = element_text(face="bold", hjust=0, colour="black"),
                   plot.subtitle = element_text(face="bold", hjust=0, colour="black", margin = unit(c(2, 0, 0, 0), "mm")),
                   text = element_text(size=20),
                   legend.position="none")
p4j

## Statistically check difference in spatial turnover of communities
comb.fam.turn.anosim <- anosim(comb.fam.dist$beta.jtu, metadata$Crucian)

## Inspect results
comb.fam.turn.anosim
summary(comb.fam.turn.anosim)
plot(comb.fam.turn.anosim)

## There appears to be no significant difference in spatial turnover
## Look at PermANOVA using adonis(), considered more robust than anosim()
comb.fam.turn.adonis <- adonis(comb.fam.dist$beta.jtu ~ Crucian, metadata)

## Inspect results
## no summary() or plot() methods included
comb.fam.turn.adonis

## Again result is not significant. The combined data indicates there is no
## substantial difference in species replacement (i.e. turnover) between
## ponds with crucian carp and ponds without crucian carp. Therefore,
## species in ponds with no fish are not substituted by species in ponds
## with crucian carp.


## Use RDA and variance partitioning to examine the influence of biotic and 
## abiotic variables on turnover partition of beta diversity

## First, compute principal coordinate decomposition (classical scaling) for 
## turnover distance matrix using the pcoa() function from the ape package. Use 
## lingoes correction to account for negative eigenvalues.
pcoa.jtu <- pcoa(comb.fam.dist$beta.jtu, correction="lingoes", rn=NULL)

## Inspect outputs
pcoa.jtu$correction
pcoa.jtu$note
pcoa.jtu$trace

## The principal component coordinates for each diversity matrix can be written
## to a csv file for inspection
#write.csv(pcoa.jtu$vectors, "../Data/Combined_data_family_turnover_eigenvectors.csv")

## Groups of variables for RDA were already created for species-level analysis
## Perform forward model selection for each group of explanatory variables
## Adjusted R-squared will be used as a goodness-of-fit measure. Model selection
## needs to be performed for each group of variables, excluding those containing
## only one variable.
abiotic.rda.null <- rda(pcoa.jtu$vectors ~ 1, abiotic)  # null model
abiotic.rda.all <- rda(pcoa.jtu$vectors ~ ., abiotic)   # model with all variables
step.env <- ordiR2step(abiotic.rda.null, abiotic.rda.all, 
                       direction="forward", perm.max = 1000)

## Summary table and plot:
step.env$anova
plot(step.env)
## Indicates that no abiotic variables should be included in model.

## Run RDA with biotic variable
## Test for significance of the whole model:
mod2 <- rda(pcoa.jtu$vectors ~ biotic$Crucian)
summary(mod2)
coef(mod2)       # canonical coefficients
vif.cca(mod2)    # no collinearity present in model
mod2             # 9.26% variance is explained by variables in model
anova(mod2)      # Model is significant
RsquareAdj(mod2) # 3.59% variance explained
plot(mod2)

## Inertia is another name for variation or variance in this case. Total refers to 
## total variance, Constrained refers to the amount of variance explained by the 
## explanatory variables, Unconstrained? refers to the residual variance. Constrained + 
## Unconstrained = Total. An R2 statistic can be derived simply as Constrained/Total. 
## The function RsquareAdj computes R2 and R2-adjusted. The variable Rank indicates 
## the number of variables included. The eigenvalues are displayed for both the 
## constrained and unconstrained axes. In this context, these eigenvalues indicate 
## how much variance each of the axes contribute to.

## Check whether any variables should be dropped from model
drop1(mod2, test="perm")
## Crucian carp presence-absence is significant and therefore shouldn't be dropped

## Plot model result to get a sense of which variables are correlating with which 
## ponds along which axes
plot(mod2, type='n', scaling=1)
orditorp(mod2, display='sp', cex=0.5, scaling=1, col='blue')
text(mod2, display='cn', col='red')

## Plot of variables against sites
plot(mod2, type = "text")

## Perform hypothesis testing
anova(mod2, perm=1000)               # overall model fit
anova(mod2, by="margin", perm=1000)  # significance of marginal effects (Type III)
anova(mod2, by="term", perm=1000)    # significance of each term in model
anova(mod2, by="axis", perm=1000)    # significance of each axis


## 2. NESTEDNESS PARTITION (SUBSET OF CHANGE IN WIDER COMMUNITY)
comb.fam.bd.nest <- betadisper(comb.fam.dist$beta.jne, metadata$Crucian)

## Check homogeneity of multivariate dispersions. Groups being tested should 
## have the sample multivariate spread to conform to assumptions of PERMANOVA
comb.fam.nest <- with(metadata, comb.fam.bd.nest)
comb.fam.nest

## Compute mean distance to centroid per group
tapply(comb.fam.bd.nest$distances, metadata$Crucian, mean)

## Compute variance per group
tapply(comb.fam.bd.nest$distances, metadata$Crucian, var)

## Ordination plot of turnover partition
plot(comb.fam.bd.nest)

## Boxplot of turnover partition
boxplot(comb.fam.bd.nest, xlab="Crucian carp", xaxt="n", bty="n")
axis(side=1, at=c(1,2), labels=c("Absent","Present"))

## Plots indicates that there is no difference in nestedness partition
## of beta diversity between crucian and non-crucian ponds. 
## Statistically check whether nestedness is different in crucian and
## non-crucian ponds using standard parametric anova or permutation
## tests.
anova(comb.fam.bd.nest)     # No significant difference between ponds
permutest(comb.fam.bd.nest) # No significant difference between ponds

## Analyse pairwise differences between groups using parametric Tukey's HSD 
## test.
TukeyHSD(comb.fam.bd.nest)  # No significant difference between ponds

## Ordination of beta diversity partitioned by nestedness:
comb.fam.comm.nest <- metaMDS(comb.fam.dist$beta.jne, dist = "jaccard")

## Assess goodness of ordination fit (stress plot)
stressplot(comb.fam.comm.nest)

## plot site scores as text
ordiplot(comb.fam.comm.nest, display = "sites", type = "text")

## Build data frame with NMDS coordinates and metadata
comb.NMDS1 <- comb.fam.comm.nest$points[,1]
comb.NMDS2 <- comb.fam.comm.nest$points[,2]
comb.fam.nest.NMDS <- data.frame(NMDS1=comb.NMDS1, 
                                 NMDS2=comb.NMDS2,
                                 Crucian = metadata$Crucian)

## Check data
head(comb.fam.nest.NMDS)

## Plot data frame
p4k <- ggplot(comb.fam.nest.NMDS, aes(x=NMDS1, y=NMDS2, colour=Crucian))
p4k <- p4k + geom_point() + stat_ellipse()
p4k <- p4k + labs(subtitle="", x="NMDS1", y="")
p4k <- p4k + coord_cartesian(xlim=c(-1,1), ylim=c(-1,1))
p4k <- p4k + scale_colour_manual(name="Crucian carp",
                                 breaks=c("N","Y"),
                                 labels=c("Absent","Present"),
                                 values=c("grey40","deepskyblue2"))
p4k <- p4k + theme(panel.background = element_rect(fill = 'white'),
                   axis.line.x = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.line.y = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.title.x = element_text(margin = unit(c(8, 0, 0, 0), "mm")),
                   axis.title.y = element_text(margin = unit(c(0, 5, 0, 0), "mm")),
                   axis.text.x = element_text(colour="black"),
                   axis.text.y = element_text(colour="black"),
                   plot.title = element_text(face="bold", hjust=0, colour="black"),
                   plot.subtitle = element_text(face="bold", hjust=0, colour="black", margin = unit(c(2, 0, 0, 0), "mm")),
                   text = element_text(size=20),
                   legend.position="none")
p4k

## Statistically check difference in nestedness of communities
comb.fam.nest.anosim <- anosim(comb.fam.dist$beta.jne, metadata$Crucian)

## Inspect results
comb.fam.nest.anosim
summary(comb.fam.nest.anosim)
plot(comb.fam.nest.anosim)

## There appears to be no significant difference in nestedness
## Look at PermANOVA using adonis(), considered more robust than anosim()
comb.fam.nest.adonis <- adonis(comb.fam.dist$beta.jne ~ Crucian, metadata)

## Inspect results
## no summary() or plot() methods included
comb.fam.nest.adonis

## Result is not significant. The combined data indicates there is no
## substantial difference in species loss or gain (i.e. nestedness) 
## between ponds with crucian carp and ponds without crucian carp.


## Use RDA and variance partitioning to examine the influence of biotic and 
## abiotic variables on turnover partition of beta diversity

## First, compute principal coordinate decomposition (classical scaling) for 
## turnover distance matrix using the pcoa() function from the ape package. Use 
## lingoes correction to account for negative eigenvalues.
pcoa.jne <- pcoa(comb.fam.dist$beta.jne, correction="lingoes", rn=NULL)

## Inspect outputs
pcoa.jne$correction
pcoa.jne$note
pcoa.jne$trace

## The principal component coordinates for each diversity matrix can be written
## to a csv file for inspection
#write.csv(pcoa.jne$vectors, "../Data/Combined_data_family_nestedness_eigenvectors.csv")

## Groups of variables for RDA were already created for species-level analysis
## Perform forward model selection for each group of explanatory variables
## Adjusted R-squared will be used as a goodness-of-fit measure. Model selection
## needs to be performed for each group of variables, excluding those containing
## only one variable.
abiotic.rda.null <- rda(pcoa.jne$vectors ~ 1, abiotic)  # null model
abiotic.rda.all <- rda(pcoa.jne$vectors ~ ., abiotic)   # model with all variables
step.env <- ordiR2step(abiotic.rda.null, abiotic.rda.all, 
                       direction="forward", perm.max = 1000)

## Summary table and plot:
step.env$anova
plot(step.env)
## Indicates that no abiotic variables should be included in model.

## Run RDA with biotic variable
## Test for significance of the whole model:
mod2 <- rda(pcoa.jne$vectors ~ biotic$Crucian)
summary(mod2)
coef(mod2)       # canonical coefficients
vif.cca(mod2)    # no collinearity present in model
mod2             # 5.6% variance is explained by variables in model
anova(mod2)      # Model is not significant
RsquareAdj(mod2) # -0.003% variance explained?
plot(mod2)

## Inertia is another name for variation or variance in this case. Total refers to 
## total variance, Constrained refers to the amount of variance explained by the 
## explanatory variables, Unconstrained? refers to the residual variance. Constrained + 
## Unconstrained = Total. An R2 statistic can be derived simply as Constrained/Total. 
## The function RsquareAdj computes R2 and R2-adjusted. The variable Rank indicates 
## the number of variables included. The eigenvalues are displayed for both the 
## constrained and unconstrained axes. In this context, these eigenvalues indicate 
## how much variance each of the axes contribute to.

## Check whether any variables should be dropped from model
drop1(mod2, test="perm")
## Crucian carp presence-absence should potentially be dropped

## Plot model result to get a sense of which variables are correlating with which 
## ponds along which axes
plot(mod2, type='n', scaling=1)
orditorp(mod2, display='sp', cex=0.5, scaling=1, col='blue')
text(mod2, display='cn', col='red')

## Plot of variables against sites
plot(mod2, type = "text")

## Perform hypothesis testing
anova(mod2, perm=1000)               # overall model fit
anova(mod2, by="margin", perm=1000)  # significance of marginal effects (Type III)
anova(mod2, by="term", perm=1000)    # significance of each term in model
anova(mod2, by="axis", perm=1000)    # significance of each axis


## 3. TOTAL BETA DIVERSITY
comb.fam.bd.total <- betadisper(comb.fam.dist$beta.jac, metadata$Crucian)

## Check homogeneity of multivariate dispersions. Groups being tested should 
## have the sample multivariate spread to conform to assumptions of PERMANOVA
mod.total <- with(metadata, comb.fam.bd.total)
mod.total

## Compute mean distance to centroid per group
tapply(comb.fam.bd.total$distances, metadata$Crucian, mean)

## Compute variance per group
tapply(comb.fam.bd.total$distances, metadata$Crucian, var)

## Ordination plot of total beta diversity
plot(comb.fam.bd.total)

## Boxplot of total beta diversity
boxplot(comb.fam.bd.total, xlab="Crucian carp", xaxt="n", bty="n")
axis(side=1, at=c(1,2), labels=c("Absent","Present"))

## Plots indicates that there is substantial difference in total beta diversity 
## between crucian and non-crucian ponds. 
## Statistically check whether total beta is different in crucian and
## non-crucian ponds using standard parametric anova or permutation
## tests.
anova(comb.fam.bd.total)     # Significant difference between ponds
permutest(comb.fam.bd.total) # Significant difference between ponds

## Analyse pairwise differences between groups using parametric Tukey's 
## HSD test.
TukeyHSD(comb.fam.bd.total)  # Significant difference between ponds

## Ordination of total beta diversity:
## The metaMDS function automatically transforms data and checks solution
## robustness
comb.fam.comm.total <- metaMDS(comb.fam.dist$beta.jac, dist = "jaccard")

## Assess goodness of ordination fit (stress plot)
stressplot(comb.fam.comm.total)

## plot site scores as text
ordiplot(comb.fam.comm.total, display = "sites", type = "text")

## Build data frame with NMDS coordinates and metadata
comb.NMDS1 <- comb.fam.comm.total$points[,1]
comb.NMDS2 <- comb.fam.comm.total$points[,2]
comb.fam.total.NMDS <- data.frame(NMDS1=comb.NMDS1,
                                  NMDS2=comb.NMDS2,
                                  Crucian = metadata$Crucian)

## Check data
head(comb.fam.total.NMDS)

## Plot data frame
p4l <- ggplot(comb.fam.total.NMDS, aes(x=NMDS1, y=NMDS2, colour=Crucian)) 
p4l <- p4l + geom_point() + stat_ellipse()
p4l <- p4l + labs(subtitle="", x="NMDS1", y="")
p4l <- p4l + coord_cartesian(xlim=c(-1,1), ylim=c(-1,1))
p4l <- p4l + scale_colour_manual(name="Crucian carp",
                                 breaks=c("N","Y"),
                                 labels=c("Absent","Present"),
                                 values=c("grey40","deepskyblue2"))
p4l <- p4l + theme(panel.background = element_rect(fill = 'white'),
                   axis.line.x = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.line.y = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.title.x = element_text(margin = unit(c(8, 0, 0, 0), "mm")),
                   axis.title.y = element_text(margin = unit(c(0, 5, 0, 0), "mm")),
                   axis.text.x = element_text(colour="black"),
                   axis.text.y = element_text(colour="black"),
                   plot.title = element_text(face="bold", hjust=0, colour="black"),
                   plot.subtitle = element_text(face="bold", hjust=0, colour="black", margin = unit(c(2, 0, 0, 0), "mm")),
                   text = element_text(size=20),
                   legend.position="none")
p4l

## Statistically check difference in total beta diversity of ponds
comb.fam.total.anosim <- anosim(comb.fam.dist$beta.jac, metadata$Crucian)

## Inspect results
comb.fam.total.anosim
summary(comb.fam.total.anosim)
plot(comb.fam.total.anosim)

## There appears to be a significant difference in total beta diversity
## Look at PermANOVA using adonis(), considered more robust than anosim()
comb.fam.total.adonis <- adonis(comb.fam.dist$beta.jac ~ Crucian, metadata)

## Inspect results
## no summary() or plot() methods included
comb.fam.total.adonis

## Again result is significant. The combined data indicates there is 
## substantial variation in overall species composition of
## ponds with crucian carp and ponds without crucian carp


## Use RDA and variance partitioning to examine the influence of biotic and 
## abiotic variables on turnover partition of beta diversity

## First, compute principal coordinate decomposition (classical scaling) for 
## turnover distance matrix using the pcoa() function from the ape package. Use 
## lingoes correction to account for negative eigenvalues.
pcoa.jac <- pcoa(comb.fam.dist$beta.jac, correction="lingoes", rn=NULL)

## Inspect outputs
pcoa.jac$correction
pcoa.jac$note
pcoa.jac$trace

## The principal component coordinates for each diversity matrix can be written
## to a csv file for inspection
#write.csv(pcoa.jac$vectors, "../Data/Combined_data_family_totalbeta_eigenvectors.csv")

## Groups of variables for RDA were already created for species-level analysis
## Perform forward model selection for each group of explanatory variables
## Adjusted R-squared will be used as a goodness-of-fit measure. Model selection
## needs to be performed for each group of variables, excluding those containing
## only one variable.
abiotic.rda.null <- rda(pcoa.jac$vectors ~ 1, abiotic)  # null model
abiotic.rda.all <- rda(pcoa.jac$vectors ~ ., abiotic)   # model with all variables
step.env <- ordiR2step(abiotic.rda.null, abiotic.rda.all, 
                       direction="forward", perm.max = 1000)

## Summary table and plot:
step.env$anova
plot(step.env)
## Indicates that no abiotic variables should be included in model.

## Run RDA with biotic variable
## Test for significance of the whole model:
mod2 <- rda(pcoa.jac$vectors ~ biotic$Crucian)
summary(mod2)
coef(mod2)       # canonical coefficients
vif.cca(mod2)    # no collinearity present in model
mod2             # 8.91% variance is explained by variables in model
anova(mod2)      # Model is significant
RsquareAdj(mod2) # 3.32% variance explained
plot(mod2)

## Inertia is another name for variation or variance in this case. Total refers to 
## total variance, Constrained refers to the amount of variance explained by the 
## explanatory variables, Unconstrained? refers to the residual variance. Constrained + 
## Unconstrained = Total. An R2 statistic can be derived simply as Constrained/Total. 
## The function RsquareAdj computes R2 and R2-adjusted. The variable Rank indicates 
## the number of variables included. The eigenvalues are displayed for both the 
## constrained and unconstrained axes. In this context, these eigenvalues indicate 
## how much variance each of the axes contribute to.

## Check whether any variables should be dropped from model
drop1(mod2, test="perm")
## Crucian carp presence-absence should not be dropped as it is significant

## Plot model result to get a sense of which variables are correlating with which 
## ponds along which axes
plot(mod2, type='n', scaling=1)
orditorp(mod2, display='sp', cex=0.5, scaling=1, col='blue')
text(mod2, display='cn', col='red')

## Plot of variables against sites
plot(mod2, type = "text")

## Perform hypothesis testing
anova(mod2, perm=1000)               # overall model fit
anova(mod2, by="margin", perm=1000)  # significance of marginal effects (Type III)
anova(mod2, by="term", perm=1000)    # significance of each term in model
anova(mod2, by="axis", perm=1000)    # significance of each axis


## Further exploration of total beta diversity
## Create matrix from total beta diversity dist object
comb.fam.beta.temp <- as.matrix(comb.fam.dist$beta.jac)
comb.fam.beta.temp
comb.fam.beta.temp2 <- t(combn(colnames(comb.fam.beta.temp),2))
comb.fam.beta <- data.frame(comb.fam.beta.temp2, dist=comb.fam.beta.temp[comb.fam.beta.temp2])
colnames(comb.fam.beta) <- c("Pond1","Pond2","Jaccard")

## Loop over jaccard data frame and create new column saying what type of 
## combination we have
comb.fam.beta$Combo <- factor(ifelse(comb.fam.beta$Pond1%in%crucian&comb.fam.beta$Pond2%in%crucian,"crucian-crucian",
                                 ifelse(comb.fam.beta$Pond1%in%crucian&comb.fam.beta$Pond2%in%non_crucian,"crucian-no crucian",
                                        ifelse(comb.fam.beta$Pond1%in%non_crucian&comb.fam.beta$Pond2%in%crucian,"crucian-no crucian",
                                               ifelse(comb.fam.beta$Pond2%in%non_crucian&comb.fam.beta$Pond2%in%non_crucian,"no crucian-no crucian",
                                                      "Fail")))))

## Regression examining whether Jaccard distance is influenced by site 
## combinations
comb.fam.beta.regression <- aov(Jaccard ~ Combo, data=comb.fam.beta)
summary(comb.fam.beta.regression)
anova(comb.fam.beta.regression)

## Tukey post-hoc test examining difference between groups
TukeyHSD(comb.fam.beta.regression, ordered = TRUE)

## Plot of jaccard distance across groups
p3i <- ggplot(comb.beta, aes(x=Combo, y=Jaccard))
p3i <- p3i + ggtitle("(i) Combined - family level")
p3i <- p3i + geom_jitter(aes(colour=Combo), width=0.2)
p3i <- p3i + geom_boxplot(alpha=0.7, outlier.colour="red") 
p3i <- p3i + scale_y_continuous(limits=c(0,1))
p3i <- p3i + scale_colour_manual(values=c("deepskyblue2","limegreen","goldenrod1"))
p3i <- p3i + annotate("text", 
                      x = c("crucian-crucian",
                            "crucian-no crucian",
                            "no crucian-no crucian"), 
                      y = 0.5, 
                      label = c("a","a","b"), cex=10)
p3i <- p3i + labs(x="Combination", y="Jaccard dissimilarity")
p3i <- p3i + theme(panel.background = element_rect(fill = "white"), 
                   axis.line.x = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.line.y = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.title.x = element_text(margin = unit(c(8, 0, 0, 0), "mm")),
                   axis.title.y = element_text(margin = unit(c(0, 5, 0, 0), "mm")),
                   axis.text.x = element_text(colour="black"),
                   axis.text.y = element_text(colour="black"),
                   plot.title = element_text(face="bold"),
                   text = element_text(size=20),
                   legend.key=element_blank(),
                   legend.key.size = unit(2, 'lines'))
p3i

## A useful way to examine this result is to build a "tree" from it. 
## Here, a tree (actually a dendrogram) is a way to cluster the sites 
## together based on how "far apart" they are in species composition; 
## sites which have very similar species compositions will group together 
## on the tree.
## Three methods of clustering but 'average' linkage method (based on the 
## average dissimilarity between groups of sites) usually most robust:
jacc.cla <- hclust(comb.fam.dist$beta.jac, method="average")
jacc.cls <- hclust(comb.fam.dist$beta.jac, method="single")
jacc.clc <- hclust(comb.fam.dist$beta.jac, method="complete")

## Display the classification trees for these methods and notice how the 
## shape of the trees changes.
plot(jacc.cla)
plot(jacc.cls)
plot(jacc.clc)

## Measure the correlation between your original dissimilarity matrix and 
## the inter-group dissimilarity at each step up the classification tree 
## via the cophenetic function:
cor(comb.fam.dist$beta.jac, cophenetic(jacc.cla))
cor(comb.fam.dist$beta.jac, cophenetic(jacc.cls))
cor(comb.fam.dist$beta.jac, cophenetic(jacc.clc))

## Average linkage method appears to have strongest correlation
## Plot dendrogram of site Jaccard dissimilarity
plot(jacc.cla, hang = -1,
     main = "Sites clustered by Jaccard similarity",
     axes = FALSE, ylab = "")


#' 
#' The combined family data indicates that there is no difference in alpha diversity,
#' but there is a difference in beta diversity of ponds with or without crucian 
#' carp. This difference in total beta diversity stems from species turnover, 
#' as opposed to nestedness.
#' 



#' ---
#' 
#' 4) Comparing conventional and molecular methods
#' 
#' Each monitoring tool individually produced slightly different results, especially in
#' terms of diversity. How concordent are these tools for macroinvertebrate 
#' assessment?
#'  

## Remove empty taxonomic assignments
method.df <- method.df[!sapply(method.df, function(x) all(x == 0))]

#'
#' ## Data transformation
#' 
#' From now on, all data exploration and analyses will take place in the 
#' vegan package.
#' 

## Tranform data
method.pa <- decostand(method.df, method = "pa", MARGIN = 1) # by rows (ponds)
head(comb.pa[,1:3], n = 3)


#'
#' ## Alpha diversity
#' 

## Basic richness - two ways to calculate:
method.richness <- specnumber(method.pa)
method.richness

## Plot alpha diversity
## Create data frame
method.alpha <- data.frame(method.richness)

## Add metadata
method.alpha <- cbind(comb.metadata[,1:3], method.alpha)
str(method.alpha)
method.alpha$Sample <- as.factor(method.alpha$Sample)
method.alpha$Method <- as.factor(method.alpha$Method)

## Reset row names of data frame for further indexing
rownames(method.alpha) <- NULL

## Statistically compare whether method influences alpha diversity
method.regression <- glm.nb(method.richness ~ Method, data=method.alpha)
summary(method.regression)
anova(method.regression, test = "Chi")
drop1(method.regression, test = "Chi")

## Test difference between groups
summary(glht(glm.nb(method.richness ~ Method, data=method.alpha), 
             linfct=mcp(Method="Tukey")))

## Significant difference between means of:
## Netting-DNA
## Netting-eDNA

## Check model meets GLM assumptions
## Test for overdispersion
54.867/51
1-pchisq(54.867, df=51)  # not overdispersed

## Plot the fitted data against the observed data
plot(method.alpha$method.richness ~ fitted(method.regression))

## Hosmer and Lemeshow Goodness of Fit Test
hoslem.test(method.alpha$method.richness, fitted(method.regression))

## Model supposedly fits well as p-value is not significant 
## i.e. no significant difference between the model and the observed data

## Perform model validation checks to ensure model is good fit to data and 
## making reliable predictions
## Assumption 1: residuals are normally distributed
sresid <- resid(method.regression, type = "pearson")
hist(sresid)
lines(density(sresid,adjust=1))
qqnorm(sresid, cex=1.8, pch=20)
qqline(sresid, lty=2, lwd=2)
chkres(method.regression)
shapiro.test(sresid) # P = 0.5825

## No deviation from normality as residuals are normally distributed
## therefore model is reliable.

## Assumption 2: no heteroscedascity
## Plot standardised residuals against each independent variable to 
## identify any source of heterogeneity i.e. independent variable that is 
## non-linearly associated with y
plot(sresid ~ method.regression$fitted.values, pch=20, cex=2, cex.lab=1.5)
plot(sresid ~ method.alpha$Crucian, pch=20, cex=2, cex.lab=1.5) # No heteroscedascity

## Assumption 3: no collinearity
## Only one variable being modelled so no collinearity present.

## Assumption 4: no serial auto-correlation
## can arise if there are unaccounted for relationships in data set or
## if there is confounding effect of time or space
durbinWatsonTest(method.regression)

## No significant serial auto-correlation as p-value not significant
## Use graphical approach with Auto-Correlation Function (ACF)
acf(sresid, main = "Auto-correlation plot")
## Some autocorrelation at first time lag

## Assumption 5: model not biased by unduly influential observations
influence <- influence.measures(method.regression)
summary(influence)
CD <- cooks.distance(method.regression)
plot(CD ~ sresid)


## Plot species richness
m1 <- ggplot(method.alpha, aes(x=Method, y=method.richness))
m1 <- m1 + ggtitle("(a) Species-level")
m1 <- m1 + geom_jitter(aes(colour=Method), cex=2, pch=16, width=0.2, show.legend=FALSE)
m1 <- m1 + geom_boxplot(alpha=0.7, outlier.shape=NA)
m1 <- m1 + scale_y_continuous(limits=c(0,80))
m1 <- m1 + annotate("text", x = c("DNA","eDNA","Netting"), y = 70, 
                    label = c("a","b","c"), cex=10)
m1 <- m1 + labs(x="Method", y=expression(alpha~Diversity))
m1 <- m1 + scale_colour_manual(values=c("purple","orange","limegreen"))
m1 <- m1 + theme(panel.background = element_rect(fill = 'white'),
                   axis.line.x = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.line.y = element_line(colour = 'black', size=0.5, linetype='solid'),
                   axis.title.x = element_text(margin = unit(c(8, 0, 0, 0), "mm")),
                   axis.title.y = element_text(margin = unit(c(0, 5, 0, 0), "mm")),
                   axis.text.x = element_text(colour="black"),
                   axis.text.y = element_text(colour="black"),
                   plot.title = element_text(face="bold", hjust=0),
                   legend.position = "none",
                   text = element_text(size=20))
m1

## Species richness appears to be highest with eDNA metabarcoding, followed by
## DNA metabarcoding then netting.



#'
#' ## Beta diversity
#' 

## Now look at beta diversity in ponds with different methods.
## The beta.pair() function computes three dissimilarity metrics and uses 
## the argument index.family to calculate beta diversity according to 
## Sorensen or Jaccard index of total dissimilarity. The function returns 
## three matrices containing the pairwise between-site values of each 
## component of beta diversity (turnover, nestedness, total beta). The 
## dissimilarity matrices yielded by beta.pair are objects of class dist 
## and can be used for further analyses, e.g. NMDS, cluster analysis.
## (NB: Jaccard index is used to calculate beta diversity from 
## presence-absence data. Abundance data would use Bray-curtis 
## dissimilarity)

## Pairwise between-site values of each component of beta diversity
method.dist <- beta.pair(method.pa, index.family="jaccard")

## 1. TURNOVER PARTITION (COMPLETE CHANGE IN COMMUNITIES)
method.bd.turn <- betadisper(method.dist$beta.jtu, comb.metadata$Method)

## Check homogeneity of multivariate dispersions. Groups being tested should 
## have the sample multivariate spread to conform to assumptions of PERMANOVA
mod.turn <- with(comb.metadata, method.bd.turn)
mod.turn

## Compute mean distance to centroid per group
tapply(method.bd.turn$distances, comb.metadata$Method, mean)

## Compute variance per group
tapply(method.bd.turn$distances, comb.metadata$Method, var)

## Ordination plot of turnover partition
plot(method.bd.turn)

## Boxplot of turnover partition
boxplot(method.bd.turn, xlab="Method", xaxt="n", bty="n")
axis(side=1, at=c(1,2,3), labels=c("Bulk tissue","eDNA","Netting"))

## Plots indicate that there is some difference in turnover partition
## of beta diversity between methods. 
## Statistically check whether turnover is different between methods 
## using standard parametric anova or permutation tests.
anova(method.bd.turn)     # No significant difference between methods
permutest(method.bd.turn) # No significant difference between methods

## Analyse pairwise differences between groups (methods) using 
## parametric Tukey's HSD test.
TukeyHSD(method.bd.turn)  # No significant difference between groups

## Ordination of beta diversity partitioned by turnover:
## The metaMDS function automatically transforms data and checks solution
## robustness
method.comm.turn <- metaMDS(method.dist$beta.jtu, dist = "jaccard")

## Assess goodness of ordination fit (stress plot)
stressplot(method.comm.turn)

## plot site scores as text
ordiplot(method.comm.turn, display = "sites", type = "text")

## Build data frame with NMDS coordinates and metadata
method.NMDS1 <- method.comm.turn$points[,1]
method.NMDS2 <- method.comm.turn$points[,2]
method.turn.NMDS <- data.frame(NMDS1=method.NMDS1, 
                               NMDS2=method.NMDS2,
                               Method = comb.metadata$Method)

## Check data
head(method.turn.NMDS)

## Plot data frame
m2 <- ggplot(method.turn.NMDS, aes(x=NMDS1, y=NMDS2, colour=Method))
m2 <- m2 + geom_point() + stat_ellipse()
m2 <- m2 + coord_cartesian(xlim=c(-0.6,0.6), ylim=c(-0.6,0.6))
m2 <- m2 + labs(title="(a) Turnover", subtitle="(i) Species-level",
                x="",y="NMDS2")
m2 <- m2 + scale_colour_manual(name="Method",
                               values=c("purple","orange","limegreen"))
m2 <- m2 + theme(panel.background = element_rect(fill = 'white'),
                 axis.line.x = element_line(colour = 'black', size=0.5, linetype='solid'),
                 axis.line.y = element_line(colour = 'black', size=0.5, linetype='solid'),
                 axis.title.x = element_text(margin = unit(c(8, 0, 0, 0), "mm")),
                 axis.title.y = element_text(margin = unit(c(0, 5, 0, 0), "mm")),
                 axis.text.x = element_text(colour="black"),
                 axis.text.y = element_text(colour="black"),
                 plot.title = element_text(face="bold", hjust=0, colour="black"),
                 plot.subtitle = element_text(face="bold", hjust=0, color="black", margin = unit(c(2, 0, 0, 0), "mm")),
                 text = element_text(size=20),
                 legend.position = "bottom",
                 legend.key=element_blank(),
                 legend.key.size = unit(2, 'lines'))
m2

## Statistically check difference in spatial turnover of communities
method.turn.anosim <- anosim(method.dist$beta.jtu, comb.metadata$Method)

## Inspect results
method.turn.anosim
summary(method.turn.anosim)
plot(method.turn.anosim)

## There appears to be a significant difference in spatial turnover
## Look at PermANOVA using adonis(), considered more robust than anosim()
method.turn.adonis <- adonis(method.dist$beta.jtu ~ Method, comb.metadata)

## Inspect results
## no summary() or plot() methods included
method.turn.adonis

## Again result is significant. There is a substantial difference in 
## species replacement (i.e. turnover) between monitoring tools.
## Therefore, species produced by one method are substituted by species 
## with another method.


## 2. NESTEDNESS PARTITION (SUBSET OF CHANGE IN WIDER COMMUNITY)
method.bd.nest <- betadisper(method.dist$beta.jne, comb.metadata$Method)

## Check homogeneity of multivariate dispersions. Groups being tested should 
## have the sample multivariate spread to conform to assumptions of PERMANOVA
method.nest <- with(comb.metadata, method.bd.nest)
method.nest

## Compute mean distance to centroid per group
tapply(method.bd.nest$distances, comb.metadata$Method, mean)

## Compute variance per group
tapply(method.bd.nest$distances, comb.metadata$Method, var)

## Ordination plot of turnover partition
plot(method.bd.nest)

## Boxplot of turnover partition
boxplot(method.bd.nest, xlab="Method", xaxt="n", bty="n")
axis(side=1, at=c(1,2,3), labels=c("Bulk tissue","eDNA","Netting"))

## Plots indicates that there is no difference in nestedness partition
## of beta diversity between methods 
## Statistically check whether nestedness is different between methods
## using standard parametric anova or permutation tests.
anova(method.bd.nest)     # No significant difference between methods
permutest(method.bd.nest) # No significant difference between methods

## Analyse pairwise differences between groups using parametric Tukey's HSD 
## test.
TukeyHSD(method.bd.nest)  # No significant difference between methods

## Ordination of beta diversity partitioned by nestedness:
method.comm.nest <- metaMDS(method.dist$beta.jne, dist = "jaccard")

## Assess goodness of ordination fit (stress plot)
stressplot(method.comm.nest)

## plot site scores as text
ordiplot(method.comm.nest, display = "sites", type = "text")

## Build data frame with NMDS coordinates and metadata
method.NMDS1 <- method.comm.nest$points[,1]
method.NMDS2 <- method.comm.nest$points[,2]
method.nest.NMDS <- data.frame(NMDS1=method.NMDS1, 
                               NMDS2=method.NMDS2,
                               Method = comb.metadata$Method)

## Check data
head(method.nest.NMDS)

## Plot data frame
m3 <- ggplot(method.nest.NMDS, aes(x=NMDS1, y=NMDS2, colour=Method))
m3 <- m3 + geom_point() + stat_ellipse()
m3 <- m3 + coord_cartesian(xlim=c(-0.6,0.6), ylim=c(-0.6,0.6))
m3 <- m3 + labs(title="(b) Nestedness", subtitle="", x="", y="")
m3 <- m3 + scale_colour_manual(name="Method",
                               values=c("purple","orange","limegreen"))
m3 <- m3 + theme(panel.background = element_rect(fill = 'white'),
                 axis.line.x = element_line(colour = 'black', size=0.5, linetype='solid'),
                 axis.line.y = element_line(colour = 'black', size=0.5, linetype='solid'),
                 axis.title.x = element_text(margin = unit(c(8, 0, 0, 0), "mm")),
                 axis.title.y = element_text(margin = unit(c(0, 5, 0, 0), "mm")),
                 axis.text.x = element_text(colour="black"),
                 axis.text.y = element_text(colour="black"),
                 plot.title = element_text(face="bold", hjust=0, colour="black"),
                 plot.subtitle = element_text(face="bold", hjust=0, color="black", margin = unit(c(2, 0, 0, 0), "mm")),
                 text = element_text(size=20),
                 legend.position="none")
m3

## Statistically check difference in nestedness of communities
method.nest.anosim <- anosim(method.dist$beta.jne, comb.metadata$Method)

## Inspect results
method.nest.anosim
summary(method.nest.anosim)
plot(method.nest.anosim)

## There appears to be no significant difference in nestedness
## Look at PermANOVA using adonis(), considered more robust than anosim()
method.nest.adonis <- adonis(method.dist$beta.jne ~ Method, comb.metadata)

## Inspect results
## no summary() or plot() methods included
method.nest.adonis

## Result is not significant. There is no substantial difference in species 
## loss or gain (i.e. nestedness) between methods.


## 3. TOTAL BETA DIVERSITY
method.bd.total <- betadisper(method.dist$beta.jac, comb.metadata$Method)

## Check homogeneity of multivariate dispersions. Groups being tested should 
## have the sample multivariate spread to conform to assumptions of PERMANOVA
mod.total <- with(comb.metadata, method.bd.total)
mod.total

## Compute mean distance to centroid per group
tapply(method.bd.total$distances, comb.metadata$Method, mean)

## Compute variance per group
tapply(method.bd.total$distances, comb.metadata$Method, var)

## Ordination plot of total beta diversity
plot(method.bd.total)

## Boxplot of total beta diversity
boxplot(method.bd.total, xlab="Method", xaxt="n", bty="n")
axis(side=1, at=c(1,2,3), labels=c("Bulk tissue","eDNA","Netting"))

## Plots indicates that there is no difference in total beta diversity 
## between methods.
## Statistically check whether total beta is different between methods
## using standard parametric anova or permutation tests.
anova(method.bd.total)     # No significant difference between methods
permutest(method.bd.total) # No significant difference between methods

## Analyse pairwise differences between groups using parametric Tukey's 
## HSD test.
TukeyHSD(method.bd.total)  # No significant difference between methods

## Ordination of total beta diversity:
## The metaMDS function automatically transforms data and checks solution
## robustness
method.comm.total <- metaMDS(method.dist$beta.jac, dist = "jaccard")

## Assess goodness of ordination fit (stress plot)
stressplot(method.comm.total)

## plot site scores as text
ordiplot(method.comm.total, display = "sites", type = "text")

## Build data frame with NMDS coordinates and metadata
method.NMDS1 <- method.comm.total$points[,1]
method.NMDS2 <- method.comm.total$points[,2]
method.total.NMDS <- data.frame(NMDS1=method.NMDS1,
                                NMDS2=method.NMDS2,
                                Method=comb.metadata$Method)

## Check data
head(method.total.NMDS)

## Plot data frame
m4 <- ggplot(method.total.NMDS, aes(x=NMDS1, y=NMDS2, colour=Method))
m4 <- m4 + geom_point() + stat_ellipse()
m4 <- m4 + coord_cartesian(xlim=c(-0.6,0.6), ylim=c(-0.6,0.6))
m4 <- m4 + labs(title=expression(bold("(c) Total"~beta~"Diversity")),
                subtitle="", x="", y="")
m4 <- m4 + scale_colour_manual(name="Method",
                               values=c("purple","orange","limegreen"))
m4 <- m4 + theme(panel.background = element_rect(fill = 'white'),
                 axis.line.x = element_line(colour = 'black', size=0.5, linetype='solid'),
                 axis.line.y = element_line(colour = 'black', size=0.5, linetype='solid'),
                 axis.title.x = element_text(margin = unit(c(8, 0, 0, 0), "mm")),
                 axis.title.y = element_text(margin = unit(c(0, 5, 0, 0), "mm")),
                 axis.text.x = element_text(colour="black"),
                 axis.text.y = element_text(colour="black"),
                 plot.title = element_text(face="bold", hjust=0, colour="black"),
                 plot.subtitle = element_text(face="bold", hjust=0, color="black", margin = unit(c(2, 0, 0, 0), "mm")),
                 text = element_text(size=20),
                 legend.position="none")
m4

## Statistically check difference in total beta diversity of ponds
method.total.anosim <- anosim(method.dist$beta.jac, comb.metadata$Method)

## Inspect results
method.total.anosim
summary(method.total.anosim)
plot(method.total.anosim)

## There appears to be a significant difference in total beta diversity
## Look at PermANOVA using adonis(), considered more robust than anosim()
method.total.adonis <- adonis(method.dist$beta.jac ~ Method, comb.metadata)

## Inspect results
## no summary() or plot() methods included
method.total.adonis

## Again result is significant. There is substantial variation in overall 
## species composition of samples with different monitoring tools. Are methods
## more or less complementary at family level?


#'
#' ### Family level analysis
#' 

## Remove empty taxonomic assignments
method.fam.df <- method.fam.df[!sapply(method.fam.df, function(x) all(x == 0))]

#'
#' ## Data transformation
#' 
#' From now on, all data exploration and analyses will take place in the 
#' vegan package.
#' 

## Tranform data
method.fam.pa <- decostand(method.fam.df, method = "pa", MARGIN = 1) # by rows (ponds)
head(method.fam.pa[,1:3], n = 3)


#'
#' ## Alpha diversity
#' 

## Basic richness - two ways to calculate:
method.fam.richness <- specnumber(method.fam.pa)
method.fam.richness

## Plot alpha diversity
## Create data frame
method.fam.alpha <- data.frame(method.fam.richness)

## Add metadata
method.fam.alpha <- cbind(comb.fam.metadata[,1:3], method.fam.alpha)
str(method.fam.alpha)
method.fam.alpha$Sample <- as.factor(method.fam.alpha$Sample)
method.fam.alpha$Method <- as.factor(method.fam.alpha$Method)

## Reset row names of data frame for further indexing
rownames(method.fam.alpha) <- NULL

## Statistically compare whether method influences alpha diversity
method.fam.regression <- glm.nb(method.fam.richness ~ Method, data=method.fam.alpha)
summary(method.fam.regression)
anova(method.fam.regression, test = "Chi")
drop1(method.fam.regression, test = "Chi")

## Test difference between groups
summary(glht(glm.nb(method.fam.richness ~ Method, data=method.fam.alpha), 
             linfct=mcp(Method="Tukey")))

## Significant difference between means of:
## Netting-eDNA
## eDNA-DNA

## Check model meets GLM assumptions
## Test for overdispersion
54.457/51
1-pchisq(54.457, df=51)  # not overdispersed

## Plot the fitted data against the observed data
plot(method.fam.alpha$method.fam.richness ~ fitted(method.fam.regression))

## Hosmer and Lemeshow Goodness of Fit Test
hoslem.test(method.fam.alpha$method.fam.richness, fitted(method.fam.regression))

## Model supposedly fits well as p-value is not significant 
## i.e. no significant difference between the model and the observed data

## Perform model validation checks to ensure model is good fit to data and 
## making reliable predictions
## Assumption 1: residuals are normally distributed
sresid <- resid(method.fam.regression, type = "pearson")
hist(sresid)
lines(density(sresid,adjust=1))
qqnorm(sresid, cex=1.8, pch=20)
qqline(sresid, lty=2, lwd=2)
chkres(method.fam.regression)
shapiro.test(sresid) # P = 0.5825

## No deviation from normality as residuals are normally distributed
## therefore model is reliable.

## Assumption 2: no heteroscedascity
## Plot standardised residuals against each independent variable to 
## identify any source of heterogeneity i.e. independent variable that is 
## non-linearly associated with y
plot(sresid ~ method.fam.regression$fitted.values, pch=20, cex=2, cex.lab=1.5)
plot(sresid ~ method.fam.alpha$Crucian, pch=20, cex=2, cex.lab=1.5) # No heteroscedascity

## Assumption 3: no collinearity
## Only one variable being modelled so no collinearity present.

## Assumption 4: no serial auto-correlation
## can arise if there are unaccounted for relationships in data set or
## if there is confounding effect of time or space
durbinWatsonTest(method.fam.regression)

## No significant serial auto-correlation as p-value not significant
## Use graphical approach with Auto-Correlation Function (ACF)
acf(sresid, main = "Auto-correlation plot")
## Some autocorrelation at first time lag

## Assumption 5: model not biased by unduly influential observations
influence <- influence.measures(method.fam.regression)
summary(influence)
CD <- cooks.distance(method.fam.regression)
plot(CD ~ sresid)


## Plot species richness
m5 <- ggplot(method.fam.alpha, aes(x=Method, y=method.fam.richness))
m5 <- m5 + ggtitle("(b) Family-level")
m5 <- m5 + geom_jitter(aes(colour=Method), cex=2, pch=16, width=0.2, show.legend=FALSE)
m5 <- m5 + geom_boxplot(alpha=0.7, outlier.shape=NA)
m5 <- m5 + scale_y_continuous(limits=c(0,80))
m5 <- m5 + annotate("text", x = c("DNA","eDNA","Netting"), y = 70, 
                    label = c("a","b","c"), cex=10)
m5 <- m5 + labs(x="Method", y="")
m5 <- m5 + scale_colour_manual(values=c("purple","orange","limegreen"))
m5 <- m5 + theme(panel.background = element_rect(fill = 'white'),
                 axis.line.x = element_line(colour = 'black', size=0.5, linetype='solid'),
                 axis.line.y = element_line(colour = 'black', size=0.5, linetype='solid'),
                 axis.title.x = element_text(margin = unit(c(8, 0, 0, 0), "mm")),
                 axis.title.y = element_text(margin = unit(c(0, 5, 0, 0), "mm")),
                 axis.text.x = element_text(colour="black"),
                 axis.text.y = element_text(colour="black"),
                 plot.title = element_text(face="bold", hjust=0),
                 legend.position = "none",
                 text = element_text(size=20))
m5

## Family richness appears to be highest with eDNA metabarcoding, followed by
## DNA metabarcoding then netting.



#'
#' ## Beta diversity
#' 

## Now look at beta diversity in ponds with different methods.
## The beta.pair() function computes three dissimilarity metrics and uses 
## the argument index.family to calculate beta diversity according to 
## Sorensen or Jaccard index of total dissimilarity. The function returns 
## three matrices containing the pairwise between-site values of each 
## component of beta diversity (turnover, nestedness, total beta). The 
## dissimilarity matrices yielded by beta.pair are objects of class dist 
## and can be used for further analyses, e.g. NMDS, cluster analysis.
## (NB: Jaccard index is used to calculate beta diversity from 
## presence-absence data. Abundance data would use Bray-curtis 
## dissimilarity)
method.fam.dist <- beta.pair(method.fam.pa, index.family="jaccard")

## 1. TURNOVER PARTITION (COMPLETE CHANGE IN COMMUNITIES)
method.fam.bd.turn <- betadisper(method.fam.dist$beta.jtu, comb.fam.metadata$Method)

## Check homogeneity of multivariate dispersions. Groups being tested should 
## have the sample multivariate spread to conform to assumptions of PERMANOVA
mod.turn <- with(comb.fam.metadata, method.fam.bd.turn)
mod.turn

## Compute mean distance to centroid per group
tapply(method.fam.bd.turn$distances, comb.metadata$Method, mean)

## Compute variance per group
tapply(method.fam.bd.turn$distances, comb.metadata$Method, var)

## Ordination plot of turnover partition
plot(method.fam.bd.turn)

## Boxplot of turnover partition
boxplot(method.fam.bd.turn, xlab="Method", xaxt="n", bty="n")
axis(side=1, at=c(1,2,3), labels=c("Bulk tissue","eDNA","Netting"))

## Plots indicate that there is some difference in turnover partition
## of beta diversity between methods. 
## Statistically check whether turnover is different between methods 
## using standard parametric anova or permutation tests.
anova(method.fam.bd.turn)     # No significant difference between methods
permutest(method.fam.bd.turn) # No significant difference between methods

## Analyse pairwise differences between groups (methods) using 
## parametric Tukey's HSD test.
TukeyHSD(method.fam.bd.turn)  # No significant difference between groups

## Ordination of beta diversity partitioned by turnover:
## The metaMDS function automatically transforms data and checks solution
## robustness
method.fam.comm.turn <- metaMDS(method.fam.dist$beta.jtu, dist = "jaccard")

## Assess goodness of ordination fit (stress plot)
stressplot(method.fam.comm.turn)

## plot site scores as text
ordiplot(method.fam.comm.turn, display = "sites", type = "text")

## Build data frame with NMDS coordinates and metadata
method.NMDS1 <- method.fam.comm.turn$points[,1]
method.NMDS2 <- method.fam.comm.turn$points[,2]
method.fam.turn.NMDS <- data.frame(NMDS1=method.NMDS1, 
                                   NMDS2=method.NMDS2,
                                   Method = comb.fam.metadata$Method)

## Check data
head(method.fam.turn.NMDS)

## Plot data frame
m6 <- ggplot(method.fam.turn.NMDS, aes(x=NMDS1, y=NMDS2, colour=Method))
m6 <- m6 + geom_point() + stat_ellipse()
m6 <- m6 + coord_cartesian(xlim=c(-0.6,0.6), ylim=c(-0.6,0.6))
m6 <- m6 + labs(subtitle="(ii) Family-level", x="NMDS1",y="NMDS2")
m6 <- m6 + scale_colour_manual(name="Method",
                               values=c("purple","orange","limegreen"))
m6 <- m6 + theme(panel.background = element_rect(fill = 'white'),
                 axis.line.x = element_line(colour = 'black', size=0.5, linetype='solid'),
                 axis.line.y = element_line(colour = 'black', size=0.5, linetype='solid'),
                 axis.title.x = element_text(margin = unit(c(8, 0, 0, 0), "mm")),
                 axis.title.y = element_text(margin = unit(c(0, 5, 0, 0), "mm")),
                 axis.text.x = element_text(colour="black"),
                 axis.text.y = element_text(colour="black"),
                 plot.title = element_text(face="bold", hjust=0, colour="black"),
                 plot.subtitle = element_text(face="bold", hjust=0, color="black", margin = unit(c(2, 0, 0, 0), "mm")),
                 text = element_text(size=20),
                 legend.position = "none",
                 legend.key=element_blank(),
                 legend.key.size = unit(2, 'lines'))
m6

## Statistically check difference in spatial turnover of communities
method.fam.turn.anosim <- anosim(method.fam.dist$beta.jtu, comb.fam.metadata$Method)

## Inspect results
method.fam.turn.anosim
summary(method.fam.turn.anosim)
plot(method.fam.turn.anosim)

## There appears to be a significant difference in spatial turnover
## Look at PermANOVA using adonis(), considered more robust than anosim()
method.fam.turn.adonis <- adonis(method.fam.dist$beta.jtu ~ Method, comb.fam.metadata)

## Inspect results
## no summary() or plot() methods included
method.fam.turn.adonis

## Again result is significant. There is a substantial difference in 
## species replacement (i.e. turnover) between monitoring tools.
## Therefore, species produced by one method are substituted by species 
## with another method.


## 2. NESTEDNESS PARTITION (SUBSET OF CHANGE IN WIDER COMMUNITY)
method.fam.bd.nest <- betadisper(method.fam.dist$beta.jne, comb.fam.metadata$Method)

## Check homogeneity of multivariate dispersions. Groups being tested should 
## have the sample multivariate spread to conform to assumptions of PERMANOVA
method.nest <- with(comb.fam.metadata, method.fam.bd.nest)
method.nest

## Compute mean distance to centroid per group
tapply(method.fam.bd.nest$distances, comb.metadata$Method, mean)

## Compute variance per group
tapply(method.fam.bd.nest$distances, comb.metadata$Method, var)

## Ordination plot of turnover partition
plot(method.fam.bd.nest)

## Boxplot of turnover partition
boxplot(method.fam.bd.nest, xlab="Method", xaxt="n", bty="n")
axis(side=1, at=c(1,2,3), labels=c("Bulk tissue","eDNA","Netting"))

## Plots indicates that there is no difference in nestedness partition
## of beta diversity between methods 
## Statistically check whether nestedness is different between methods
## using standard parametric anova or permutation tests.
anova(method.fam.bd.nest)     # No significant difference between methods
permutest(method.fam.bd.nest) # No significant difference between methods

## Analyse pairwise differences between groups using parametric Tukey's HSD 
## test.
TukeyHSD(method.fam.bd.nest)  # No significant difference between methods

## Ordination of beta diversity partitioned by nestedness:
method.fam.comm.nest <- metaMDS(method.dist$beta.jne, dist = "jaccard")

## Assess goodness of ordination fit (stress plot)
stressplot(method.fam.comm.nest)

## plot site scores as text
ordiplot(method.fam.comm.nest, display = "sites", type = "text")

## Build data frame with NMDS coordinates and metadata
method.NMDS1 <- method.fam.comm.nest$points[,1]
method.NMDS2 <- method.fam.comm.nest$points[,2]
method.fam.nest.NMDS <- data.frame(NMDS1=method.NMDS1, 
                                   NMDS2=method.NMDS2,
                                   Method = comb.fam.metadata$Method)

## Check data
head(method.fam.nest.NMDS)

## Plot data frame
m7 <- ggplot(method.fam.nest.NMDS, aes(x=NMDS1, y=NMDS2, colour=Method))
m7 <- m7 + geom_point() + stat_ellipse()
m7 <- m7 + coord_cartesian(xlim=c(-0.6,0.6), ylim=c(-0.6,0.6))
m7 <- m7 + labs(subtitle="", x="NMDS1", y="")
m7 <- m7 + scale_colour_manual(name="Method",
                               values=c("purple","orange","limegreen"))
m7 <- m7 + theme(panel.background = element_rect(fill = 'white'),
                 axis.line.x = element_line(colour = 'black', size=0.5, linetype='solid'),
                 axis.line.y = element_line(colour = 'black', size=0.5, linetype='solid'),
                 axis.title.x = element_text(margin = unit(c(8, 0, 0, 0), "mm")),
                 axis.title.y = element_text(margin = unit(c(0, 5, 0, 0), "mm")),
                 axis.text.x = element_text(colour="black"),
                 axis.text.y = element_text(colour="black"),
                 plot.title = element_text(face="bold", hjust=0, colour="black"),
                 plot.subtitle = element_text(face="bold", hjust=0, color="black", margin = unit(c(2, 0, 0, 0), "mm")),
                 text = element_text(size=20),
                 legend.position="none")
m7

## Statistically check difference in nestedness of communities
method.fam.nest.anosim <- anosim(method.fam.dist$beta.jne, comb.fam.metadata$Method)

## Inspect results
method.fam.nest.anosim
summary(method.fam.nest.anosim)
plot(method.fam.nest.anosim)

## There appears to be no significant difference in nestedness
## Look at PermANOVA using adonis(), considered more robust than anosim()
method.fam.nest.adonis <- adonis(method.fam.dist$beta.jne ~ Method, comb.fam.metadata)

## Inspect results
## no summary() or plot() methods included
method.fam.nest.adonis

## Result is not significant. There is no substantial difference in species 
## loss or gain (i.e. nestedness) between methods.


## 3. TOTAL BETA DIVERSITY
method.fam.bd.total <- betadisper(method.fam.dist$beta.jac, comb.fam.metadata$Method)

## Check homogeneity of multivariate dispersions. Groups being tested should 
## have the sample multivariate spread to conform to assumptions of PERMANOVA
mod.total <- with(comb.fam.metadata, method.fam.bd.total)
mod.total

## Compute mean distance to centroid per group
tapply(method.fam.bd.total$distances, comb.metadata$Method, mean)

## Compute variance per group
tapply(method.fam.bd.total$distances, comb.metadata$Method, var)

## Ordination plot of total beta diversity
plot(method.fam.bd.total)

## Boxplot of total beta diversity
boxplot(method.fam.bd.total, xlab="Method", xaxt="n", bty="n")
axis(side=1, at=c(1,2,3), labels=c("Bulk tissue","eDNA","Netting"))

## Plots indicates that there is no difference in total beta diversity 
## between methods.
## Statistically check whether total beta is different between methods
## using standard parametric anova or permutation tests.
anova(method.fam.bd.total)     # No significant difference between methods
permutest(method.fam.bd.total) # No significant difference between methods

## Analyse pairwise differences between groups using parametric Tukey's 
## HSD test.
TukeyHSD(method.fam.bd.total)  # Significant difference between methods

## Ordination of total beta diversity:
## The metaMDS function automatically transforms data and checks solution
## robustness
method.fam.comm.total <- metaMDS(method.fam.dist$beta.jac, dist = "jaccard")

## Assess goodness of ordination fit (stress plot)
stressplot(method.fam.comm.total)

## plot site scores as text
ordiplot(method.fam.comm.total, display = "sites", type = "text")

## Build data frame with NMDS coordinates and metadata
method.NMDS1 <- method.fam.comm.total$points[,1]
method.NMDS2 <- method.fam.comm.total$points[,2]
method.fam.total.NMDS <- data.frame(NMDS1=method.NMDS1,
                                    NMDS2=method.NMDS2,
                                    Method=comb.fam.metadata$Method)

## Check data
head(method.fam.total.NMDS)

## Plot data frame
m8 <- ggplot(method.fam.total.NMDS, aes(x=NMDS1, y=NMDS2, colour=Method))
m8 <- m8 + geom_point() + stat_ellipse()
m8 <- m8 + coord_cartesian(xlim=c(-0.6,0.6), ylim=c(-0.6,0.6))
m8 <- m8 + labs(subtitle="", x="NMDS1", y="")
m8 <- m8 + scale_colour_manual(name="Method",
                               values=c("purple","orange","limegreen"))
m8 <- m8 + theme(panel.background = element_rect(fill = 'white'),
                 axis.line.x = element_line(colour = 'black', size=0.5, linetype='solid'),
                 axis.line.y = element_line(colour = 'black', size=0.5, linetype='solid'),
                 axis.title.x = element_text(margin = unit(c(8, 0, 0, 0), "mm")),
                 axis.title.y = element_text(margin = unit(c(0, 5, 0, 0), "mm")),
                 axis.text.x = element_text(colour="black"),
                 axis.text.y = element_text(colour="black"),
                 plot.title = element_text(face="bold", hjust=0, colour="black"),
                 plot.subtitle = element_text(face="bold", hjust=0, color="black", margin = unit(c(2, 0, 0, 0), "mm")),
                 text = element_text(size=20),
                 legend.position="none")
m8

## Statistically check difference in total beta diversity of ponds
method.fam.total.anosim <- anosim(method.fam.dist$beta.jac, comb.fam.metadata$Method)

## Inspect results
method.fam.total.anosim
summary(method.fam.total.anosim)
plot(method.fam.total.anosim)

## There appears to be a significant difference in total beta diversity
## Look at PermANOVA using adonis(), considered more robust than anosim()
method.fam.total.adonis <- adonis(method.fam.dist$beta.jac ~ Method, comb.fam.metadata)

## Inspect results
## no summary() or plot() methods included
method.fam.total.adonis

## Again result is significant. There is substantial variation in overall 
## family composition of samples with different monitoring tools. Netting
## and DNA metabarcoding are more similar than eDNA metabarcoding with 
## either method.



#' ---
#' 
#' 5) Summarise all plots
#' 
#' Pull all plots together to be presented as they would in publication.
#' 

library(ggpubr)

## Difference in alpha diversity of ponds in relation to crucian carp
## by methods individually and combined
ggarrange(ggarrange(p1a,p1d, ncol=2),
          ggarrange(p1b,p1e, ncol=2),
          ggarrange(p1c,p1f, ncol=2),
          ggarrange(p1g,p1h, ncol=2),
          nrow=4)

## Difference in beta diversity of ponds in relation to crucian carp
## by methods individually and combined at species-level
source("ggplotLegendFunction.R")
mylegend <- g_legend(p2a)
p2a_l <- grid.arrange(arrangeGrob(p2a + theme(legend.position="none"),p2b,p2c,
                                  p2d,p2e,p2f,
                                  p2g,p2h,p2i,
                                  p2j,p2k,p2l,
                                  nrow=4, ncol=3),
                      mylegend, nrow=2,heights=c(10, 1))

## Difference in beta diversity of ponds in relation to crucian carp
## by methods individually and combined at family-level
p4a_l <- grid.arrange(arrangeGrob(p4a + theme(legend.position="none"),p4b,p4c,
                                  p4d,p4e,p4f,
                                  p4g,p4h,p4i,
                                  p4j,p4k,p4l,
                                  nrow=4, ncol=3),
                      mylegend, nrow=2,heights=c(10, 1))

## Difference in jaccard dissimilarity of ponds in relation to crucian carp
## by methods individually and combined
ggarrange(ggarrange(p3a,p3b,p3c, ncol=3),
          ggarrange(p3d,p3e,p3f, ncol=3),
          ggarrange(p3g,p3i, ncol=2),
          nrow=3)

## Difference in alpha diversity of ponds between methods
ggarrange(m1,m5, ncol=2, nrow=1)

## Difference in beta diversity of ponds between methods
mylegend <- g_legend(m2)
mBeta <- grid.arrange(arrangeGrob(m2 + theme(legend.position="none"),m3,m4,m6,m7,m8, 
                                  nrow=2, ncol=3),
                      mylegend, heights=c(10, 1))

## Produce venn diagrams of overlap in taxonomic assignments each method
## Load packages required to construct venn diagrams
source("http://www.bioconductor.org/biocLite.R")
class(biocLite)
biocLite("limma")
library("limma")

## Species-level
## Create dataframe for each method containing species name and total number
## of ponds it was found in
net.total <- data.frame(colnames(net.spec.pa), colSums(net.spec.pa))
colnames(net.total) <- c("Species", "Netting")

DNA.total <- data.frame(colnames(DNA.spec.pa), colSums(DNA.spec.pa))
colnames(DNA.total) <- c("Species", "DNA metabarcoding")

eDNA.total <- data.frame(colnames(eDNA.spp.pa), colSums(eDNA.spp.pa))
colnames(eDNA.total) <- c("Species", "eDNA metabarcoding")

## Make list of dataframes and bind them together
## Empty rows will be filled with NA values using rbind.fill() function
l <- list(net.total, DNA.total, eDNA.total)
spp.df <- do.call(rbind.fill, l)

## Replace NA values with 0 and merge rows by species
spp.df[is.na(spp.df)] <- 0
spp.df <- ddply(spp.df, .(Species), numcolwise(sum))

## Write as .csv file and add column containing taxonomic order for species
## assignments
write.csv(spp.df, "../Data/venn_species.csv", row.names=FALSE)

## Reimport file
spp.df <- read.csv("../Data/venn_species_edited.csv", header=TRUE)

## Venn diagram of total species detections across methods
## Take species detections by method and make new presence-absence dataframe
venn.df <- spp.df[,3:5]
venn.df[venn.df > 0] <- 1

## Make venn diagram
spp <- vennCounts(venn.df)
svg(filename="total_species_method.svg", width = 13, height = 10)
vennDiagram(spp, names = c("Netting", "DNA metabarcoding", "eDNA metabarcoding"), 
            cex = 2, lwd = 2, counts.col = "black",
            circle.col = c("limegreen","purple","orange"))
dev.off()


## Venn diagram of species detections by taxonomic group across methods
## Take species detections by method and make new presence-absence dataframe
groups.df <- spp.df[,-1]
groups.df[groups.df > 0] <- 1

Annelida <- subset(groups.df, Group == "Annelida")
Annelida <- Annelida[,-1]
spp <- vennCounts(Annelida)
svg(filename="Annelida_method.svg", width = 13, height = 10)
vennDiagram(spp, names = c("Netting", "DNA metabarcoding", "eDNA metabarcoding"), 
            cex = 2, lwd = 2, counts.col = "black",
            circle.col = c("limegreen","purple","orange"))
dev.off()

Arachnida <- subset(groups.df, Group == "Arachnida")
Arachnida <- Arachnida[,-1]
spp <- vennCounts(Arachnida)
svg(filename="arachnida_method.svg", width = 13, height = 10)
vennDiagram(spp, names = c("Netting", "DNA metabarcoding", "eDNA metabarcoding"), 
            cex = 2, lwd = 2, counts.col = "black",
            circle.col = c("limegreen","purple","orange"))
dev.off()

Bryozoa <- subset(groups.df, Group == "Bryozoa")
Bryozoa <- Bryozoa[,-1]
spp <- vennCounts(Bryozoa)
svg(filename="bryozoa_method.svg", width = 13, height = 10)
vennDiagram(spp, names = c("Netting", "DNA metabarcoding", "eDNA metabarcoding"), 
            cex = 2, lwd = 2, counts.col = "black",
            circle.col = c("limegreen","purple","orange"))
dev.off()

Cnidaria <- subset(groups.df, Group == "Cnidaria")
Cnidaria <- Cnidaria[,-1]
spp <- vennCounts(Cnidaria)
svg(filename="Cnidaria_method.svg", width = 13, height = 10)
vennDiagram(spp, names = c("Netting", "DNA metabarcoding", "eDNA metabarcoding"), 
            cex = 2, lwd = 2, counts.col = "black",
            circle.col = c("limegreen","purple","orange"))
dev.off()
  
Coleoptera <- subset(groups.df, Group == "Coleoptera")
Coleoptera <- Coleoptera[,-1]
spp <- vennCounts(Coleoptera)
svg(filename="coleoptera_method.svg", width = 13, height = 10)
vennDiagram(spp, names = c("Netting", "DNA metabarcoding", "eDNA metabarcoding"), 
            cex = 2, lwd = 2, counts.col = "black",
            circle.col = c("limegreen","purple","orange"))
dev.off()

Collembola <- subset(groups.df, Group == "Collembola")
Collembola <- Collembola[,-1]
spp <- vennCounts(Collembola)
svg(filename="collembola_method.svg", width = 13, height = 10)
vennDiagram(spp, names = c("Netting", "DNA metabarcoding", "eDNA metabarcoding"), 
            cex = 2, lwd = 2, counts.col = "black",
            circle.col = c("limegreen","purple","orange"))
dev.off()

Crustacea <- subset(groups.df, Group == "Crustacea")
Crustacea <- Crustacea[,-1]
spp <- vennCounts(Crustacea)
svg(filename="crustacea_method.svg", width = 13, height = 10)
vennDiagram(spp, names = c("Netting", "DNA metabarcoding", "eDNA metabarcoding"), 
            cex = 2, lwd = 2, counts.col = "black",
            circle.col = c("limegreen","purple","orange"))
dev.off()

Diptera <- subset(groups.df, Group == "Diptera")
Diptera <- Diptera[,-1]
spp <- vennCounts(Diptera)
svg(filename="diptera_method.svg", width = 13, height = 10)
vennDiagram(spp, names = c("Netting", "DNA metabarcoding", "eDNA metabarcoding"), 
            cex = 2, lwd = 2, counts.col = "black",
            circle.col = c("limegreen","purple","orange"))
dev.off()

Ephemeroptera <- subset(groups.df, Group == "Ephemeroptera")
Ephemeroptera <- Ephemeroptera[,-1]
spp <- vennCounts(Ephemeroptera)
svg(filename="ephemeroptera_method.svg", width = 13, height = 10)
vennDiagram(spp, names = c("Netting", "DNA metabarcoding", "eDNA metabarcoding"), 
            cex = 2, lwd = 2, counts.col = "black",
            circle.col = c("limegreen","purple","orange"))
dev.off()

Gastrotricha <- subset(groups.df, Group == "Gastrotricha")
Gastrotricha <- Gastrotricha[,-1]
spp <- vennCounts(Gastrotricha)
svg(filename="gastrotricha_method.svg", width = 13, height = 10)
vennDiagram(spp, names = c("Netting", "DNA metabarcoding", "eDNA metabarcoding"), 
            cex = 2, lwd = 2, counts.col = "black",
            circle.col = c("limegreen","purple","orange"))
dev.off()

Hemiptera <- subset(groups.df, Group == "Hemiptera")
Hemiptera <- Hemiptera[,-1]
spp <- vennCounts(Hemiptera)
svg(filename="hemiptera_method.svg", width = 13, height = 10)
vennDiagram(spp, names = c("Netting", "DNA metabarcoding", "eDNA metabarcoding"), 
            cex = 2, lwd = 2, counts.col = "black",
            circle.col = c("limegreen","purple","orange"))
dev.off()

Hirudinea <- subset(groups.df, Group == "Hirudinea")
Hirudinea <- Hirudinea[,-1]
spp <- vennCounts(Hirudinea)
svg(filename="hirudinea_method.svg", width = 13, height = 10)
vennDiagram(spp, names = c("Netting", "DNA metabarcoding", "eDNA metabarcoding"), 
            cex = 2, lwd = 2, counts.col = "black",
            circle.col = c("limegreen","purple","orange"))
dev.off()

Hymenoptera <- subset(groups.df, Group == "Hymenoptera")
Hymenoptera <- Hymenoptera[,-1]
spp <- vennCounts(Hymenoptera)
svg(filename="Hymenoptera_method.svg", width = 13, height = 10)
vennDiagram(spp, names = c("Netting", "DNA metabarcoding", "eDNA metabarcoding"), 
            cex = 2, lwd = 2, counts.col = "black",
            circle.col = c("limegreen","purple","orange"))
dev.off()

Lepidoptera <- subset(groups.df, Group == "Lepidoptera")
Lepidoptera <- Lepidoptera[,-1]
spp <- vennCounts(Lepidoptera)
svg(filename="Lepidoptera_method.svg", width = 13, height = 10)
vennDiagram(spp, names = c("Netting", "DNA metabarcoding", "eDNA metabarcoding"), 
            cex = 2, lwd = 2, counts.col = "black",
            circle.col = c("limegreen","purple","orange"))
dev.off()
  
Megaloptera <- subset(groups.df, Group == "Megaloptera")
Megaloptera <- Megaloptera[,-1]
spp <- vennCounts(Megaloptera)
svg(filename="Megaloptera_method.svg", width = 13, height = 10)
vennDiagram(spp, names = c("Netting", "DNA metabarcoding", "eDNA metabarcoding"), 
            cex = 2, lwd = 2, counts.col = "black",
            circle.col = c("limegreen","purple","orange"))
dev.off()
  
Mollusca <- subset(groups.df, Group == "Mollusca")
Mollusca <- Mollusca[,-1]
spp <- vennCounts(Mollusca)
svg(filename="Mollusca_method.svg", width = 13, height = 10)
vennDiagram(spp, names = c("Netting", "DNA metabarcoding", "eDNA metabarcoding"), 
            cex = 2, lwd = 2, counts.col = "black",
            circle.col = c("limegreen","purple","orange"))
dev.off()

Nematoda <- subset(groups.df, Group == "Nematoda")
Nematoda <- Nematoda[,-1]
spp <- vennCounts(Nematoda)
svg(filename="Nematoda_method.svg", width = 13, height = 10)
vennDiagram(spp, names = c("Netting", "DNA metabarcoding", "eDNA metabarcoding"), 
            cex = 2, lwd = 2, counts.col = "black",
            circle.col = c("limegreen","purple","orange"))
dev.off()

Odonata <- subset(groups.df, Group == "Odonata")
Odonata <- Odonata[,-1]
spp <- vennCounts(Odonata)
svg(filename="Odonata_method.svg", width = 13, height = 10)
vennDiagram(spp, names = c("Netting", "DNA metabarcoding", "eDNA metabarcoding"), 
            cex = 2, lwd = 2, counts.col = "black",
            circle.col = c("limegreen","purple","orange"))
dev.off()

Platyhelminthes <- subset(groups.df, Group == "Platyhelminthes")
Platyhelminthes <- Platyhelminthes[,-1]
spp <- vennCounts(Platyhelminthes)
svg(filename="Platyhelminthes_method.svg", width = 13, height = 10)
vennDiagram(spp, names = c("Netting", "DNA metabarcoding", "eDNA metabarcoding"), 
            cex = 2, lwd = 2, counts.col = "black",
            circle.col = c("limegreen","purple","orange"))
dev.off()

Psocoptera <- subset(groups.df, Group == "Psocoptera")
Psocoptera <- Psocoptera[,-1]
spp <- vennCounts(Psocoptera)
svg(filename="Psocoptera_method.svg", width = 13, height = 10)
vennDiagram(spp, names = c("Netting", "DNA metabarcoding", "eDNA metabarcoding"), 
            cex = 2, lwd = 2, counts.col = "black",
            circle.col = c("limegreen","purple","orange"))
dev.off()

Rotifera <- subset(groups.df, Group == "Rotifera")
Rotifera <- Rotifera[,-1]
spp <- vennCounts(Rotifera)
svg(filename="Rotifera_method.svg", width = 13, height = 10)
vennDiagram(spp, names = c("Netting", "DNA metabarcoding", "eDNA metabarcoding"), 
            cex = 2, lwd = 2, counts.col = "black",
            circle.col = c("limegreen","purple","orange"))
dev.off()

Tardigrada <- subset(groups.df, Group == "Tardigrada")
Tardigrada <- Tardigrada[,-1]
spp <- vennCounts(Tardigrada)
svg(filename="Tardigrada_method.svg", width = 13, height = 10)
vennDiagram(spp, names = c("Netting", "DNA metabarcoding", "eDNA metabarcoding"), 
            cex = 2, lwd = 2, counts.col = "black",
            circle.col = c("limegreen","purple","orange"))
dev.off()

Thysanoptera <- subset(groups.df, Group == "Thysanoptera")
Thysanoptera <- Thysanoptera[,-1]
spp <- vennCounts(Thysanoptera)
svg(filename="Thysanoptera_method.svg", width = 13, height = 10)
vennDiagram(spp, names = c("Netting", "DNA metabarcoding", "eDNA metabarcoding"), 
            cex = 2, lwd = 2, counts.col = "black",
            circle.col = c("limegreen","purple","orange"))
dev.off()

Trichoptera <- subset(groups.df, Group == "Trichoptera")
Trichoptera <- Trichoptera[,-1]
spp <- vennCounts(Trichoptera)
svg(filename="Trichoptera_method.svg", width = 13, height = 10)
vennDiagram(spp, names = c("Netting", "DNA metabarcoding", "eDNA metabarcoding"), 
            cex = 2, lwd = 2, counts.col = "black",
            circle.col = c("limegreen","purple","orange"))
dev.off()


## An alternative approach to visualise method performance:
plot.df <- spp.df[,-1]
plot.df <- ddply(plot.df, .(Group), numcolwise(sum))
plot.df <- melt(plot.df, id.vars = "Group")
colnames(plot.df) <- c("Group","Method","Species")

g1 <- ggplot(plot.df, aes(x=Group, y=Species, fill=Method))
g1 <- g1 + geom_bar(stat="identity")
g1 <- g1 + theme_bw()
g1 <- g1 + theme(axis.text.x = element_text(angle=45, hjust=1))
g1 <- g1 + facet_grid(Method ~ .)
g1



## Family-level
## Create dataframe for each method containing family name and total number
## of ponds it was found in
net.fam.total <- data.frame(colnames(net.fam.pa), colSums(net.fam.pa))
colnames(net.fam.total) <- c("Family", "Netting")

DNA.fam.total <- data.frame(colnames(DNA.fam.pa), colSums(DNA.fam.pa))
colnames(DNA.fam.total) <- c("Family", "DNA metabarcoding")

eDNA.fam.total <- data.frame(colnames(eDNA.fam.pa), colSums(eDNA.fam.pa))
colnames(eDNA.fam.total) <- c("Family", "eDNA metabarcoding")

## Make list of dataframes and bind them together
## Empty rows will be filled with NA values using rbind.fill() function
l <- list(net.fam.total, DNA.fam.total, eDNA.fam.total)
fam.df <- do.call(rbind.fill, l)

## Replace NA values with 0 and merge rows by species
fam.df[is.na(fam.df)] <- 0
fam.df <- ddply(fam.df, .(Family), numcolwise(sum))

## Write as .csv file and add column containing taxonomic order for species
## assignments
write.csv(fam.df, "../Data/venn_family.csv", row.names=FALSE)

## Reimport file
fam.df <- read.csv("../Data/venn_family_edited.csv", header=TRUE)

## Venn diagram of total family detections across methods
## Take species detections by method and make new presence-absence dataframe
venn.fam.df <- fam.df[,3:5]
venn.fam.df[venn.fam.df > 0] <- 1

## Make venn diagram
fam <- vennCounts(venn.fam.df)
svg(filename="total_family_method.svg", width = 13, height = 10)
vennDiagram(fam, names = c("Netting", "DNA metabarcoding", "eDNA metabarcoding"), 
            cex = 2, lwd = 2, counts.col = "black",
            circle.col = c("limegreen","purple","orange"))
dev.off()


## Venn diagram of species detections by taxonomic group across methods
## Take species detections by method and make new presence-absence dataframe
groups.fam.df <- fam.df[,-1]
groups.fam.df[groups.fam.df > 0] <- 1

Annelida <- subset(groups.fam.df, Group == "Annelida")
Annelida <- Annelida[,-1]
spp <- vennCounts(Annelida)
svg(filename="Annelida_method.svg", width = 13, height = 10)
vennDiagram(spp, names = c("Netting", "DNA metabarcoding", "eDNA metabarcoding"), 
            cex = 2, lwd = 2, counts.col = "black",
            circle.col = c("limegreen","purple","orange"))
dev.off()

Arachnida <- subset(groups.fam.df, Group == "Arachnida")
Arachnida <- Arachnida[,-1]
spp <- vennCounts(Arachnida)
svg(filename="arachnida_method.svg", width = 13, height = 10)
vennDiagram(spp, names = c("Netting", "DNA metabarcoding", "eDNA metabarcoding"), 
            cex = 2, lwd = 2, counts.col = "black",
            circle.col = c("limegreen","purple","orange"))
dev.off()

Bryozoa <- subset(groups.fam.df, Group == "Bryozoa")
Bryozoa <- Bryozoa[,-1]
spp <- vennCounts(Bryozoa)
svg(filename="bryozoa_method.svg", width = 13, height = 10)
vennDiagram(spp, names = c("Netting", "DNA metabarcoding", "eDNA metabarcoding"), 
            cex = 2, lwd = 2, counts.col = "black",
            circle.col = c("limegreen","purple","orange"))
dev.off()

Cnidaria <- subset(groups.fam.df, Group == "Cnidaria")
Cnidaria <- Cnidaria[,-1]
spp <- vennCounts(Cnidaria)
svg(filename="Cnidaria_method.svg", width = 13, height = 10)
vennDiagram(spp, names = c("Netting", "DNA metabarcoding", "eDNA metabarcoding"), 
            cex = 2, lwd = 2, counts.col = "black",
            circle.col = c("limegreen","purple","orange"))
dev.off()

Coleoptera <- subset(groups.fam.df, Group == "Coleoptera")
Coleoptera <- Coleoptera[,-1]
spp <- vennCounts(Coleoptera)
svg(filename="coleoptera_method.svg", width = 13, height = 10)
vennDiagram(spp, names = c("Netting", "DNA metabarcoding", "eDNA metabarcoding"), 
            cex = 2, lwd = 2, counts.col = "black",
            circle.col = c("limegreen","purple","orange"))
dev.off()

Collembola <- subset(groups.fam.df, Group == "Collembola")
Collembola <- Collembola[,-1]
spp <- vennCounts(Collembola)
svg(filename="collembola_method.svg", width = 13, height = 10)
vennDiagram(spp, names = c("Netting", "DNA metabarcoding", "eDNA metabarcoding"), 
            cex = 2, lwd = 2, counts.col = "black",
            circle.col = c("limegreen","purple","orange"))
dev.off()

Crustacea <- subset(groups.fam.df, Group == "Crustacea")
Crustacea <- Crustacea[,-1]
spp <- vennCounts(Crustacea)
svg(filename="crustacea_method.svg", width = 13, height = 10)
vennDiagram(spp, names = c("Netting", "DNA metabarcoding", "eDNA metabarcoding"), 
            cex = 2, lwd = 2, counts.col = "black",
            circle.col = c("limegreen","purple","orange"))
dev.off()

Diptera <- subset(groups.fam.df, Group == "Diptera")
Diptera <- Diptera[,-1]
spp <- vennCounts(Diptera)
svg(filename="diptera_method.svg", width = 13, height = 10)
vennDiagram(spp, names = c("Netting", "DNA metabarcoding", "eDNA metabarcoding"), 
            cex = 2, lwd = 2, counts.col = "black",
            circle.col = c("limegreen","purple","orange"))
dev.off()

Ephemeroptera <- subset(groups.fam.df, Group == "Ephemeroptera")
Ephemeroptera <- Ephemeroptera[,-1]
spp <- vennCounts(Ephemeroptera)
svg(filename="ephemeroptera_method.svg", width = 13, height = 10)
vennDiagram(spp, names = c("Netting", "DNA metabarcoding", "eDNA metabarcoding"), 
            cex = 2, lwd = 2, counts.col = "black",
            circle.col = c("limegreen","purple","orange"))
dev.off()

Gastrotricha <- subset(groups.fam.df, Group == "Gastrotricha")
Gastrotricha <- Gastrotricha[,-1]
spp <- vennCounts(Gastrotricha)
svg(filename="gastrotricha_method.svg", width = 13, height = 10)
vennDiagram(spp, names = c("Netting", "DNA metabarcoding", "eDNA metabarcoding"), 
            cex = 2, lwd = 2, counts.col = "black",
            circle.col = c("limegreen","purple","orange"))
dev.off()

Hemiptera <- subset(groups.fam.df, Group == "Hemiptera")
Hemiptera <- Hemiptera[,-1]
spp <- vennCounts(Hemiptera)
svg(filename="hemiptera_method.svg", width = 13, height = 10)
vennDiagram(spp, names = c("Netting", "DNA metabarcoding", "eDNA metabarcoding"), 
            cex = 2, lwd = 2, counts.col = "black",
            circle.col = c("limegreen","purple","orange"))
dev.off()

Hirudinea <- subset(groups.fam.df, Group == "Hirudinea")
Hirudinea <- Hirudinea[,-1]
spp <- vennCounts(Hirudinea)
svg(filename="hirudinea_method.svg", width = 13, height = 10)
vennDiagram(spp, names = c("Netting", "DNA metabarcoding", "eDNA metabarcoding"), 
            cex = 2, lwd = 2, counts.col = "black",
            circle.col = c("limegreen","purple","orange"))
dev.off()

Hymenoptera <- subset(groups.fam.df, Group == "Hymenoptera")
Hymenoptera <- Hymenoptera[,-1]
spp <- vennCounts(Hymenoptera)
svg(filename="Hymenoptera_method.svg", width = 13, height = 10)
vennDiagram(spp, names = c("Netting", "DNA metabarcoding", "eDNA metabarcoding"), 
            cex = 2, lwd = 2, counts.col = "black",
            circle.col = c("limegreen","purple","orange"))
dev.off()

Lepidoptera <- subset(groups.fam.df, Group == "Lepidoptera")
Lepidoptera <- Lepidoptera[,-1]
spp <- vennCounts(Lepidoptera)
svg(filename="Lepidoptera_method.svg", width = 13, height = 10)
vennDiagram(spp, names = c("Netting", "DNA metabarcoding", "eDNA metabarcoding"), 
            cex = 2, lwd = 2, counts.col = "black",
            circle.col = c("limegreen","purple","orange"))
dev.off()

Megaloptera <- subset(groups.fam.df, Group == "Megaloptera")
Megaloptera <- Megaloptera[,-1]
spp <- vennCounts(Megaloptera)
svg(filename="Megaloptera_method.svg", width = 13, height = 10)
vennDiagram(spp, names = c("Netting", "DNA metabarcoding", "eDNA metabarcoding"), 
            cex = 2, lwd = 2, counts.col = "black",
            circle.col = c("limegreen","purple","orange"))
dev.off()

Mollusca <- subset(groups.fam.df, Group == "Mollusca")
Mollusca <- Mollusca[,-1]
spp <- vennCounts(Mollusca)
svg(filename="Mollusca_method.svg", width = 13, height = 10)
vennDiagram(spp, names = c("Netting", "DNA metabarcoding", "eDNA metabarcoding"), 
            cex = 2, lwd = 2, counts.col = "black",
            circle.col = c("limegreen","purple","orange"))
dev.off()

Nematoda <- subset(groups.fam.df, Group == "Nematoda")
Nematoda <- Nematoda[,-1]
spp <- vennCounts(Nematoda)
svg(filename="Nematoda_method.svg", width = 13, height = 10)
vennDiagram(spp, names = c("Netting", "DNA metabarcoding", "eDNA metabarcoding"), 
            cex = 2, lwd = 2, counts.col = "black",
            circle.col = c("limegreen","purple","orange"))
dev.off()

Odonata <- subset(groups.fam.df, Group == "Odonata")
Odonata <- Odonata[,-1]
spp <- vennCounts(Odonata)
svg(filename="Odonata_method.svg", width = 13, height = 10)
vennDiagram(spp, names = c("Netting", "DNA metabarcoding", "eDNA metabarcoding"), 
            cex = 2, lwd = 2, counts.col = "black",
            circle.col = c("limegreen","purple","orange"))
dev.off()

Platyhelminthes <- subset(groups.fam.df, Group == "Platyhelminthes")
Platyhelminthes <- Platyhelminthes[,-1]
spp <- vennCounts(Platyhelminthes)
svg(filename="Platyhelminthes_method.svg", width = 13, height = 10)
vennDiagram(spp, names = c("Netting", "DNA metabarcoding", "eDNA metabarcoding"), 
            cex = 2, lwd = 2, counts.col = "black",
            circle.col = c("limegreen","purple","orange"))
dev.off()

Psocoptera <- subset(groups.fam.df, Group == "Psocoptera")
Psocoptera <- Psocoptera[,-1]
spp <- vennCounts(Psocoptera)
svg(filename="Psocoptera_method.svg", width = 13, height = 10)
vennDiagram(spp, names = c("Netting", "DNA metabarcoding", "eDNA metabarcoding"), 
            cex = 2, lwd = 2, counts.col = "black",
            circle.col = c("limegreen","purple","orange"))
dev.off()

Rotifera <- subset(groups.fam.df, Group == "Rotifera")
Rotifera <- Rotifera[,-1]
spp <- vennCounts(Rotifera)
svg(filename="Rotifera_method.svg", width = 13, height = 10)
vennDiagram(spp, names = c("Netting", "DNA metabarcoding", "eDNA metabarcoding"), 
            cex = 2, lwd = 2, counts.col = "black",
            circle.col = c("limegreen","purple","orange"))
dev.off()

Tardigrada <- subset(groups.fam.df, Group == "Tardigrada")
Tardigrada <- Tardigrada[,-1]
spp <- vennCounts(Tardigrada)
svg(filename="Tardigrada_method.svg", width = 13, height = 10)
vennDiagram(spp, names = c("Netting", "DNA metabarcoding", "eDNA metabarcoding"), 
            cex = 2, lwd = 2, counts.col = "black",
            circle.col = c("limegreen","purple","orange"))
dev.off()

Thysanoptera <- subset(groups.fam.df, Group == "Thysanoptera")
Thysanoptera <- Thysanoptera[,-1]
spp <- vennCounts(Thysanoptera)
svg(filename="Thysanoptera_method.svg", width = 13, height = 10)
vennDiagram(spp, names = c("Netting", "DNA metabarcoding", "eDNA metabarcoding"), 
            cex = 2, lwd = 2, counts.col = "black",
            circle.col = c("limegreen","purple","orange"))
dev.off()

Trichoptera <- subset(groups.fam.df, Group == "Trichoptera")
Trichoptera <- Trichoptera[,-1]
spp <- vennCounts(Trichoptera)
svg(filename="Trichoptera_method.svg", width = 13, height = 10)
vennDiagram(spp, names = c("Netting", "DNA metabarcoding", "eDNA metabarcoding"), 
            cex = 2, lwd = 2, counts.col = "black",
            circle.col = c("limegreen","purple","orange"))
dev.off()


## An alternative approach to visualise method performance:
plot.fam.df <- fam.df[,-1]
plot.fam.df <- ddply(plot.fam.df, .(Group), numcolwise(sum))
plot.fam.df <- melt(plot.fam.df, id.vars = "Group")
colnames(plot.fam.df) <- c("Group","Method","Family")

g1 <- ggplot(plot.fam.df, aes(x=Group, y=Family, fill=Method))
g1 <- g1 + geom_bar(stat="identity")
g1 <- g1 + theme_bw()
g1 <- g1 + theme(axis.text.x = element_text(angle=45, hjust=1))
g1 <- g1 + facet_grid(Method ~ .)
g1

